---
phase: 08-library-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cmake/Dependencies.cmake
  - src/CMakeLists.txt
  - src/database_csv.cpp
autonomous: true
requirements:
  - LIB-01
  - LIB-02
  - LIB-03

must_haves:
  truths:
    - "csv_escape() and write_csv_row() no longer exist in src/database_csv.cpp"
    - "rapidcsv is fetched via CMake FetchContent and linked as PRIVATE dependency"
    - "No new DLLs appear in the build output (rapidcsv is header-only INTERFACE target)"
    - "All 22 C++ CSV export tests pass without any test modifications"
    - "All 19 C API CSV export tests pass without any test modifications"
  artifacts:
    - path: "cmake/Dependencies.cmake"
      provides: "rapidcsv FetchContent declaration"
      contains: "FetchContent_Declare(rapidcsv"
    - path: "src/CMakeLists.txt"
      provides: "rapidcsv link directive"
      contains: "rapidcsv"
    - path: "src/database_csv.cpp"
      provides: "CSV export using rapidcsv Document/Save API"
      contains: "rapidcsv::Document"
  key_links:
    - from: "src/database_csv.cpp"
      to: "rapidcsv"
      via: "#include <rapidcsv.h> and rapidcsv::Document API"
      pattern: "rapidcsv::Document"
    - from: "src/CMakeLists.txt"
      to: "cmake/Dependencies.cmake"
      via: "target_link_libraries PRIVATE rapidcsv"
      pattern: "rapidcsv"
---

<objective>
Replace hand-rolled CSV writing helpers (`csv_escape()` and `write_csv_row()`) in `src/database_csv.cpp` with rapidcsv's Document/Save API, integrated via CMake FetchContent as a PRIVATE header-only dependency.

Purpose: Establishes a proper CSV library foundation for future features (import, custom delimiters) while eliminating hand-rolled CSV escaping/quoting logic. All existing tests must pass unchanged.

Output: Modified `cmake/Dependencies.cmake`, `src/CMakeLists.txt`, and `src/database_csv.cpp`. No test file changes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-library-integration/08-RESEARCH.md
@.planning/phases/08-library-integration/08-CONTEXT.md
@include/quiver/csv.h
@src/database_csv.cpp
@cmake/Dependencies.cmake
@src/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rapidcsv via FetchContent and link to quiver target</name>
  <files>
    cmake/Dependencies.cmake
    src/CMakeLists.txt
  </files>
  <action>
1. In `cmake/Dependencies.cmake`, add a new FetchContent block after the sol2 block (before the GoogleTest block):

```cmake
# rapidcsv for CSV reading/writing (header-only)
FetchContent_Declare(rapidcsv
    GIT_REPOSITORY https://github.com/d99kris/rapidcsv.git
    GIT_TAG v8.92
)
FetchContent_MakeAvailable(rapidcsv)
```

2. In `src/CMakeLists.txt`, add `rapidcsv` to the PRIVATE section of `target_link_libraries(quiver ...)`, after `sol2`:

```cmake
target_link_libraries(quiver
    PUBLIC
        SQLite::SQLite3
    PRIVATE
        quiver_compiler_options
        tomlplusplus::tomlplusplus
        spdlog::spdlog
        lua_library
        sol2
        rapidcsv
        ${CMAKE_DL_LIBS}
)
```

3. Verify build succeeds: `cmake --build build --config Debug`

The rapidcsv target is INTERFACE (header-only), so no new DLLs will appear in `build/bin/`. This satisfies LIB-02.
  </action>
  <verify>
Run `cmake --build build --config Debug`. Build must succeed with no errors. Verify no new DLL files appear in `build/bin/` beyond what already exists (rapidcsv is header-only).
  </verify>
  <done>
rapidcsv v8.92 is declared in FetchContent, linked as PRIVATE dependency to quiver target, and the project builds successfully with no new DLLs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace hand-rolled CSV helpers with rapidcsv Document/Save API</name>
  <files>
    src/database_csv.cpp
  </files>
  <action>
Modify `src/database_csv.cpp` to replace `csv_escape()` and `write_csv_row()` with rapidcsv. Follow the architecture from 08-RESEARCH.md precisely.

**Step 1: Update includes.** Add `#include <rapidcsv.h>` at the top. Remove `<cstdio>` if no longer needed (check: `snprintf` is still used for float formatting, so keep `<cstdio>`).

**Step 2: Delete `csv_escape()`.** Remove the entire `csv_escape()` function (lines ~16-37 of current file). rapidcsv's auto-quote handles CSV field escaping.

**Step 3: Delete `write_csv_row()`.** Remove the entire `write_csv_row()` function (lines ~110-118 of current file). rapidcsv's `Save()` handles row assembly and line endings.

**Step 4: Update `value_to_csv_string()`.** Remove all `csv_escape()` calls from this function:
- Line with enum labels: `return csv_escape(val_it->second)` -> `return val_it->second`
- Line with datetime: `return csv_escape(format_datetime(...))` -> `return format_datetime(...)`
- Line with string: `return csv_escape(str_val)` -> `return str_val`

**Step 5: Rewrite `export_csv()` scalar path.** Replace the header-writing and data-writing logic with rapidcsv Document construction:

```cpp
// Replace file open at top of export_csv with: just keep parent dir creation
// Move file open to after document construction

// Create rapidcsv Document:
// LabelParams(0, -1) = column headers at row 0, no row headers
// SeparatorParams(',', false, false, true, true, '"'):
//   separator=','  trim=false  hasCR=false  quotedLinebreaks=true  autoQuote=true  quoteChar='"'
// hasCR=false is CRITICAL: prevents CRLF on Windows (Pitfall 1 from research)
rapidcsv::Document doc("", rapidcsv::LabelParams(0, -1),
    rapidcsv::SeparatorParams(',', false, false, true, true, '"'));

// Set column names
for (size_t i = 0; i < csv_columns.size(); ++i) {
    doc.SetColumnName(i, csv_columns[i]);
}

// Set cells row by row using value_to_csv_string (same data transformation as before)
size_t row_idx = 0;
for (const auto& row : data_result) {
    for (size_t i = 0; i < csv_columns.size(); ++i) {
        DataType dt = DataType::Text;
        if (auto it = type_map.find(csv_columns[i]); it != type_map.end()) {
            dt = it->second;
        }
        doc.SetCell<std::string>(i, row_idx,
            value_to_csv_string(row[i], csv_columns[i], dt, options));
    }
    ++row_idx;
}

// Save via stringstream, then write to file in binary mode
std::ostringstream oss;
doc.Save(oss);

std::ofstream file(path, std::ios::binary);
if (!file.is_open()) {
    throw std::runtime_error("Failed to export_csv: could not open file: " + path);
}
file << oss.str();
```

**Step 6: Rewrite `export_csv()` group path.** Apply the same pattern as scalar path. The group path has the same structure: build csv_columns, query data, write rows. Replace header/data writing with rapidcsv Document construction, same SeparatorParams, same Save-via-stream pattern.

**Step 7: Remove dead code.** After the replacement, ensure no references to `csv_escape` or `write_csv_row` remain anywhere in the file. The `file` ofstream should only be opened AFTER the document is built and saved to the stringstream. Move the parent-directory creation to the top (it already is), and the file open + write to right before the return.

**Key behavioral notes from research:**
- Always use `SetCell<std::string>` -- never let rapidcsv do type conversion (Pitfall 5)
- Sequential row indices starting at 0 (Pitfall 7)
- `hasCR=false` prevents Windows CRLF (Pitfall 1)
- Space-quoting difference won't break existing tests (Pitfall 2: all test fields with spaces also have commas/quotes/newlines)
- Empty collections: SetColumnName with no SetCell calls produces header-only output (Pitfall 6)

**Important:** The `std::ofstream file(path, std::ios::binary)` open and the parent directory creation should remain at the beginning of the function for the directory creation, but the actual file open should be moved to after `doc.Save(oss)` to avoid creating an empty file if the document construction throws. Structure the function as:
1. Create parent directories
2. Build document (may throw)
3. Save to stringstream
4. Open file, write, close
  </action>
  <verify>
Run all C++ tests: `./build/bin/quiver_tests.exe --gtest_filter="*CSV*"` -- all 22 CSV tests must pass.
Run all C API tests: `./build/bin/quiver_c_tests.exe --gtest_filter="*CSV*"` -- all 19 CSV tests must pass.
Run full test suite: `./build/bin/quiver_tests.exe` and `./build/bin/quiver_c_tests.exe` -- no regressions.
Verify `csv_escape` and `write_csv_row` do not appear anywhere in `src/database_csv.cpp`.
  </verify>
  <done>
`csv_escape()` and `write_csv_row()` are deleted. All CSV writing goes through rapidcsv Document/Save API. All 22 C++ and 19 C API CSV export tests pass unchanged. No dead code remains.
  </done>
</task>

</tasks>

<verification>
1. `cmake --build build --config Debug` succeeds
2. `./build/bin/quiver_tests.exe --gtest_filter="*CSV*"` -- 22 tests pass
3. `./build/bin/quiver_c_tests.exe --gtest_filter="*CSV*"` -- 19 tests pass
4. `./build/bin/quiver_tests.exe` -- full suite passes (no regressions)
5. `./build/bin/quiver_c_tests.exe` -- full suite passes (no regressions)
6. `grep -c "csv_escape\|write_csv_row" src/database_csv.cpp` returns 0
7. No new DLL files in `build/bin/` (rapidcsv is header-only)
</verification>

<success_criteria>
- rapidcsv v8.92 integrated via FetchContent, linked PRIVATE to quiver
- `csv_escape()` and `write_csv_row()` completely removed from `src/database_csv.cpp`
- Both scalar and group export paths use rapidcsv Document construction + Save via stringstream
- All 22 C++ CSV tests pass without modification
- All 19 C API CSV tests pass without modification
- Full test suite (C++ and C API) passes with no regressions
- No new DLLs in build output
</success_criteria>

<output>
After completion, create `.planning/phases/08-library-integration/08-01-SUMMARY.md`
</output>
