---
phase: 05-c-core
plan: 02
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - tests/test_database_csv.cpp
  - tests/schemas/valid/csv_export.sql
  - tests/CMakeLists.txt
  - CLAUDE.md
autonomous: true
requirements:
  - CSV-01
  - CSV-02
  - CSV-03
  - CSV-04
  - OPT-01
  - OPT-02
  - OPT-03
  - OPT-04

must_haves:
  truths:
    - "Tests verify scalar export produces correct header (label + attributes in schema order, no id) and data rows"
    - "Tests verify group export for vectors, sets, and time series with label replacing id and correct column ordering"
    - "Tests verify enum resolution replaces integers with labels and unmapped values fall back to raw integers"
    - "Tests verify DateTime formatting applies only to metadata-identified DateTime columns"
    - "Tests verify empty collection produces header-only CSV, NULL values as empty fields, and RFC 4180 escaping"
    - "Tests verify default options pass through raw values unchanged"
  artifacts:
    - path: "tests/test_database_csv.cpp"
      provides: "Comprehensive test suite for export_csv covering all 8 requirements"
      min_lines: 200
    - path: "tests/schemas/valid/csv_export.sql"
      provides: "Test schema with scalars, vectors, sets, time series, DateTime columns, and integer enum candidates"
    - path: "CLAUDE.md"
      provides: "Updated documentation reflecting new csv.h header, database_csv.cpp, and test_database_csv.cpp"
  key_links:
    - from: "tests/test_database_csv.cpp"
      to: "include/quiver/csv.h"
      via: "#include for CSVExportOptions"
      pattern: '#include <quiver/csv.h>'
    - from: "tests/test_database_csv.cpp"
      to: "tests/schemas/valid/csv_export.sql"
      via: "VALID_SCHEMA macro"
      pattern: 'VALID_SCHEMA\("csv_export.sql"\)'
    - from: "tests/CMakeLists.txt"
      to: "tests/test_database_csv.cpp"
      via: "add_executable source list"
      pattern: "test_database_csv.cpp"
---

<objective>
Create comprehensive tests for CSV export covering all 8 phase requirements, plus a dedicated test schema. Update CLAUDE.md documentation.

Purpose: Verify the export_csv implementation satisfies every requirement (CSV-01 through CSV-04, OPT-01 through OPT-04) with concrete test cases.
Output: Passing test suite and updated project documentation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-c-core/05-CONTEXT.md
@.planning/phases/05-c-core/05-RESEARCH.md
@.planning/phases/05-c-core/05-01-SUMMARY.md
@include/quiver/csv.h
@include/quiver/database.h
@src/database_csv.cpp
@tests/test_utils.h
@tests/test_database_read.cpp
@tests/schemas/valid/collections.sql
@tests/CMakeLists.txt
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test schema and comprehensive CSV export tests</name>
  <files>
    tests/schemas/valid/csv_export.sql
    tests/test_database_csv.cpp
    tests/CMakeLists.txt
  </files>
  <action>
**1. Create `tests/schemas/valid/csv_export.sql`:**

A test schema designed to exercise all CSV export scenarios. Must include:
- Configuration table (required by all schemas)
- A collection with multiple scalar types including an integer column suitable for enum resolution, a TEXT column used as DateTime (column name starting with `date_` to be recognized as DateTime by metadata), and a nullable column for NULL testing
- A vector group table with multiple value columns
- A set group table
- A time series group table with a dimension column and value columns

Example schema:
```sql
PRAGMA foreign_keys = ON;

CREATE TABLE Configuration (
    id INTEGER PRIMARY KEY,
    label TEXT UNIQUE NOT NULL
) STRICT;

CREATE TABLE Items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    label TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    status INTEGER,
    price REAL,
    date_created TEXT,
    notes TEXT
) STRICT;

CREATE TABLE Items_vector_measurements (
    id INTEGER NOT NULL REFERENCES Items(id) ON DELETE CASCADE ON UPDATE CASCADE,
    vector_index INTEGER NOT NULL,
    value REAL NOT NULL,
    PRIMARY KEY (id, vector_index)
) STRICT;

CREATE TABLE Items_set_tags (
    id INTEGER NOT NULL REFERENCES Items(id) ON DELETE CASCADE ON UPDATE CASCADE,
    value TEXT NOT NULL,
    UNIQUE (id, value)
) STRICT;

CREATE TABLE Items_time_series_readings (
    id INTEGER NOT NULL REFERENCES Items(id) ON DELETE CASCADE ON UPDATE CASCADE,
    date_time TEXT NOT NULL,
    temperature REAL NOT NULL,
    humidity INTEGER NOT NULL,
    PRIMARY KEY (id, date_time)
) STRICT;
```

Key design choices:
- `status` INTEGER column: used for enum resolution testing (e.g., 1=Active, 2=Inactive)
- `date_created` TEXT column: name starts with `date_` so metadata identifies it as DateTime
- `notes` TEXT column: nullable, for NULL value testing
- `price` REAL column: for float formatting verification
- Vector with single value column: simplest group case
- Set with single value column: simplest set case
- Time series with multiple value columns (REAL + INTEGER): tests multi-column group export

**2. Create `tests/test_database_csv.cpp`:**

Follow existing test patterns (see `test_database_read.cpp`): include `"test_utils.h"`, `<gtest/gtest.h>`, `<quiver/database.h>`, `<quiver/element.h>`, `<quiver/csv.h>`. Also include `<fstream>`, `<filesystem>`, `<sstream>` for reading back CSV files.

Create a helper function to read a CSV file back as a string:
```cpp
static std::string read_file(const std::string& path) {
    std::ifstream f(path, std::ios::binary);
    std::ostringstream ss;
    ss << f.rdbuf();
    return ss.str();
}
```

Use temporary file paths for CSV output. Use `std::filesystem::temp_directory_path()` combined with unique test names. Clean up temp files in each test.

**Required test cases (map to requirements):**

**CSV-01 tests (export_csv routing):**
- `ExportCSV_ScalarExport_HeaderAndData`: Create 2 Items elements with all scalar fields populated. Export with `group=""`. Verify header is `label,name,status,price,date_created,notes` (schema order, no `id`). Verify 2 data rows with correct values.
- `ExportCSV_VectorGroupExport`: Create element, add vector measurements. Export with `group="measurements"`. Verify header is `label,value` (no `id`, no `vector_index`). Verify data rows have label and values.
- `ExportCSV_SetGroupExport`: Create element, add set tags. Export with `group="tags"`. Verify header is `label,value`. Verify data rows.
- `ExportCSV_TimeSeriesGroupExport`: Create element, add time series readings. Export with `group="readings"`. Verify header is `label,date_time,temperature,humidity`. Verify data rows ordered by date_time.
- `ExportCSV_InvalidGroup_Throws`: Verify that exporting with a non-existent group throws with error pattern `"Cannot export_csv: group not found: ..."`.

**CSV-02 tests (RFC 4180 compliance):**
- `ExportCSV_RFC4180_CommaEscaping`: Create element with a string field containing commas. Verify field is wrapped in double quotes.
- `ExportCSV_RFC4180_QuoteEscaping`: Create element with a string field containing double quotes. Verify quotes are doubled and field is wrapped.
- `ExportCSV_RFC4180_NewlineEscaping`: Create element with a string field containing newlines. Verify field is wrapped in double quotes.
- `ExportCSV_LFLineEndings`: Read back raw bytes and verify line endings are `\n` not `\r\n`.

**CSV-03 tests (empty collection):**
- `ExportCSV_EmptyCollection_HeaderOnly`: Export with no elements created. Verify file contains only the header row (plus trailing LF). Verify no error thrown.

**CSV-04 tests (NULL values):**
- `ExportCSV_NullValues_EmptyFields`: Create element with some NULL fields (don't set optional attributes). Verify NULL fields appear as empty (no quotes, just commas).

**OPT-01 tests (CSVExportOptions struct):**
- `ExportCSV_DefaultOptions_RawValues`: Export with default options. Verify integer enum column has raw integer values, DateTime column has raw string values.

**OPT-02 tests (enum resolution):**
- `ExportCSV_EnumLabels_ReplacesIntegers`: Create options with `enum_labels["status"] = {{1, "Active"}, {2, "Inactive"}}`. Create elements with status 1 and 2. Verify output has "Active" and "Inactive" instead of 1 and 2.
- `ExportCSV_EnumLabels_UnmappedFallback`: Create options with partial enum map (only maps value 1). Create element with status 3 (unmapped). Verify unmapped value appears as "3" (raw integer, not empty, not crash).

**OPT-03 tests (date formatting):**
- `ExportCSV_DateTimeFormat_FormatsDateColumns`: Create options with `date_time_format = "%Y/%m/%d"`. Create element with `date_created = "2024-01-15T10:30:00"`. Verify output has "2024/01/15" (formatted).
- `ExportCSV_DateTimeFormat_NonDateColumnsUnaffected`: Same test, verify that non-date string columns (like `name`, `notes`) are NOT formatted even though `date_time_format` is set.

**OPT-04 tests (default options factory):**
- `ExportCSV_DefaultOptionsFactory`: Verify `quiver::default_csv_export_options()` returns options with empty enum_labels and empty date_time_format. (Simple value check, no file I/O needed.)

**Parent directory creation test:**
- `ExportCSV_CreatesParentDirectories`: Export to a path with non-existent parent directories. Verify file is created successfully.

**Overwrite test:**
- `ExportCSV_OverwritesExistingFile`: Write a file, then export to same path. Verify file is overwritten with new content.

Each test should follow this pattern:
```cpp
TEST(DatabaseCSV, TestName) {
    auto db = quiver::Database::from_schema(
        ":memory:", VALID_SCHEMA("csv_export.sql"),
        {.read_only = 0, .console_level = QUIVER_LOG_OFF});

    // ... create elements ...

    auto csv_path = std::filesystem::temp_directory_path() / "quiver_test_TestName.csv";
    db.export_csv("Items", "", csv_path.string());

    auto content = read_file(csv_path.string());
    // ... assertions ...

    std::filesystem::remove(csv_path);
}
```

**3. Update `tests/CMakeLists.txt`:**

Add `test_database_csv.cpp` to the `quiver_tests` executable source list (after `test_database_create.cpp` or in alphabetical position among test files).
  </action>
  <verify>
Run: `cmake --build build --config Debug 2>&1` -- must compile without errors. Run: `./build/bin/quiver_tests.exe --gtest_filter="DatabaseCSV.*"` -- all new CSV tests must pass.
  </verify>
  <done>
- `tests/schemas/valid/csv_export.sql` exists with a schema covering all test scenarios
- `tests/test_database_csv.cpp` exists with 15+ test cases covering all 8 requirements
- All tests pass: scalar export, group export (vector/set/time series), RFC 4180 escaping, empty collection, NULL values, enum resolution, date formatting, default options, parent directory creation, overwrite behavior
- `test_database_csv.cpp` added to CMakeLists.txt
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLAUDE.md documentation</name>
  <files>CLAUDE.md</files>
  <action>
Update CLAUDE.md to reflect the new files and patterns added in this phase:

**1. Architecture section** -- add `csv.h` to the include/quiver/ file listing:
```
  csv.h                 # CSVExportOptions struct and default factory
```

**2. Architecture section** -- add `database_csv.cpp` to the src/ file listing:
```
  database_csv.cpp              # CSV export implementation
```

**3. Test Organization section** -- add the new test file:
```
- `test_database_csv.cpp` - CSV export operations (scalar, group, options, formatting)
```

**4. Core API > Database Class section** -- add/update the CSV line:
Change the existing CSV line or add after "Schema inspection":
```
- CSV: `export_csv()` â€” exports collection scalars or groups to CSV file with optional enum/date formatting via `CSVExportOptions`
```

**5. Pimpl vs Value Types section** -- add CSVExportOptions to the list of plain value types:
Add `CSVExportOptions` to the parenthetical list of classes that are plain value types using Rule of Zero.

Do NOT add documentation files or README content beyond updating CLAUDE.md per the Self-Updating principle.
  </action>
  <verify>
Read CLAUDE.md and verify the new entries are present and consistent with existing format.
  </verify>
  <done>
- CLAUDE.md lists csv.h in architecture section
- CLAUDE.md lists database_csv.cpp in architecture section
- CLAUDE.md lists test_database_csv.cpp in test organization
- CLAUDE.md mentions CSVExportOptions as a plain value type
- CLAUDE.md documents export_csv in Core API section
  </done>
</task>

</tasks>

<verification>
1. `cmake --build build --config Debug` compiles without errors
2. `./build/bin/quiver_tests.exe` -- ALL tests pass (existing + new CSV tests)
3. `./build/bin/quiver_c_tests.exe` -- all existing C API tests pass
4. CSV test coverage: scalar export, vector/set/time series group export, RFC 4180 escaping, empty collection, NULL values, enum resolution, date formatting, default options
5. CLAUDE.md updated with new file references
</verification>

<success_criteria>
- All CSV export tests pass covering every requirement (CSV-01 to CSV-04, OPT-01 to OPT-04)
- Test schema exercises all data types and group types
- CLAUDE.md accurately reflects the new codebase additions
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/05-c-core/05-02-SUMMARY.md`
</output>
