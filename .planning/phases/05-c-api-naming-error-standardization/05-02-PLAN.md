---
phase: 05-c-api-naming-error-standardization
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - bindings/julia/src/c_api.jl
  - bindings/julia/src/database_delete.jl
  - bindings/julia/src/database_read.jl
  - bindings/julia/src/database_metadata.jl
  - bindings/julia/src/database_query.jl
  - bindings/julia/src/element.jl
  - bindings/dart/lib/src/ffi/bindings.dart
  - bindings/dart/lib/src/database_delete.dart
  - bindings/dart/lib/src/database_read.dart
  - bindings/dart/lib/src/database_metadata.dart
  - bindings/dart/lib/src/database_query.dart
  - bindings/dart/lib/src/database_relations.dart
  - bindings/dart/lib/src/element.dart
  - src/c/lua_runner.cpp
  - CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "Julia FFI layer (c_api.jl) references new C API function names"
    - "Julia wrapper files call new FFI function names via C.quiver_database_free_* pattern"
    - "Dart FFI layer (bindings.dart) references new C API function names"
    - "Dart wrapper files call new FFI function names via bindings.quiver_database_free_* pattern"
    - "lua_runner.cpp uses extern C block and QUIVER_C_API consistently with other C API files"
    - "CLAUDE.md documents updated C API naming conventions"
  artifacts:
    - path: "bindings/julia/src/c_api.jl"
      provides: "Regenerated Julia FFI bindings with new function names"
      contains: "quiver_database_free_integer_array"
    - path: "bindings/dart/lib/src/ffi/bindings.dart"
      provides: "Regenerated Dart FFI bindings with new function names"
      contains: "quiver_database_free_integer_array"
    - path: "src/c/lua_runner.cpp"
      provides: "Normalized error handling with extern C and QUIVER_C_API"
      contains: "extern \"C\""
  key_links:
    - from: "bindings/julia/src/c_api.jl"
      to: "bindings/julia/src/database_read.jl"
      via: "wrapper calls generated FFI functions"
      pattern: "C\\.quiver_database_free_integer_array"
    - from: "bindings/dart/lib/src/ffi/bindings.dart"
      to: "bindings/dart/lib/src/database_read.dart"
      via: "wrapper calls generated FFI functions"
      pattern: "bindings\\.quiver_database_free_integer_array"
---

<objective>
Regenerate Julia/Dart FFI bindings, update all wrapper code to use new C API function names, normalize lua_runner.cpp error handling, and update CLAUDE.md.

Purpose: Complete the rename cascade through all downstream consumers. The C API layer was renamed in Plan 01; this plan propagates those renames to Julia and Dart bindings, normalizes the one remaining error handling inconsistency, and updates documentation.

Output: Working Julia and Dart bindings with new names, normalized lua_runner.cpp, updated CLAUDE.md.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-c-api-naming-error-standardization/05-RESEARCH.md
@.planning/phases/05-c-api-naming-error-standardization/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Regenerate Julia/Dart FFI bindings and update wrapper code</name>
  <files>
    bindings/julia/src/c_api.jl
    bindings/julia/src/database_delete.jl
    bindings/julia/src/database_read.jl
    bindings/julia/src/database_metadata.jl
    bindings/julia/src/database_query.jl
    bindings/julia/src/element.jl
    bindings/dart/lib/src/ffi/bindings.dart
    bindings/dart/lib/src/database_delete.dart
    bindings/dart/lib/src/database_read.dart
    bindings/dart/lib/src/database_metadata.dart
    bindings/dart/lib/src/database_query.dart
    bindings/dart/lib/src/database_relations.dart
    bindings/dart/lib/src/element.dart
  </files>
  <action>
**Step 1: Re-run Julia generator.**
Run `bindings/julia/generator/generator.bat` to regenerate `bindings/julia/src/c_api.jl`. Verify the generated file contains new function names (e.g., `quiver_database_free_integer_array`, `quiver_database_delete_element`, `quiver_element_free_string`).

**Step 2: Update Julia wrapper files.**
Apply these renames in Julia wrapper code (these files call `C.quiver_*` functions from c_api.jl):

- `database_delete.jl`: `C.quiver_database_delete_element_by_id` -> `C.quiver_database_delete_element`
- `database_read.jl`: All `C.quiver_free_*` -> `C.quiver_database_free_*` (approximately 20 call sites). Also `C.quiver_string_free` -> `C.quiver_element_free_string` if present. Also `C.quiver_free_time_series_data` -> `C.quiver_database_free_time_series_data` and `C.quiver_free_time_series_files` -> `C.quiver_database_free_time_series_files`.
- `database_metadata.jl`: `C.quiver_free_scalar_metadata` -> `C.quiver_database_free_scalar_metadata`, `C.quiver_free_group_metadata` -> `C.quiver_database_free_group_metadata`, `C.quiver_free_scalar_metadata_array` -> `C.quiver_database_free_scalar_metadata_array`, `C.quiver_free_group_metadata_array` -> `C.quiver_database_free_group_metadata_array`, `C.quiver_free_string_array` -> `C.quiver_database_free_string_array`.
- `database_query.jl`: `C.quiver_string_free` -> `C.quiver_element_free_string` (2 call sites).
- `element.jl`: `C.quiver_string_free` -> `C.quiver_element_free_string`.

**Step 3: Re-run Dart generator.**
Run `bindings/dart/generator/generator.bat` to regenerate `bindings/dart/lib/src/ffi/bindings.dart`. Verify the generated file contains new function names.

**Step 4: Update Dart wrapper files.**
Apply these renames in Dart wrapper code (these files call `bindings.quiver_*` functions):

- `database_delete.dart`: `bindings.quiver_database_delete_element_by_id` -> `bindings.quiver_database_delete_element`
- `database_read.dart`: All `bindings.quiver_free_*` -> `bindings.quiver_database_free_*` (approximately 20 call sites). Also `bindings.quiver_string_free` -> `bindings.quiver_element_free_string` if present. Also time series free functions.
- `database_metadata.dart`: All `bindings.quiver_free_scalar_metadata*` -> `bindings.quiver_database_free_scalar_metadata*`, `bindings.quiver_free_group_metadata*` -> `bindings.quiver_database_free_group_metadata*`, `bindings.quiver_free_string_array` -> `bindings.quiver_database_free_string_array`.
- `database_query.dart`: `bindings.quiver_string_free` -> `bindings.quiver_element_free_string`.
- `database_relations.dart`: `bindings.quiver_free_string_array` -> `bindings.quiver_database_free_string_array`.
- `element.dart`: Check for `bindings.quiver_string_free` and rename if present.

**Step 5: Verify no stale references.**
Grep all Julia and Dart binding/wrapper files for old function names. Only the generated FFI files and planning docs should be clean -- verify ALL wrapper files have no stale references.

**Important:** The `quiver_string_free` rename target is `quiver_element_free_string` (not `quiver_database_free_string`), because it belongs to the element entity, not database. Do NOT accidentally use the wrong entity prefix.
  </action>
  <verify>
1. Grep Julia wrappers for old names: `grep -r "quiver_free_\|quiver_string_free\|delete_element_by_id" bindings/julia/src/ --include="*.jl"` -- must return zero matches.
2. Grep Dart wrappers for old names: `grep -r "quiver_free_\|quiver_string_free\|delete_element_by_id" bindings/dart/lib/src/ --include="*.dart"` -- must return zero matches.
3. Build C library: `cmake --build build --config Debug` -- must succeed (needed for binding tests).
  </verify>
  <done>Julia and Dart FFI layers regenerated with new function names. All Julia and Dart wrapper files updated. No stale old function names remain in any binding source file.</done>
</task>

<task type="auto">
  <name>Task 2: Normalize lua_runner.cpp error handling and update CLAUDE.md</name>
  <files>
    src/c/lua_runner.cpp
    CLAUDE.md
  </files>
  <action>
**Part 1: Normalize lua_runner.cpp**

Wrap all function definitions in `src/c/lua_runner.cpp` in an `extern "C" { ... }` block, and add `QUIVER_C_API` to each function definition. This matches the pattern used by all other C API implementation files (database.cpp, database_create.cpp, etc.).

Current pattern (inconsistent):
```cpp
quiver_error_t quiver_lua_runner_new(quiver_database_t* db, quiver_lua_runner_t** out_runner) {
```

Target pattern (consistent):
```cpp
extern "C" {

QUIVER_C_API quiver_error_t quiver_lua_runner_new(quiver_database_t* db, quiver_lua_runner_t** out_runner) {
```

Add `QUIVER_C_API` to all 4 function definitions: `quiver_lua_runner_new`, `quiver_lua_runner_free`, `quiver_lua_runner_run`, `quiver_lua_runner_get_error`. Wrap them all in a single `extern "C" { ... }` block.

**Part 2: Update CLAUDE.md**

Update the C API patterns section in CLAUDE.md to reflect the renamed functions:
- Update the `src/c/` file structure comments if they reference old free function names
- Update the "Metadata Types" section: `quiver_free_scalar_metadata` -> `quiver_database_free_scalar_metadata`, etc.
- Update the "Alloc/Free Co-location" section if it references old names
- Update the "Memory Management" section examples: `quiver_free_strings` -> `quiver_database_free_string_array` (or whatever the correct new example is)
- Ensure the documented free function names match the actual code

Do NOT update planning/roadmap documentation -- only CLAUDE.md (the codebase reference).
  </action>
  <verify>
1. `grep "QUIVER_C_API" src/c/lua_runner.cpp` -- should show 4 matches (one per function).
2. `grep "extern \"C\"" src/c/lua_runner.cpp` -- should show 1 match.
3. `cmake --build build --config Debug` -- must succeed.
4. `./build/bin/quiver_c_tests.exe` -- all tests pass (lua_runner tests included).
5. `./build/bin/quiver_tests.exe` -- all C++ tests pass.
6. Verify CLAUDE.md contains `quiver_database_free_scalar_metadata` (not old `quiver_free_scalar_metadata`).
  </verify>
  <done>lua_runner.cpp uses extern "C" block and QUIVER_C_API on all 4 function definitions, consistent with all other C API files. CLAUDE.md updated with new function names. All tests pass.</done>
</task>

</tasks>

<verification>
1. Zero occurrences of old function names in ALL source files (include/, src/, tests/, bindings/) -- only .planning/ and .md docs may reference old names
2. `cmake --build build --config Debug` succeeds
3. `./build/bin/quiver_c_tests.exe` -- all tests pass
4. `./build/bin/quiver_tests.exe` -- all tests pass
5. Julia generator output (c_api.jl) contains new function names
6. Dart generator output (bindings.dart) contains new function names
7. lua_runner.cpp has extern "C" block and QUIVER_C_API on all definitions
8. CLAUDE.md references new function names
</verification>

<success_criteria>
- Julia and Dart FFI bindings regenerated with new names
- All Julia and Dart wrapper files updated with new names
- lua_runner.cpp error handling normalized
- CLAUDE.md updated
- Full test suite passes across C++ and C API
</success_criteria>

<output>
After completion, create `.planning/phases/05-c-api-naming-error-standardization/05-02-SUMMARY.md`
</output>
