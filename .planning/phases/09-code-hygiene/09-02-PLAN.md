---
phase: 09-code-hygiene
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .clang-tidy
  - CMakeLists.txt
autonomous: true
must_haves:
  truths:
    - "A .clang-tidy configuration file exists at project root with bugprone-*, modernize-*, performance-*, and readability-identifier-naming checks enabled"
    - "Running clang-tidy against the codebase produces zero errors on project code (warnings are acceptable for third-party/system header noise; suppressions documented via NOLINT comments for intentional exceptions)"
    - "A CMake custom target 'tidy' exists for running clang-tidy"
  artifacts:
    - path: ".clang-tidy"
      provides: "clang-tidy configuration with required check families"
      contains: "bugprone-"
    - path: "CMakeLists.txt"
      provides: "Custom 'tidy' target for running clang-tidy"
      contains: "clang-tidy"
  key_links:
    - from: "CMakeLists.txt"
      to: ".clang-tidy"
      via: "clang-tidy reads config from project root when invoked via CMake target"
      pattern: "clang-tidy"
---

<objective>
Integrate clang-tidy static analysis into the project with a configuration targeting the required check families and fix any violations in project code.

Purpose: Establish automated static analysis that catches bugs, enforces naming conventions, suggests modernization, and identifies performance issues. The configuration filters out third-party headers and accommodates the dual C++/C naming convention.

Output: `.clang-tidy` config file, CMake `tidy` target, zero clang-tidy errors on project code (with documented NOLINT suppressions for intentional exceptions).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@CMakeLists.txt
@.planning/phases/09-code-hygiene/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .clang-tidy configuration and CMake tidy target</name>
  <files>
    .clang-tidy
    CMakeLists.txt
  </files>
  <action>
**Step 1: Create `.clang-tidy` at project root.**

The configuration must:
- Enable check families: `bugprone-*`, `modernize-*`, `performance-*`, `readability-identifier-naming`
- Disable known noisy checks:
  - `bugprone-easily-swappable-parameters` (many methods with same-type params by design)
  - `modernize-use-trailing-return-type` (project uses traditional return syntax)
  - `modernize-avoid-c-arrays` (C API uses C arrays by design)
  - `bugprone-narrowing-conversions` (controlled narrowing in int64_t <-> size_t conversions)
  - `modernize-use-nodiscard` (too noisy, would require hundreds of [[nodiscard]] annotations)
- Set `HeaderFilterRegex` to `(include/quiver/|src/)` to analyze only project headers
- Configure naming rules:
  - ClassCase: CamelCase
  - StructCase: CamelCase
  - EnumCase: CamelCase
  - FunctionCase: lower_case
  - MethodCase: lower_case
  - VariableCase: lower_case
  - MemberCase: lower_case
  - PrivateMemberSuffix: `_`
  - NamespaceCase: lower_case
  - EnumConstantCase: CamelCase
  - ConstexprVariableCase: lower_case
  - GlobalConstantCase: lower_case
  - ParameterCase: lower_case

```yaml
---
Checks: >
  -*,
  bugprone-*,
  modernize-*,
  performance-*,
  readability-identifier-naming,
  readability-redundant-*,
  readability-simplify-*,
  -bugprone-easily-swappable-parameters,
  -modernize-use-trailing-return-type,
  -modernize-avoid-c-arrays,
  -bugprone-narrowing-conversions,
  -modernize-use-nodiscard

WarningsAsErrors: ''

HeaderFilterRegex: '(include/quiver/|src/)'

CheckOptions:
  - key: readability-identifier-naming.ClassCase
    value: CamelCase
  - key: readability-identifier-naming.StructCase
    value: CamelCase
  - key: readability-identifier-naming.EnumCase
    value: CamelCase
  - key: readability-identifier-naming.FunctionCase
    value: lower_case
  - key: readability-identifier-naming.MethodCase
    value: lower_case
  - key: readability-identifier-naming.VariableCase
    value: lower_case
  - key: readability-identifier-naming.MemberCase
    value: lower_case
  - key: readability-identifier-naming.PrivateMemberSuffix
    value: '_'
  - key: readability-identifier-naming.NamespaceCase
    value: lower_case
  - key: readability-identifier-naming.EnumConstantCase
    value: CamelCase
  - key: readability-identifier-naming.ConstexprVariableCase
    value: lower_case
  - key: readability-identifier-naming.GlobalConstantCase
    value: lower_case
  - key: readability-identifier-naming.ParameterCase
    value: lower_case
```

**Step 2: Add CMake `tidy` target to root `CMakeLists.txt`.**

Add after the existing `format` target block (after line 87):
```cmake
# Tidy target
find_program(CLANG_TIDY clang-tidy)
if(CLANG_TIDY)
    add_custom_target(tidy
        COMMAND ${CLANG_TIDY}
            -p ${CMAKE_BINARY_DIR}
            --header-filter="(include/quiver/|src/)"
            ${ALL_SOURCE_FILES}
        COMMENT "Running clang-tidy"
    )
endif()
```

Note: The `ALL_SOURCE_FILES` variable is already defined in the `format` target block. The `tidy` target reuses it. However, the variable is defined inside the `if(CLANG_FORMAT)` block scope. Move the `file(GLOB_RECURSE ALL_SOURCE_FILES ...)` call BEFORE both the format and tidy target blocks so both can use it. Or define a separate glob for tidy. The cleaner approach is to move the glob outside:

```cmake
# Source files for format and tidy targets
file(GLOB_RECURSE ALL_SOURCE_FILES
    ${CMAKE_SOURCE_DIR}/include/quiver/*.h
    ${CMAKE_SOURCE_DIR}/include/quiver/c/*.h
    ${CMAKE_SOURCE_DIR}/src/*.cpp
    ${CMAKE_SOURCE_DIR}/src/*.h
    ${CMAKE_SOURCE_DIR}/src/c/*.cpp
    ${CMAKE_SOURCE_DIR}/src/c/*.h
    ${CMAKE_SOURCE_DIR}/tests/*.cpp
    ${CMAKE_SOURCE_DIR}/tests/*.h
)

# Format target
find_program(CLANG_FORMAT clang-format)
if(CLANG_FORMAT)
    add_custom_target(format
        COMMAND ${CLANG_FORMAT} -i ${ALL_SOURCE_FILES}
        COMMENT "Formatting code with clang-format"
    )
endif()

# Tidy target
find_program(CLANG_TIDY clang-tidy)
if(CLANG_TIDY)
    add_custom_target(tidy
        COMMAND ${CLANG_TIDY}
            -p ${CMAKE_BINARY_DIR}
            --header-filter="(include/quiver/|src/)"
            ${ALL_SOURCE_FILES}
        COMMENT "Running clang-tidy"
    )
endif()
```

Note the glob patterns should include `src/c/*.cpp` (not `src/c/*.c` -- the C API files are .cpp despite being C API).
  </action>
  <verify>
Verify the .clang-tidy file is valid YAML and the CMake configure step succeeds:
```bash
cmake -B build -G "MinGW Makefiles" -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
```
  </verify>
  <done>
`.clang-tidy` exists at project root with all required check families. CMakeLists.txt has a `tidy` custom target. CMake configure succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run clang-tidy, fix violations, add NOLINT suppressions for intentional exceptions</name>
  <files>
    .clang-tidy
    src/lua_runner.cpp
  </files>
  <action>
**Step 1: Run clang-tidy on all source files.**

The complete set of project source files is listed below. Run clang-tidy against the compile_commands.json generated by CMake.

Core library files (16 files):
```
src/database.cpp
src/database_create.cpp
src/database_delete.cpp
src/database_describe.cpp
src/database_metadata.cpp
src/database_query.cpp
src/database_read.cpp
src/database_relations.cpp
src/database_time_series.cpp
src/database_update.cpp
src/element.cpp
src/lua_runner.cpp
src/migration.cpp
src/migrations.cpp
src/result.cpp
src/row.cpp
src/schema.cpp
src/schema_validator.cpp
src/type_validator.cpp
```

C API files (11 files):
```
src/c/common.cpp
src/c/database.cpp
src/c/database_create.cpp
src/c/database_metadata.cpp
src/c/database_query.cpp
src/c/database_read.cpp
src/c/database_relations.cpp
src/c/database_time_series.cpp
src/c/database_update.cpp
src/c/element.cpp
src/c/lua_runner.cpp
```

Run on core library files first:
```bash
clang-tidy -p build src/database.cpp src/database_create.cpp src/database_delete.cpp src/database_describe.cpp src/database_metadata.cpp src/database_query.cpp src/database_read.cpp src/database_relations.cpp src/database_time_series.cpp src/database_update.cpp src/element.cpp src/lua_runner.cpp src/migration.cpp src/migrations.cpp src/result.cpp src/row.cpp src/schema.cpp src/schema_validator.cpp src/type_validator.cpp --header-filter="(include/quiver/|src/)" 2>&1 | tee tidy_core.log
```

Then run on C API files:
```bash
clang-tidy -p build src/c/common.cpp src/c/database.cpp src/c/database_create.cpp src/c/database_metadata.cpp src/c/database_query.cpp src/c/database_read.cpp src/c/database_relations.cpp src/c/database_time_series.cpp src/c/database_update.cpp src/c/element.cpp src/c/lua_runner.cpp --header-filter="(include/quiver/|src/)" 2>&1 | tee tidy_capi.log
```

If MinGW header issues occur, try adding `--extra-arg=--target=x86_64-w64-mingw32` or `--extra-arg=-isystem` flags for MinGW system include paths.

**Step 2: Fix legitimate violations.**

For each warning:
- If it is a genuine bug or improvement: fix the code
- Common expected fixes:
  - `modernize-use-auto` -- switch to `auto` where type is obvious from RHS
  - `modernize-use-nullptr` -- replace `NULL` or `0` with `nullptr`
  - `performance-unnecessary-value-param` -- take by const ref where copy is unnecessary
  - `readability-identifier-naming` -- rename to match configured convention
  - `performance-move-const-arg` -- remove unnecessary std::move on const
  - `modernize-use-emplace` -- replace push_back with emplace_back

**Step 3: Add NOLINT suppressions for intentional exceptions.**

- `src/lua_runner.cpp`: This file is almost entirely sol2 template instantiations. If it produces many warnings from sol2 internals despite header filtering, add `// NOLINT` comments on specific lines, or if the file generates hundreds of warnings, consider adding a `// NOLINTBEGIN` / `// NOLINTEND` block around the sol2-heavy sections. Document the reason: "sol2 template instantiations trigger clang-tidy warnings in expanded code".
- C API naming: If `readability-identifier-naming` flags C API struct names ending in `_t` (like `quiver_database_t`), add NOLINT on those specific type definitions with reason. These should be few -- the C API structs are defined in `src/c/internal.h`.
- Any other intentional patterns: Add NOLINT with a comment explaining why.

**Step 4: Re-run clang-tidy to verify zero errors.**

After fixing all violations, re-run clang-tidy on all source files and confirm zero warnings/errors.

**Step 5: If clang-tidy cannot run on this MinGW setup.**

If clang-tidy fails entirely due to MinGW header incompatibility (system header not found, unknown type errors), document this in the SUMMARY and adjust the `.clang-tidy` config to note the limitation. Add a comment to CMakeLists.txt noting MinGW compatibility requirements. The `.clang-tidy` config itself is still valuable for IDEs (CLion, VS Code with clangd) that can use it.

**Important:** Do NOT modify any behavior-affecting code while fixing clang-tidy violations. Only style/convention changes and NOLINT annotations.
  </action>
  <verify>
1. Run clang-tidy on all source files and confirm zero errors (warnings from third-party/system headers are acceptable):
```bash
clang-tidy -p build src/database.cpp src/database_create.cpp src/database_delete.cpp src/database_describe.cpp src/database_metadata.cpp src/database_query.cpp src/database_read.cpp src/database_relations.cpp src/database_time_series.cpp src/database_update.cpp src/element.cpp src/lua_runner.cpp src/migration.cpp src/migrations.cpp src/result.cpp src/row.cpp src/schema.cpp src/schema_validator.cpp src/type_validator.cpp src/c/common.cpp src/c/database.cpp src/c/database_create.cpp src/c/database_metadata.cpp src/c/database_query.cpp src/c/database_read.cpp src/c/database_relations.cpp src/c/database_time_series.cpp src/c/database_update.cpp src/c/element.cpp src/c/lua_runner.cpp --header-filter="(include/quiver/|src/)" 2>&1 | grep -c "error:"
```
Should output 0. Warnings from system/third-party headers outside the `HeaderFilterRegex` are acceptable and not counted.

2. Build and run tests to confirm no regressions:
```bash
cmake --build build --config Debug && ./build/bin/quiver_tests.exe && ./build/bin/quiver_c_tests.exe
```
  </verify>
  <done>
clang-tidy runs against the full codebase (30 source files) with zero errors. Warnings from system/third-party headers are acceptable. Any NOLINT suppressions on project code are documented with reasons. All existing tests pass with zero regressions.
  </done>
</task>

</tasks>

<verification>
1. `.clang-tidy` file exists with `bugprone-*`, `modernize-*`, `performance-*`, `readability-identifier-naming` enabled
2. CMake `tidy` target exists and is usable
3. clang-tidy produces zero errors on all project source files
4. All NOLINT suppressions have documented reasons
5. `./build/bin/quiver_tests.exe` passes
6. `./build/bin/quiver_c_tests.exe` passes
</verification>

<success_criteria>
- .clang-tidy config exists with all required check families
- CMake tidy target exists
- Zero clang-tidy errors (with documented NOLINT for intentional exceptions)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-code-hygiene/09-02-SUMMARY.md`
</output>
