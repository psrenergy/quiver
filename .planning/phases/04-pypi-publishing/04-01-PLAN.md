---
phase: 04-pypi-publishing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [.github/workflows/publish.yml]
autonomous: false
requirements: [CI-04]
user_setup:
  - service: pypi
    why: "Trusted publisher (OIDC) requires a pending publisher registered on PyPI before first publish"
    dashboard_config:
      - task: "Register pending trusted publisher for quiverdb"
        location: "https://pypi.org/manage/account/publishing/"
        details: "PyPI project name: quiverdb, Owner: <your GitHub username/org>, Repository: quiver2, Workflow name: publish.yml, Environment name: pypi"

must_haves:
  truths:
    - "Pushing a v*.*.* tag triggers the publish workflow"
    - "Workflow builds fresh wheels via cibuildwheel for Windows x64 and Linux x64"
    - "Tag version is validated against pyproject.toml version before publish"
    - "Exactly 2 wheels are validated before publish"
    - "GitHub Release is auto-created with auto-generated notes and wheel attachments"
    - "Wheels are published to PyPI via OIDC trusted publishing (no API tokens)"
  artifacts:
    - path: ".github/workflows/publish.yml"
      provides: "Tag-triggered publish pipeline: build, validate, release, publish"
      contains: "pypa/gh-action-pypi-publish@release/v1"
  key_links:
    - from: ".github/workflows/publish.yml (validate job)"
      to: "bindings/python/pyproject.toml"
      via: "tomllib version extraction"
      pattern: "tomllib.*pyproject\\.toml"
    - from: ".github/workflows/publish.yml (publish job)"
      to: "PyPI"
      via: "OIDC trusted publishing"
      pattern: "id-token: write"
    - from: ".github/workflows/publish.yml (release job)"
      to: "GitHub Releases"
      via: "softprops/action-gh-release"
      pattern: "generate_release_notes: true"
---

<objective>
Create the tag-triggered publish workflow that builds wheels, validates the release, creates a GitHub Release, and publishes to PyPI via OIDC trusted publishing.

Purpose: This is the final phase -- completing the pipeline from `git tag v0.5.0 && git push --tags` to `pip install quiverdb` working on any clean machine.
Output: `.github/workflows/publish.yml` -- a self-contained workflow triggered by v*.*.* tag pushes
</objective>

<execution_context>
@C:/Users/rsampaio/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rsampaio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pypi-publishing/04-CONTEXT.md
@.planning/phases/04-pypi-publishing/04-RESEARCH.md
@.planning/phases/03-ci-wheel-building/03-01-SUMMARY.md
@.github/workflows/build-wheels.yml
@bindings/python/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create publish.yml workflow</name>
  <files>.github/workflows/publish.yml</files>
  <action>
Create `.github/workflows/publish.yml` with the following structure. The workflow reuses the same cibuildwheel configuration already in pyproject.toml and follows the same artifact patterns as the existing `build-wheels.yml`.

**Trigger:** `push: tags: ["v*.*.*"]`

**Jobs (5 jobs, sequential pipeline):**

1. **build** -- Matrix job (ubuntu-latest, windows-latest) building wheels via cibuildwheel.
   - Same pattern as build-wheels.yml: checkout, cibuildwheel@v3.3.1 with package-dir: bindings/python and output-dir: wheelhouse, upload-artifact@v6 with name: wheels-${{ matrix.os }}
   - `fail-fast: false` per existing convention

2. **merge** -- Merge per-platform artifacts into single "wheels" artifact.
   - Same as build-wheels.yml: upload-artifact/merge@v4 with pattern: wheels-*, delete-merged: true
   - No retention-days needed (artifacts are consumed within the same workflow run)

3. **validate** -- Tag-vs-version match and wheel count validation.
   - needs: merge
   - checkout (for pyproject.toml access) + download-artifact@v4 (wheels into dist/)
   - Step "Validate tag matches pyproject.toml version":
     ```
     TAG_VERSION="${GITHUB_REF_NAME#v}"
     PKG_VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('bindings/python/pyproject.toml','rb'))['project']['version'])")
     if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
       echo "::error::Tag version ($TAG_VERSION) != pyproject.toml version ($PKG_VERSION)"
       exit 1
     fi
     echo "Version validated: $TAG_VERSION"
     ```
   - Step "Validate wheel count":
     ```
     WHEEL_COUNT=$(ls dist/*.whl | wc -l)
     if [ "$WHEEL_COUNT" -ne 2 ]; then
       echo "::error::Expected 2 wheels, found $WHEEL_COUNT"
       exit 1
     fi
     echo "Wheel count validated: $WHEEL_COUNT"
     ```

4. **release** -- Create GitHub Release with wheel attachments.
   - needs: validate
   - `permissions: contents: write`
   - download-artifact@v4 (wheels into dist/)
   - softprops/action-gh-release@v2 with `generate_release_notes: true` and `files: dist/*.whl`

5. **publish** -- Upload to PyPI via OIDC trusted publishing.
   - needs: validate (parallel with release -- both depend on validate, not on each other)
   - `environment: pypi`
   - `permissions: id-token: write` (job-level only, not workflow-level -- least privilege)
   - download-artifact@v4 (wheels into dist/)
   - pypa/gh-action-pypi-publish@release/v1 (no `with:` block needed -- defaults to dist/ and OIDC auth)

**Key details to get right:**
- `id-token: write` ONLY on the publish job, not workflow-level
- `contents: write` ONLY on the release job
- `environment: pypi` on publish job must match PyPI trusted publisher registration
- release and publish run in parallel after validate (both `needs: validate`)
- No sdist step (wheels only per user decision)
  </action>
  <verify>
    <automated>python3 -c "import yaml; y=yaml.safe_load(open('.github/workflows/publish.yml')); assert y['on']['push']['tags']==['v*.*.*']; jobs=set(y['jobs'].keys()); assert jobs=={'build','merge','validate','release','publish'}; assert y['jobs']['publish']['permissions']=={'id-token':'write'}; assert y['jobs']['publish']['environment']=='pypi'; assert y['jobs']['release']['permissions']=={'contents':'write'}; print('PASS')"</automated>
    <manual>Review the workflow YAML for correctness against the research patterns in 04-RESEARCH.md</manual>
  </verify>
  <done>publish.yml exists with all 5 jobs (build, merge, validate, release, publish), triggers on v*.*.* tags, uses OIDC trusted publishing, creates GitHub Release with auto-notes, and validates tag-vs-version + wheel count</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Register PyPI pending trusted publisher</name>
  <files>No files -- PyPI web dashboard action</files>
  <action>
The publish.yml workflow is complete and ready for first use. Before the first tag push can publish to PyPI, the user must register a pending trusted publisher on PyPI. This cannot be automated -- PyPI requires browser login with account credentials.

Steps for the user:
1. Log in to https://pypi.org
2. Navigate to Account Settings > Publishing (https://pypi.org/manage/account/publishing/)
3. Under "Add a new pending publisher", fill in:
   - PyPI project name: `quiverdb`
   - Owner: your GitHub username or organization
   - Repository name: `quiver2`
   - Workflow name: `publish.yml`
   - Environment name: `pypi`
4. Click "Add"
5. The pending publisher will convert to a real publisher on first successful upload

Resume signal: Type "registered" when the pending publisher is configured on PyPI, or describe any issues.
  </action>
  <verify>User confirms they have registered the pending publisher on PyPI with matching workflow name (publish.yml) and environment name (pypi)</verify>
  <done>Pending trusted publisher registered on PyPI for quiverdb, matching the publish.yml workflow and pypi environment</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `.github/workflows/publish.yml` exists and is valid YAML
2. Workflow triggers on `v*.*.*` tag pushes only
3. Workflow builds wheels fresh (not from build-wheels.yml artifacts)
4. Tag-vs-pyproject.toml version validation present
5. Wheel count validation expects exactly 2
6. GitHub Release uses auto-generated notes and attaches wheels
7. PyPI publish uses OIDC (`id-token: write`) with `environment: pypi`
8. No API tokens or secrets referenced anywhere in the workflow
9. PyPI trusted publisher registered (human verified)
</verification>

<success_criteria>
- `publish.yml` is syntactically valid and follows the exact job structure from research
- All locked decisions from CONTEXT.md are implemented (tag format, separate workflow, fresh builds, no sdist, auto-release, no approval gate, validations, no retry)
- Ready for first publish: push a `v0.5.0` tag to trigger the full pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/04-pypi-publishing/04-01-SUMMARY.md`
</output>
