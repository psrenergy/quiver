---
phase: 01-python-kwargs-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bindings/python/src/quiverdb/__init__.py
  - bindings/python/src/quiverdb/database.py
  - bindings/python/tests/conftest.py
  - bindings/python/tests/test_element.py
  - bindings/python/tests/test_database_create.py
  - bindings/python/tests/test_database_update.py
  - bindings/python/tests/test_database_delete.py
autonomous: true
requirements:
  - PYAPI-01
  - PYAPI-02
  - PYAPI-03
must_haves:
  truths:
    - "db.create_element('Collection', label='x', value=42) persists the element and returns an integer ID"
    - "db.update_element('Collection', id, label='y') updates the element's attributes"
    - "'from quiverdb import Element' raises ImportError"
    - "Element is still importable internally via 'from quiverdb.element import Element'"
    - "test_database_create.py, test_database_update.py, test_database_delete.py pass with kwargs API"
  artifacts:
    - path: "bindings/python/src/quiverdb/database.py"
      provides: "kwargs-based create_element and update_element methods"
      contains: "def create_element(self, collection: str, **kwargs"
    - path: "bindings/python/src/quiverdb/__init__.py"
      provides: "Public API without Element"
      contains: "Database"
    - path: "bindings/python/tests/test_element.py"
      provides: "Element unit tests using internal import"
      contains: "from quiverdb.element import Element"
  key_links:
    - from: "bindings/python/src/quiverdb/database.py"
      to: "bindings/python/src/quiverdb/element.py"
      via: "internal import for kwargs-to-Element conversion"
      pattern: "from quiverdb\\.element import Element"
    - from: "bindings/python/src/quiverdb/__init__.py"
      to: "bindings/python/src/quiverdb/element.py"
      via: "Element NOT exported (removed from imports and __all__)"
      pattern: "Element.*not in.*__all__"
---

<objective>
Replace Python's Element builder pattern with kwargs-based create_element and update_element, remove Element from public API, and convert the three highest-volume test files.

Purpose: Establish the new kwargs API that aligns Python with Julia/Dart conventions. Core signature change plus the most complex test conversions (create, update, delete) in one plan.
Output: Working kwargs API, Element removed from public exports, 3 major test files converted.
</objective>

<execution_context>
@C:/Users/rsampaio/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rsampaio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-python-kwargs-api/01-CONTEXT.md
@.planning/phases/01-python-kwargs-api/01-RESEARCH.md

<interfaces>
<!-- Current create_element/update_element signatures in database.py (lines 114-135) -->
```python
def create_element(self, collection: str, element) -> int:
    """Create a new element. Returns the new element ID."""
    self._ensure_open()
    lib = get_lib()
    out_id = ffi.new("int64_t*")
    check(
        lib.quiver_database_create_element(
            self._ptr,
            collection.encode("utf-8"),
            element._ptr,
            out_id,
        )
    )
    return out_id[0]

def update_element(self, collection: str, id: int, element) -> None:
    """Update an existing element's scalar attributes."""
    self._ensure_open()
    lib = get_lib()
    check(lib.quiver_database_update_element(self._ptr, collection.encode("utf-8"), id, element._ptr))
```

<!-- Current __init__.py exports -->
```python
from quiverdb.element import Element
# Element is in __all__
```

<!-- Current conftest.py import (line 8) -->
```python
from quiverdb import Database, Element
```

<!-- Element.set() method signature (element.py) — used internally -->
```python
def set(self, name: str, value) -> Element:
    # Handles: str, int, float, bool->int, None, list[str], list[int], list[float]
```

<!-- Element.destroy() method — must be called in finally block -->
```python
def destroy(self) -> None:
    lib = get_lib()
    lib.quiver_element_destroy(self._ptr)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace create_element/update_element signatures with kwargs, remove Element from public API</name>
  <files>
    bindings/python/src/quiverdb/database.py
    bindings/python/src/quiverdb/__init__.py
    bindings/python/tests/conftest.py
    bindings/python/tests/test_element.py
  </files>
  <action>
**database.py:**

1. Add import at top of file: `from quiverdb.element import Element`

2. Replace `create_element` method (lines 114-127) with kwargs version:
```python
def create_element(self, collection: str, **kwargs: object) -> int:
    """Create a new element. Returns the new element ID."""
    self._ensure_open()
    elem = Element()
    try:
        for name, value in kwargs.items():
            elem.set(name, value)
        lib = get_lib()
        out_id = ffi.new("int64_t*")
        check(
            lib.quiver_database_create_element(
                self._ptr,
                collection.encode("utf-8"),
                elem._ptr,
                out_id,
            )
        )
        return out_id[0]
    finally:
        elem.destroy()
```

3. Replace `update_element` method (lines 131-135) with kwargs version:
```python
def update_element(self, collection: str, id: int, **kwargs: object) -> None:
    """Update an existing element's attributes."""
    self._ensure_open()
    elem = Element()
    try:
        for name, value in kwargs.items():
            elem.set(name, value)
        lib = get_lib()
        check(
            lib.quiver_database_update_element(
                self._ptr,
                collection.encode("utf-8"),
                id,
                elem._ptr,
            )
        )
    finally:
        elem.destroy()
```

**__init__.py:**

1. Remove `from quiverdb.element import Element` import line
2. Remove `"Element"` from `__all__` list
3. Keep `"GroupMetadata"` in `__all__` (do not accidentally remove it)

Final `__init__.py` should be:
```python
from quiverdb.database import Database
from quiverdb.database_csv_export import DatabaseCSVExport
from quiverdb.database_csv_import import DatabaseCSVImport
from quiverdb.exceptions import QuiverError
from quiverdb.metadata import CSVOptions, GroupMetadata, ScalarMetadata

__all__ = [
    "CSVOptions",
    "Database",
    "DatabaseCSVExport",
    "DatabaseCSVImport",
    "GroupMetadata",
    "QuiverError",
    "ScalarMetadata",
    "version",
]
```

**conftest.py:**

1. Change line 8 from `from quiverdb import Database, Element` to `from quiverdb import Database`
(Element is not used in any fixture — it was an unused import)

**test_element.py:**

1. Change import from `from quiverdb import Element` to `from quiverdb.element import Element`
2. Add a new test at the end of the file:
```python
def test_element_not_in_public_api() -> None:
    """Element is not importable from quiverdb public API."""
    with pytest.raises(ImportError):
        from quiverdb import Element  # noqa: F401
```
(Make sure `import pytest` is present at the top)
  </action>
  <verify>
    <automated>cd C:/Development/DatabaseTmp/quiver2 && python -c "from quiverdb import Database; print('OK')" && python -c "try:\n from quiverdb import Element\n print('FAIL: Element should not be importable')\n exit(1)\nexcept ImportError:\n print('OK: Element not in public API')" && python -m pytest bindings/python/tests/test_element.py -x -v</automated>
  </verify>
  <done>
    - `from quiverdb import Database` works
    - `from quiverdb import Element` raises ImportError
    - `from quiverdb.element import Element` works
    - test_element.py passes including the new ImportError test
    - database.py has kwargs-based create_element and update_element
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert test_database_create.py, test_database_update.py, test_database_delete.py to kwargs API</name>
  <files>
    bindings/python/tests/test_database_create.py
    bindings/python/tests/test_database_update.py
    bindings/python/tests/test_database_delete.py
  </files>
  <action>
Convert all Element() usage in these three test files to kwargs syntax. These files have the highest Element counts (~48, ~59, ~8 occurrences respectively).

**Conversion rules (mechanical, apply to all three files):**

1. Remove `from quiverdb import ... Element` from imports (keep Database and other imports)

2. Chained pattern:
```python
# BEFORE:
db.create_element("Collection", Element().set("label", "Item1").set("some_integer", 42))
# AFTER:
db.create_element("Collection", label="Item1", some_integer=42)
```

3. Multi-line chained pattern:
```python
# BEFORE:
db.create_element(
    "Child",
    Element()
    .set("label", "Child 1")
    .set("parent_id", "Parent 1"),
)
# AFTER:
db.create_element(
    "Child",
    label="Child 1",
    parent_id="Parent 1",
)
```

4. Update element pattern:
```python
# BEFORE:
db.update_element("Collection", elem_id, Element().set("some_integer", 99))
# AFTER:
db.update_element("Collection", elem_id, some_integer=99)
```

5. Lists stay as-is in kwargs:
```python
# BEFORE:
Element().set("tags", ["a", "b"])
# AFTER:
tags=["a", "b"]
```

6. None values:
```python
# BEFORE:
Element().set("value", None)
# AFTER:
value=None
```

7. Add one test for dict unpacking in test_database_create.py:
```python
def test_create_element_with_dict_unpacking(self, collections_db: Database) -> None:
    """Verify **dict unpacking works with create_element."""
    collections_db.create_element("Configuration", label="cfg")
    attrs = {"label": "Item1", "some_integer": 42}
    elem_id = collections_db.create_element("Collection", **attrs)
    value = collections_db.read_scalar_integer_by_id("Collection", "some_integer", elem_id)
    assert value == 42
```

**IMPORTANT:** Grep for ALL occurrences of `Element` in each file to ensure none are missed. This includes helper functions, not just test methods.
  </action>
  <verify>
    <automated>cd C:/Development/DatabaseTmp/quiver2 && python -m pytest bindings/python/tests/test_database_create.py bindings/python/tests/test_database_update.py bindings/python/tests/test_database_delete.py -x -v</automated>
  </verify>
  <done>
    - All three test files pass with no Element imports
    - No remaining `Element()` constructor calls in any of the three files
    - Dict unpacking test exists and passes in test_database_create.py
    - Same test names, same assertions, same structure — only call syntax changed
  </done>
</task>

</tasks>

<verification>
1. Run: `python -m pytest bindings/python/tests/test_element.py bindings/python/tests/test_database_create.py bindings/python/tests/test_database_update.py bindings/python/tests/test_database_delete.py -x -v`
   All tests pass.
2. Verify no `from quiverdb import Element` or `from quiverdb import ... Element` in any modified test file (grep check).
3. Verify `database.py` contains `from quiverdb.element import Element` (internal import).
4. Verify `__init__.py` does NOT contain `Element`.
</verification>

<success_criteria>
- kwargs-based create_element("Collection", label="x", value=42) works and persists correctly
- kwargs-based update_element("Collection", id, label="y") works and updates correctly
- Element removed from public API (ImportError on import)
- 3 major test files (create, update, delete) converted and passing
- Dict unpacking test passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-python-kwargs-api/01-01-SUMMARY.md`
</output>
