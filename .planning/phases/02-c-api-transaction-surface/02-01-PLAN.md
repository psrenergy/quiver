---
phase: 02-c-api-transaction-surface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - include/quiver/c/database.h
  - src/c/database_transaction.cpp
  - src/CMakeLists.txt
  - tests/test_c_api_database_transaction.cpp
  - tests/CMakeLists.txt
  - .planning/REQUIREMENTS.md
  - .planning/ROADMAP.md
autonomous: true
requirements:
  - CAPI-01
must_haves:
  truths:
    - "C API caller can call quiver_database_begin_transaction, perform writes, then quiver_database_commit"
    - "C API caller can call quiver_database_rollback to discard uncommitted writes"
    - "Error cases (double begin, commit without begin) return QUIVER_ERROR with descriptive message from quiver_get_last_error"
    - "C API caller can query transaction state via quiver_database_in_transaction with bool out-param"
  artifacts:
    - path: "src/c/database_transaction.cpp"
      provides: "4 C API transaction function implementations"
      contains: "quiver_database_begin_transaction"
    - path: "include/quiver/c/database.h"
      provides: "4 transaction function declarations"
      contains: "quiver_database_in_transaction"
    - path: "tests/test_c_api_database_transaction.cpp"
      provides: "C API transaction test suite"
      contains: "quiver_database_begin_transaction"
  key_links:
    - from: "src/c/database_transaction.cpp"
      to: "include/quiver/c/database.h"
      via: "function declarations match implementations"
      pattern: "quiver_database_begin_transaction|quiver_database_commit|quiver_database_rollback|quiver_database_in_transaction"
    - from: "src/c/database_transaction.cpp"
      to: "src/c/internal.h"
      via: "QUIVER_REQUIRE macro and quiver_database struct"
      pattern: "QUIVER_REQUIRE"
    - from: "tests/test_c_api_database_transaction.cpp"
      to: "src/c/database_transaction.cpp"
      via: "test calls C API functions"
      pattern: "quiver_database_begin_transaction"
---

<objective>
Expose C++ transaction control (begin_transaction, commit, rollback, in_transaction) as flat C API functions returning quiver_error_t, following established C API patterns.

Purpose: This is the FFI surface that language bindings (Phase 3: Julia, Dart, Lua) will call. Without these C functions, no binding can expose transaction control.
Output: 4 new C API functions, test suite, updated traceability docs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-c-transaction-core/01-01-SUMMARY.md
@.planning/phases/02-c-api-transaction-surface/02-RESEARCH.md
@.planning/phases/02-c-api-transaction-surface/02-CONTEXT.md

# Key reference files for implementation patterns
@src/c/internal.h
@src/c/database.cpp
@include/quiver/c/database.h
@include/quiver/c/common.h
@src/CMakeLists.txt
@tests/CMakeLists.txt
@tests/test_c_api_database_create.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement C API transaction functions</name>
  <files>
    include/quiver/c/database.h
    src/c/database_transaction.cpp
    src/CMakeLists.txt
  </files>
  <action>
**1. Add declarations to `include/quiver/c/database.h`**

Insert a "Transaction control" section after the "Database lifecycle" block (after `quiver_database_path` on line 47, before the "// Version" comment on line 49). Add these 4 declarations:

```c
// Transaction control
QUIVER_C_API quiver_error_t quiver_database_begin_transaction(quiver_database_t* db);
QUIVER_C_API quiver_error_t quiver_database_commit(quiver_database_t* db);
QUIVER_C_API quiver_error_t quiver_database_rollback(quiver_database_t* db);
QUIVER_C_API quiver_error_t quiver_database_in_transaction(quiver_database_t* db, bool* out_active);
```

Note: `bool` is not currently included via `common.h` (which only includes `stddef.h` and `stdint.h`). Since all C API source files compile as C++ where `bool` is built-in, and the header is wrapped in `extern "C"`, `bool` works without additional includes. If a pure-C consumer needs this header in the future, `stdbool.h` would be needed -- but that is out of scope for this phase.

**2. Create `src/c/database_transaction.cpp`**

New file with 4 function implementations. Follow the exact pattern from `src/c/database.cpp` (e.g., `quiver_database_describe`, `quiver_database_close`):

- `quiver_database_begin_transaction`: QUIVER_REQUIRE(db), try-catch wrapping `db->db.begin_transaction()`, return QUIVER_OK/QUIVER_ERROR.
- `quiver_database_commit`: Same pattern wrapping `db->db.commit()`.
- `quiver_database_rollback`: Same pattern wrapping `db->db.rollback()`.
- `quiver_database_in_transaction`: QUIVER_REQUIRE(db, out_active), direct assignment `*out_active = db->db.in_transaction()`, return QUIVER_OK. No try-catch needed -- `in_transaction()` calls `sqlite3_get_autocommit()` which cannot throw.

Include `"internal.h"` and `"quiver/c/database.h"`. Wrap in `extern "C" { }`. Use `QUIVER_C_API` on all functions.

The verbatim implementation is in 02-RESEARCH.md "Code Examples" section -- use it directly.

**3. Register in `src/CMakeLists.txt`**

Add `c/database_transaction.cpp` to the `quiver_c` SHARED library target (after `c/database_relations.cpp`, around line 103):

```cmake
        c/database_transaction.cpp
```
  </action>
  <verify>
Run `cmake --build build --config Debug` and confirm:
1. No compilation errors
2. No linker errors (all 4 symbols exported from quiver_c)
  </verify>
  <done>
4 C API transaction functions compile and link into quiver_c.dll. Header declares all 4 functions. Source file follows established QUIVER_REQUIRE + try-catch pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add transaction tests and update traceability docs</name>
  <files>
    tests/test_c_api_database_transaction.cpp
    tests/CMakeLists.txt
    .planning/REQUIREMENTS.md
    .planning/ROADMAP.md
  </files>
  <action>
**1. Create `tests/test_c_api_database_transaction.cpp`**

New GoogleTest file following the pattern from `tests/test_c_api_database_create.cpp`. Include `test_utils.h`, `quiver/c/database.h`, `quiver/c/element.h`, `gtest/gtest.h`. Use `VALID_SCHEMA("collections.sql")` (same schema as C++ transaction tests).

Write these test cases (lean -- C++ tests already cover transaction logic):

a) **`TransactionBeginMultipleWritesCommit`** -- Mirrors roadmap success criterion 2. Open :memory: db with `collections.sql`. Create Configuration element. Begin transaction, create two Collection elements, commit. Read back labels via `quiver_database_read_scalar_strings` and verify count=2 with correct values. Free string array. Close db.

b) **`TransactionRollbackDiscardsWrites`** -- Begin transaction, create element, rollback. Read back labels and verify count=0 (or the collection has no elements beyond Configuration). Close db.

c) **`TransactionDoubleBeginReturnsError`** -- Mirrors success criterion 3. Begin transaction, begin again -- expect QUIVER_ERROR. Check `quiver_get_last_error()` contains "Cannot begin_transaction". Rollback to clean up. Close db.

d) **`TransactionCommitWithoutBeginReturnsError`** -- Commit without begin -- expect QUIVER_ERROR. Check error message contains "Cannot commit". Close db.

e) **`TransactionRollbackWithoutBeginReturnsError`** -- Rollback without begin -- expect QUIVER_ERROR. Check error message contains "Cannot rollback". Close db.

f) **`InTransactionReflectsState`** -- Mirrors success criterion 4 (added per user decision). Query in_transaction before begin (expect false), after begin (expect true), after commit (expect false). Uses `bool active` out-param. Close db.

All tests use `auto options = quiver_database_options_default(); options.console_level = QUIVER_LOG_OFF;` for setup. All tests close the database handle at the end.

**2. Register in `tests/CMakeLists.txt`**

Add `test_c_api_database_transaction.cpp` to the `quiver_c_tests` executable (after `test_c_api_database_update.cpp`, around line 53):

```cmake
        test_c_api_database_transaction.cpp
```

**3. Update `.planning/REQUIREMENTS.md`**

- Move TQRY-01 from "Future Requirements" section into the "C API" section under a note that it is covered by CAPI-01 scope. Mark it with `[ ]` (still pending until phase completes, or `[x]` if the executor marks it after tests pass).
- Update the traceability table: add a row `| TQRY-01 | Phase 2 | Pending |`.
- Update coverage count (12 total, 12 mapped).

**4. Update `.planning/ROADMAP.md`**

- In Phase 2 success criteria, add criterion 4: "`quiver_database_in_transaction` returns transaction state via `bool* out_active` out-param"
- Update Phase 2 Plans section: `**Plans**: 1 plan` and replace TBD list with `- [ ] 02-01-PLAN.md -- Implement C API transaction functions and tests`
- In Phase 3 success criteria, add a note that `in_transaction` should also be bound (per user decision).
  </action>
  <verify>
Run full build and test:
```bash
cmake --build build --config Debug && ./build/bin/quiver_c_tests.exe --gtest_filter="*Transaction*"
```
Confirm:
1. All 6 transaction test cases pass
2. No regressions: `./build/bin/quiver_c_tests.exe` (all tests pass)
3. No regressions: `./build/bin/quiver_tests.exe` (all C++ tests still pass)
  </verify>
  <done>
6 C API transaction tests pass. REQUIREMENTS.md reflects TQRY-01 in Phase 2 scope. ROADMAP.md has updated success criteria including in_transaction and correct plan list. All existing tests continue passing.
  </done>
</task>

</tasks>

<verification>
1. `cmake --build build --config Debug` -- clean build with no errors
2. `./build/bin/quiver_c_tests.exe` -- all C API tests pass (existing + 6 new transaction tests)
3. `./build/bin/quiver_tests.exe` -- all C++ tests pass (no regressions)
4. Grep `include/quiver/c/database.h` for `begin_transaction`, `commit`, `rollback`, `in_transaction` -- all 4 declared
5. Grep `src/c/database_transaction.cpp` for same 4 function names -- all 4 implemented
6. `.planning/REQUIREMENTS.md` shows TQRY-01 in Phase 2 scope
7. `.planning/ROADMAP.md` Phase 2 has 4 success criteria and correct plan list
</verification>

<success_criteria>
- 4 C API functions exist and are callable: begin_transaction, commit, rollback, in_transaction
- Batched writes through C API with commit produce persistent data (readback verification)
- Error cases return QUIVER_ERROR with descriptive messages from quiver_get_last_error()
- in_transaction correctly reflects state (false -> true -> false around begin/commit)
- All existing C++ and C API tests continue to pass
- REQUIREMENTS.md and ROADMAP.md traceability updated
</success_criteria>

<output>
After completion, create `.planning/phases/02-c-api-transaction-surface/02-01-SUMMARY.md`
</output>
