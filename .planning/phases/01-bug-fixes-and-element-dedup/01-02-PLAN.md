---
phase: 01-bug-fixes-and-element-dedup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/database_impl.h
  - src/database_create.cpp
  - src/database_update.cpp
  - tests/test_database_update.cpp
  - tests/test_database_create.cpp
autonomous: true
requirements: [BUG-01, QUAL-03]

must_haves:
  truths:
    - "update_element with mismatched array types (e.g., strings to integer vector) throws a type validation error"
    - "create_element with empty arrays skips silently instead of throwing"
    - "update_element with empty arrays clears existing group rows"
    - "create_element and update_element produce identical error messages for the same type mismatch"
    - "Both methods call the same shared helper for group insertion -- no duplicated routing/validation/insertion logic"
  artifacts:
    - path: "src/database_impl.h"
      provides: "insert_group_data helper method on Database::Impl"
      contains: "insert_group_data"
    - path: "src/database_create.cpp"
      provides: "create_element calling shared helper"
      contains: "insert_group_data"
    - path: "src/database_update.cpp"
      provides: "update_element calling shared helper"
      contains: "insert_group_data"
    - path: "tests/test_database_update.cpp"
      provides: "Regression tests for type validation in update_element"
  key_links:
    - from: "src/database_create.cpp"
      to: "src/database_impl.h"
      via: "impl_->insert_group_data call"
      pattern: "impl_->insert_group_data"
    - from: "src/database_update.cpp"
      to: "src/database_impl.h"
      via: "impl_->insert_group_data call"
      pattern: "impl_->insert_group_data"
    - from: "src/database_impl.h"
      to: "type_validator.h"
      via: "validate_array calls inside helper"
      pattern: "type_validator->validate_array"
---

<objective>
Extract a shared group insertion helper (`insert_group_data`) on `Database::Impl` that handles routing arrays to vector/set/time series tables, type validation, optional DELETE, and row insertion. Replace the duplicated logic in both `create_element` and `update_element` with calls to this helper. This automatically fixes BUG-01 (missing `validate_array` in update path).

Purpose: Eliminate ~120 lines of duplicated code, ensure type validation consistency between create and update operations.
Output: Single group insertion code path, type validation in update_element, regression tests.
</objective>

<execution_context>
@C:/Users/rsampaio/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rsampaio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-bug-fixes-and-element-dedup/01-CONTEXT.md

<interfaces>
<!-- Key types and contracts the executor needs. -->

From src/database_impl.h:
```cpp
struct ResolvedElement {
    std::map<std::string, Value> scalars;
    std::map<std::string, std::vector<Value>> arrays;
};

struct Database::Impl {
    sqlite3* db = nullptr;
    std::string path;
    std::shared_ptr<spdlog::logger> logger;
    std::unique_ptr<Schema> schema;
    std::unique_ptr<TypeValidator> type_validator;

    void require_collection(const std::string& collection, const char* operation) const;
    ResolvedElement resolve_element_fk_labels(const std::string& collection, const Element& element, Database& db);
    class TransactionGuard { /* nest-aware RAII */ };
    // NOTE: insert_group_data helper needs to be ADDED here
};
```

From include/quiver/schema.h:
```cpp
enum class GroupTableType { Vector, Set, TimeSeries };
struct TableDefinition {
    std::string name;
    std::map<std::string, ColumnDefinition> columns;
    // ...
};
class Schema {
    std::vector<TableMatch> find_all_tables_for_column(const std::string& collection, const std::string& column) const;
    const TableDefinition* get_table(const std::string& name) const;
};
```

From include/quiver/type_validator.h:
```cpp
class TypeValidator {
    void validate_array(const std::string& table, const std::string& column, const std::vector<Value>& values);
};
```

From src/database_create.cpp (lines 48-197, the logic to extract):
- Lines 52-56: Build routing maps (vector_table_columns, set_table_columns, time_series_table_columns)
- Lines 58-86: Route each array to its target table via find_all_tables_for_column
- Lines 88-124: Vector insertion with validate_array + vector_index
- Lines 126-160: Set insertion with validate_array
- Lines 162-197: Time series insertion with validate_array

From src/database_update.cpp (lines 49-166, the duplicated logic):
- Lines 50-78: Route arrays (identical logic, but no empty-array check)
- Lines 80-108: Vector insertion WITHOUT validate_array (BUG-01)
- Lines 110-137: Set insertion WITHOUT validate_array (BUG-01)
- Lines 139-166: Time series insertion WITHOUT validate_array (BUG-01)
- Key difference: update does DELETE FROM table WHERE id = ? before insertion
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Extract insert_group_data helper and refactor create_element / update_element</name>
  <files>src/database_impl.h, src/database_create.cpp, src/database_update.cpp, tests/test_database_update.cpp, tests/test_database_create.cpp</files>
  <behavior>
- Test: update_element with string values in an integer vector column throws runtime_error with "Cannot update_element:" prefix
- Test: update_element with integer values in a text set column throws runtime_error with "Cannot update_element:" prefix
- Test: create_element with empty array skips silently (element created, no group rows) -- behavior change from current throw
- Test: update_element with empty array clears existing group rows (DELETE executed, no INSERT)
- Test: create_element type mismatch error message says "Cannot create_element:" (not "Cannot update_element:")
- Test: existing create_element and update_element tests continue to pass unchanged
  </behavior>
  <action>
**Step 1: Add `insert_group_data` to `Database::Impl` in `src/database_impl.h`**

Add the helper method inside `struct Database::Impl`, after the `resolve_element_fk_labels` method and before `load_schema_metadata`. The helper is an inline method (consistent with existing Impl methods like `resolve_fk_label`, `resolve_element_fk_labels`).

Signature (per CONTEXT.md locked decisions):
```cpp
void insert_group_data(
    const char* caller,                                           // "create_element" or "update_element"
    const std::string& collection,
    int64_t element_id,
    const std::map<std::string, std::vector<Value>>& arrays,
    bool delete_existing,                                         // true for update, false for create
    Database& db
)
```

Implementation must:

1. **Route arrays to tables** (extracted from both methods, lines ~52-86):
   - Build three maps: `vector_table_columns`, `set_table_columns`, `time_series_table_columns`
   - For each `[array_name, values]` in `arrays`:
     - If `values.empty()` AND `!delete_existing` (create): `continue` (skip silently, per CONTEXT decision -- this changes current behavior from throwing)
     - If `values.empty()` AND `delete_existing` (update): still route the array to its table (so DELETE happens below), but don't validate types
     - Call `schema->find_all_tables_for_column(collection, array_name)` -- throw if `matches.empty()` using `"Cannot " + std::string(caller) + ": array '" + array_name + "' does not match any vector, set, or time series table in collection '" + collection + "'"`
     - Route to maps via `match.type` switch

2. **Process vector tables** (extracted from create lines 88-124):
   - If `delete_existing`: `db.execute("DELETE FROM " + table + " WHERE id = ?", {element_id})`
   - For non-empty columns: validate types via `type_validator->validate_array(table, col_name, *values_ptr)`, verify same-length arrays, insert rows with `vector_index`
   - If all columns were empty (delete_existing case): just the DELETE happened, no INSERT

3. **Process set tables** (extracted from create lines 126-160):
   - Same pattern as vectors but no `vector_index` column

4. **Process time series tables** (extracted from create lines 162-197):
   - Same pattern as sets (no `vector_index`)

Error messages MUST use the `caller` parameter: `"Cannot " + std::string(caller) + ": ..."`. Do NOT branch on caller for behavior -- use `delete_existing` boolean only.

**Step 2: Refactor `create_element` in `src/database_create.cpp`**

Replace lines 48-197 (everything after `execute(sql, params)` / getting `element_id`, before `txn.commit()`) with a single call:
```cpp
impl_->insert_group_data("create_element", collection, element_id, resolved.arrays, false, *this);
```

The method should go from ~200 lines to ~50 lines. Remove the empty-array throw at line 60 (now handled by helper skipping silently). Remove the routing maps, the for-loops for vector/set/time series insertion, and the `validate_array` calls -- all moved to helper.

**Step 3: Refactor `update_element` in `src/database_update.cpp`**

Replace lines 49-166 (everything after scalar UPDATE, before `txn.commit()`) with a single call:
```cpp
impl_->insert_group_data("update_element", collection, id, resolved.arrays, true, *this);
```

The method should go from ~170 lines to ~50 lines. Remove the routing maps, DELETE+INSERT loops -- all moved to helper.

**Step 4: Add regression tests in `tests/test_database_update.cpp`**

Add tests for BUG-01 (type validation in update_element):
1. Create an element with valid integer vector data, then try to update with string values in the same vector column. Assert `std::runtime_error` is thrown with message containing "Cannot update_element:".
2. Create an element with valid text set data, then try to update with integer values in the same set column. Assert throw.

Use an existing test schema that has both vector and set tables (e.g., the schema used by other update tests in the file).

**Step 5: Add empty-array behavior tests**

In `tests/test_database_create.cpp`:
- Test that creating an element with an empty vector array succeeds (element created, no vector rows). This verifies the behavior change from "throw" to "skip silently".

In `tests/test_database_update.cpp`:
- Test that updating an element with an empty vector array clears existing rows. Create element with vector data, update with empty array for same attribute, verify vector reads return empty.
  </action>
  <verify>
    <automated>cmake --build build --config Debug && ./build/bin/quiver_tests.exe --gtest_filter="*update*:*create*" 2>&1</automated>
  </verify>
  <done>
- `insert_group_data` helper exists on `Database::Impl` with caller-parameterized error messages
- `create_element` delegates group insertion to helper (no inline routing/validation/insertion code)
- `update_element` delegates group insertion to helper (no inline routing/validation/insertion code)
- `update_element` validates array types via `validate_array` (BUG-01 fixed)
- Empty arrays: create skips silently, update clears rows (per CONTEXT decisions)
- Error messages use correct method prefix ("Cannot create_element:" vs "Cannot update_element:")
- All existing tests pass
  </done>
</task>

</tasks>

<verification>
```bash
# Build everything and run all C++ tests
cmake --build build --config Debug && ./build/bin/quiver_tests.exe

# Run C API tests (should pass unchanged since C API is thin wrapper)
./build/bin/quiver_c_tests.exe

# Verify no duplicated insertion logic remains
grep -c "INSERT INTO.*vector_index" src/database_create.cpp  # Should be 0
grep -c "INSERT INTO.*vector_index" src/database_update.cpp  # Should be 0
grep -c "INSERT INTO.*vector_index" src/database_impl.h      # Should be >= 1

# Verify validate_array is in the shared path
grep -c "validate_array" src/database_impl.h  # Should be >= 1
grep -c "validate_array" src/database_create.cpp  # Should be 0 (moved to helper)
grep -c "validate_array" src/database_update.cpp  # Should be 0 (moved to helper)

# Verify helper is called from both methods
grep "insert_group_data" src/database_create.cpp  # Should match
grep "insert_group_data" src/database_update.cpp  # Should match
```
</verification>

<success_criteria>
- BUG-01: `update_element` with type-mismatched arrays throws validation error
- QUAL-03: Single `insert_group_data` helper on `Database::Impl` handles all group insertion for both create and update
- No duplicated routing/validation/insertion code in `database_create.cpp` or `database_update.cpp`
- Empty array semantics: create skips silently, update clears rows
- Error messages use caller-specific prefixes
- All C++ and C API tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-bug-fixes-and-element-dedup/01-02-SUMMARY.md`
</output>
