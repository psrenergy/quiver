---
phase: 02-free-function-naming
plan: 03
type: execute
wave: 3
depends_on:
  - "02-02"
files_modified:
  - bindings/dart/ffigen.yaml
  - bindings/dart/lib/src/ffi/bindings.dart
autonomous: true
requirements:
  - NAME-01
  - NAME-02
gap_closure: true
must_haves:
  truths:
    - "bindings/dart/ffigen.yaml lists options.h in both entry-points and include-directives"
    - "Generated bindings.dart contains quiver_database_options_default and quiver_csv_options_default function bindings"
    - "Dart test suite compiles and passes"
  artifacts:
    - path: "bindings/dart/ffigen.yaml"
      provides: "Dart ffigen configuration with options.h included"
      contains: "options.h"
    - path: "bindings/dart/lib/src/ffi/bindings.dart"
      provides: "Regenerated Dart FFI bindings with options factory functions"
      contains: "quiver_database_options_default"
  key_links:
    - from: "bindings/dart/lib/src/database.dart"
      to: "bindings/dart/lib/src/ffi/bindings.dart"
      via: "bindings.quiver_database_options_default() call"
      pattern: "quiver_database_options_default"
---

<objective>
Fix the Dart generator configuration to include `options.h`, regenerate Dart FFI bindings, and verify Dart tests pass.

Purpose: Close the single remaining gap blocking Phase 2 completion. The Dart ffigen.yaml omits `include/quiver/c/options.h` from its entry-points and include-directives. While `database.h` includes `options.h` (so types are picked up), the function declarations `quiver_database_options_default()` and `quiver_csv_options_default()` are not emitted into `bindings.dart`. The hand-written `database.dart` calls these functions, causing a compile error.

Output: Updated `ffigen.yaml`, regenerated `bindings.dart` with options factory functions, Dart tests passing.
</objective>

<execution_context>
@C:/Users/rsampaio/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rsampaio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-free-function-naming/02-VERIFICATION.md

<interfaces>
<!-- Current bindings/dart/ffigen.yaml (missing options.h): -->
```yaml
headers:
  entry-points:
    - '../../include/quiver/c/common.h'
    - '../../include/quiver/c/database.h'
    - '../../include/quiver/c/element.h'
    - '../../include/quiver/c/lua_runner.h'
  include-directives:
    - '../../include/quiver/c/common.h'
    - '../../include/quiver/c/database.h'
    - '../../include/quiver/c/element.h'
    - '../../include/quiver/c/lua_runner.h'
```

<!-- Hand-written database.dart calls (lines 40, 65): -->
```dart
optionsPtr.ref = bindings.quiver_database_options_default();
```

<!-- C header include/quiver/c/options.h declares: -->
```c
QUIVER_C_API quiver_database_options_t quiver_database_options_default(void);
QUIVER_C_API quiver_csv_options_t quiver_csv_options_default(void);
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add options.h to Dart ffigen.yaml and regenerate bindings</name>
  <files>
    bindings/dart/ffigen.yaml
    bindings/dart/lib/src/ffi/bindings.dart
  </files>
  <action>
**bindings/dart/ffigen.yaml** -- Add `options.h` to both `entry-points` and `include-directives` lists. Insert it between `common.h` and `database.h` to maintain alphabetical order within the quiver/c/ namespace:

```yaml
headers:
  entry-points:
    - '../../include/quiver/c/common.h'
    - '../../include/quiver/c/options.h'
    - '../../include/quiver/c/database.h'
    - '../../include/quiver/c/element.h'
    - '../../include/quiver/c/lua_runner.h'
  include-directives:
    - '../../include/quiver/c/common.h'
    - '../../include/quiver/c/options.h'
    - '../../include/quiver/c/database.h'
    - '../../include/quiver/c/element.h'
    - '../../include/quiver/c/lua_runner.h'
```

**Regenerate Dart FFI bindings:**

```bash
bindings/dart/generator/generator.bat
```

**Verify the generated output** in `bindings/dart/lib/src/ffi/bindings.dart`:

1. Search for `quiver_database_options_default` -- must be present as a function binding.
2. Search for `quiver_csv_options_default` -- must be present as a function binding.
3. Search for `quiver_database_free_string` -- must still be present (sanity check from prior plans).
4. Search for `quiver_element_free_string` -- must NOT be present (sanity check from prior plans).

If the generator fails, ensure the C++ library is already built (`cmake --build build --config Debug`) and retry.

**Run Dart tests:**

```bash
bindings/dart/test/test.bat
```

Dart tests must compile and pass. This was the only suite that failed in verification.
  </action>
  <verify>
    <automated>bindings/dart/test/test.bat 2>&1 | tail -10</automated>
  </verify>
  <done>ffigen.yaml includes options.h. Generated bindings.dart contains quiver_database_options_default and quiver_csv_options_default. Dart test suite compiles and passes. Phase 2 success criterion 4 ("all five test suites pass") is now fully satisfied.</done>
</task>

</tasks>

<verification>
1. `grep "options.h" bindings/dart/ffigen.yaml` returns matches in both entry-points and include-directives
2. `grep "quiver_database_options_default" bindings/dart/lib/src/ffi/bindings.dart` returns a match
3. `grep "quiver_csv_options_default" bindings/dart/lib/src/ffi/bindings.dart` returns a match
4. `bindings/dart/test/test.bat` -- Dart tests compile and pass
</verification>

<success_criteria>
- `bindings/dart/ffigen.yaml` includes `options.h` in both entry-points and include-directives
- `bindings/dart/lib/src/ffi/bindings.dart` contains `quiver_database_options_default` and `quiver_csv_options_default`
- `bindings/dart/test/test.bat` passes all tests
</success_criteria>

<output>
After completion, create `.planning/phases/02-free-function-naming/02-03-SUMMARY.md`
</output>
