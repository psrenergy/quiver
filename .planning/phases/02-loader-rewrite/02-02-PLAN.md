---
phase: 02-loader-rewrite
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - scripts/test-wheel-install.bat
  - scripts/validate_wheel_install.py
autonomous: false
requirements: [LOAD-01, LOAD-02, LOAD-03]

must_haves:
  truths:
    - "Installing the wheel in a clean venv and running import quiverdb succeeds without PATH setup"
    - "The bundled _libs/ discovery path is used (not dev-mode fallback)"
    - "The full test suite passes against the wheel-installed package"
    - "os.add_dll_directory was called (verified via _load_source == 'bundled' on Windows)"
  artifacts:
    - path: "scripts/test-wheel-install.bat"
      provides: "End-to-end wheel install validation script"
      contains: "uv venv"
    - path: "scripts/validate_wheel_install.py"
      provides: "Python validation script checking import, _load_source, and test execution"
      contains: "_load_source"
  key_links:
    - from: "scripts/test-wheel-install.bat"
      to: "bindings/python/src/quiverdb/_loader.py"
      via: "Installs wheel then imports quiverdb to exercise bundled discovery"
      pattern: "import quiverdb"
---

<objective>
Validate the loader rewrite end-to-end by building a wheel, installing it in a clean virtual environment, and verifying `import quiverdb` loads bundled native libraries.

Purpose: Proves that LOAD-01/LOAD-02/LOAD-03 are satisfied in the actual wheel install scenario, not just dev mode.

Output: Validation scripts and user-confirmed successful wheel install test.
</objective>

<execution_context>
@C:/Users/rsampaio/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rsampaio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-loader-rewrite/02-CONTEXT.md
@.planning/phases/02-loader-rewrite/02-01-SUMMARY.md
@.planning/phases/01-build-system-migration/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create wheel install validation scripts</name>
  <files>
scripts/test-wheel-install.bat
scripts/validate_wheel_install.py
  </files>
  <action>
Create two files for end-to-end wheel install validation:

**`scripts/test-wheel-install.bat`:**
A batch script that:
1. Builds a wheel from `bindings/python/` using `uv build --wheel` (same approach as Phase 1's `test-wheel.bat`)
2. Creates a fresh temporary virtual environment using `uv venv` in a temp directory
3. Installs the built wheel into the clean venv using `uv pip install` (the wheel path from step 1)
4. Also installs `pytest` into the venv (needed for test execution)
5. Runs `scripts/validate_wheel_install.py` using the venv's Python to verify:
   - `import quiverdb` succeeds
   - `quiverdb._loader._load_source` equals `"bundled"` (not `"development"`)
   - `quiverdb.version()` returns a non-empty string (proves C API is callable)
6. Runs the full test suite (`bindings/python/tests/`) using the venv's pytest — but WITHOUT prepending `build/bin/` to PATH (the whole point is that bundled libs work without PATH setup)
7. Cleans up the temp venv directory
8. Reports pass/fail

Key: The venv must NOT have `build/bin/` in its PATH. This is what differentiates this test from the dev-mode `test.bat` — it proves bundled discovery works.

**`scripts/validate_wheel_install.py`:**
A Python script that:
1. Imports `quiverdb`
2. Checks `quiverdb._loader._load_source == "bundled"` — asserts this is the bundled path
3. Calls `quiverdb.version()` — asserts non-empty string returned
4. Prints diagnostic info: load source, version, `_libs` directory path, whether `_libs` exists
5. Exits 0 on success, 1 on any failure

The validation script must be self-contained (no pytest dependency) — it verifies the import path works before pytest is invoked.

Use the existing `scripts/test-wheel.bat` and `scripts/validate_wheel.py` from Phase 1 as style reference (same batch script patterns, same validation approach). The key difference is that Phase 1 validated wheel contents (zipfile inspection), while this validates runtime behavior (actual library loading).
  </action>
  <verify>
    <automated>cd C:/Development/DatabaseTmp/quiver2 && scripts/test-wheel-install.bat</automated>
    <manual>Script builds wheel, creates clean venv, installs wheel, verifies bundled loading, runs tests</manual>
    <sampling_rate>run after this task commits</sampling_rate>
  </verify>
  <done>
Validation scripts created. Running test-wheel-install.bat builds a wheel, installs it in a clean venv without PATH setup, and verifies that import quiverdb uses bundled _libs/ discovery.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: User verifies end-to-end wheel install validation</name>
  <files>scripts/test-wheel-install.bat</files>
  <action>
Human verification checkpoint. Claude automated the complete loader rewrite (Plan 01) and wheel install validation scripts (Task 1 above). The user must confirm:
- `import quiverdb` loads native libraries from `_libs/` inside the installed wheel
- `_load_source` is `"bundled"` (not `"development"`)
- `quiverdb.version()` returns a valid version string
- The full test suite passes against the wheel-installed package (without PATH setup)

**How to verify:**
1. Run `scripts/test-wheel-install.bat` from the project root
2. Observe that it builds a wheel, creates a clean venv, installs the wheel, reports `_load_source: bundled`, reports a valid version, and all tests pass
3. Confirm the output shows no PATH manipulation for DLL discovery

**Resume signal:** Type "approved" to confirm Phase 2 is complete, or describe any issues.
  </action>
  <verify>
    <automated>cd C:/Development/DatabaseTmp/quiver2 && scripts/test-wheel-install.bat</automated>
    <manual>User confirms wheel install validation passes end-to-end</manual>
  </verify>
  <done>User has approved the end-to-end wheel install validation, confirming Phase 2 loader rewrite is complete.</done>
</task>

</tasks>

<verification>
1. `scripts/test-wheel-install.bat` exists and is executable
2. `scripts/validate_wheel_install.py` exists
3. Running `test-wheel-install.bat` builds wheel, installs in clean venv, and reports success
4. `_load_source` is `"bundled"` in the wheel-installed environment
5. `quiverdb.version()` returns a non-empty string
6. Full test suite passes without `build/bin/` in PATH
</verification>

<success_criteria>
- Wheel installs in a clean venv and `import quiverdb` works without any PATH configuration
- `_load_source` confirms bundled discovery was used
- Full test suite passes against the wheel-installed package
- User approves the end-to-end validation
</success_criteria>

<output>
After completion, create `.planning/phases/02-loader-rewrite/02-02-SUMMARY.md`
</output>
