---
phase: 02-cpp-core-file-decomposition
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/database_internal.h
  - src/database.cpp
  - src/database_create.cpp
  - src/database_read.cpp
  - src/database_update.cpp
  - src/database_delete.cpp
  - src/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "database.cpp contains only lifecycle operations and is under 500 lines"
    - "create, read, update, delete operations each live in their own file"
    - "Shared helpers are in database_internal.h, not duplicated"
    - "All 385 C++ tests pass with zero behavior changes"
    - "No public header in include/quiver/ has changed"
  artifacts:
    - path: "src/database_internal.h"
      provides: "Shared helper functions for multi-file access"
      contains: "namespace quiver::internal"
    - path: "src/database_create.cpp"
      provides: "create_element implementation"
      contains: "Database::create_element"
    - path: "src/database_read.cpp"
      provides: "All read_scalar/vector/set/element_ids implementations"
      contains: "Database::read_scalar_integers"
    - path: "src/database_update.cpp"
      provides: "update_element and all update_scalar/vector/set implementations"
      contains: "Database::update_element"
    - path: "src/database_delete.cpp"
      provides: "delete_element_by_id implementation"
      contains: "Database::delete_element_by_id"
  key_links:
    - from: "src/database_create.cpp"
      to: "src/database_impl.h"
      via: "#include database_impl.h"
      pattern: '#include "database_impl.h"'
    - from: "src/database_read.cpp"
      to: "src/database_internal.h"
      via: "#include database_internal.h"
      pattern: '#include "database_internal.h"'
    - from: "src/CMakeLists.txt"
      to: "all new .cpp files"
      via: "QUIVER_SOURCES list"
      pattern: "database_create.cpp"
---

<objective>
Extract CRUD operations and shared helpers from the monolithic database.cpp into focused files, establishing the infrastructure and pattern for the full decomposition.

Purpose: This is the first of two plans splitting database.cpp. It creates the shared internal header and extracts the four CRUD operation categories (create, read, update, delete) -- the largest code volume (~665 lines). This establishes the pattern that Plan 02 follows for the remaining five categories.

Output: 5 new files (1 header + 4 .cpp), updated CMakeLists.txt, trimmed database.cpp
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cpp-core-file-decomposition/02-RESEARCH.md
@.planning/phases/01-cpp-impl-header-extraction/01-01-SUMMARY.md
@src/database.cpp
@src/database_impl.h
@src/CMakeLists.txt
@include/quiver/database.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database_internal.h with shared helpers</name>
  <files>src/database_internal.h</files>
  <action>
Create `src/database_internal.h` containing the five helper functions that are shared across multiple split files. These must be extracted from the anonymous namespace and `quiver` namespace in `database.cpp`.

**Header structure:**
- Include guard: `QUIVER_DATABASE_INTERNAL_H`
- Includes needed: `quiver/attribute_metadata.h`, `quiver/result.h`, `quiver/schema.h`, `<optional>`, `<stdexcept>`, `<string>`, `<vector>`
- All functions inside `namespace quiver::internal`

**Functions to extract (copy from database.cpp, adapt namespace qualifiers):**

1. `get_row_value` (3 overloads, lines 24-34) -- mark `inline`, change `quiver::Row` to just `Row` since we are inside `namespace quiver::internal`. These extract typed values from a Row by index.
   - `inline std::optional<int64_t> get_row_value(const Row& row, size_t index, int64_t*)`
   - `inline std::optional<double> get_row_value(const Row& row, size_t index, double*)`
   - `inline std::optional<std::string> get_row_value(const Row& row, size_t index, std::string*)`

2. `read_grouped_values_all<T>` (lines 38-59) -- template, inherently ODR-safe. Change `quiver::Result` to `Result`, change `get_row_value` calls (they resolve within the same namespace).

3. `read_grouped_values_by_id<T>` (lines 63-73) -- template, same treatment.

4. `find_dimension_column` (lines 143-152) -- mark `inline`, change `quiver::TableDefinition` to `TableDefinition`, `quiver::DataType` to `DataType`, `quiver::is_date_time_column` to `is_date_time_column`. This finds the dimension/ordering column in a time series table.

5. `scalar_metadata_from_column` (lines 158-160) -- mark `inline`. Currently `static` in `namespace quiver`. Move to `namespace quiver::internal`. Takes a `ColumnDefinition&` and returns `ScalarMetadata`.

**IMPORTANT:** Do NOT use anonymous namespace in this header. Use `namespace quiver::internal` with `inline` on all non-template functions to avoid ODR violations.
  </action>
  <verify>
File exists at `src/database_internal.h`. Confirm it has:
- Include guard
- All 5 helper groups (get_row_value x3, read_grouped_values_all, read_grouped_values_by_id, find_dimension_column, scalar_metadata_from_column)
- `namespace quiver::internal`
- `inline` on all non-template functions
  </verify>
  <done>database_internal.h exists with all shared helpers in quiver::internal namespace, ready for inclusion by split files</done>
</task>

<task type="auto">
  <name>Task 2: Extract CRUD operations into separate files and update build</name>
  <files>
    src/database_create.cpp
    src/database_read.cpp
    src/database_update.cpp
    src/database_delete.cpp
    src/database.cpp
    src/CMakeLists.txt
  </files>
  <action>
Extract four operation categories from `database.cpp` into new files. Each new file follows the same pattern: include `database_impl.h` first, optionally include `database_internal.h` if it uses shared helpers, wrap everything in `namespace quiver { ... }`.

**CRITICAL:** After extracting methods to new files, DELETE those methods from `database.cpp`. Also delete the anonymous-namespace helpers (lines 23-73: get_row_value x3, read_grouped_values_all, read_grouped_values_by_id) and the static `find_dimension_column` (lines 143-152) and `scalar_metadata_from_column` (lines 158-160) from database.cpp. The lifecycle-only helpers (g_logger_counter, sqlite3_init_flag, ensure_sqlite3_initialized, to_spdlog_level, create_database_logger) STAY in database.cpp.

**File 1: src/database_create.cpp** (~207 lines)
- Includes: `database_impl.h` (no internal header needed)
- Extract: `Database::create_element()` (currently at lines 436-642)
- This method uses `impl_->with_transaction`, `impl_->require_collection`, `impl_->type_validator`, `impl_->schema`, and calls `execute()`. All accessible via database_impl.h.

**File 2: src/database_read.cpp** (~185 lines)
- Includes: `database_impl.h`, `database_internal.h`
- Extract ALL read methods (lines 890-1074):
  - `read_scalar_integers`, `read_scalar_floats`, `read_scalar_strings` (lines 890-936)
  - `read_scalar_integer_by_id`, `read_scalar_float_by_id`, `read_scalar_string_by_id` (lines 938-972)
  - `read_vector_integers`, `read_vector_floats`, `read_vector_strings` (lines 974-996)
  - `read_vector_integers_by_id`, `read_vector_floats_by_id`, `read_vector_strings_by_id` (lines 998-1020)
  - `read_set_integers`, `read_set_floats`, `read_set_strings` (lines 1022-1044)
  - `read_set_integers_by_id`, `read_set_floats_by_id`, `read_set_strings_by_id` (lines 1046-1068)
  - `read_element_ids` (lines 1070-1074)
- Uses `internal::read_grouped_values_all<T>` and `internal::read_grouped_values_by_id<T>` from internal header. Update calls from bare `read_grouped_values_all` to `internal::read_grouped_values_all` (and same for by_id).

**File 3: src/database_update.cpp** (~260 lines)
- Includes: `database_impl.h` (no internal header needed)
- Extract: `Database::update_element()` (lines 644-796) and ALL update methods (lines 1076-1257):
  - `update_scalar_integer`, `update_scalar_float`, `update_scalar_string` (lines 1076-1116)
  - `update_vector_integers`, `update_vector_floats`, `update_vector_strings` (lines 1118-1188)
  - `update_set_integers`, `update_set_floats`, `update_set_strings` (lines 1190-1257)

**File 4: src/database_delete.cpp** (~12 lines)
- Includes: `database_impl.h`
- Extract: `Database::delete_element_by_id()` (lines 798-806)

**Update src/CMakeLists.txt:**
Add the 4 new source files to the `QUIVER_SOURCES` list (after `database.cpp`):
```cmake
set(QUIVER_SOURCES
    database.cpp
    database_create.cpp
    database_read.cpp
    database_update.cpp
    database_delete.cpp
    element.cpp
    ...rest unchanged...
)
```

**Verify database.cpp after extraction:**
After removing CRUD methods + shared helpers, database.cpp should retain:
- Includes (trimmed: remove `<map>` if no longer needed, keep others)
- Anonymous namespace with: g_logger_counter, sqlite3_init_flag, ensure_sqlite3_initialized, to_spdlog_level, create_database_logger
- `namespace quiver` with lifecycle methods: constructor, destructor, move, is_healthy, execute, current_version, path, from_migrations, from_schema, set_version, begin_transaction, commit, rollback, execute_raw, migrate_up, apply_schema
- ALSO still contains: relations (set_scalar_relation, read_scalar_relation), metadata, time_series, query, describe, csv stubs -- these will be extracted in Plan 02

**Build and test:**
Run `cmake --build build --config Debug` to verify compilation.
Run `./build/bin/quiver_tests.exe` to verify all 385 C++ tests pass.
  </action>
  <verify>
1. `cmake --build build --config Debug` succeeds with zero errors
2. `./build/bin/quiver_tests.exe` passes all 385 tests
3. `database.cpp` no longer contains create_element, any read_* methods, update_element, any update_* methods, delete_element_by_id, or the shared helper functions
4. Each new .cpp file includes `database_impl.h` as its first include
5. No public header in `include/quiver/` has been modified (verify with `git diff include/`)
  </verify>
  <done>CRUD operations extracted into 4 new files, CMakeLists updated, all 385 C++ tests pass, no public header changes</done>
</task>

</tasks>

<verification>
1. Build succeeds: `cmake --build build --config Debug` -- zero errors, zero warnings from new files
2. All C++ tests pass: `./build/bin/quiver_tests.exe` -- 385 tests, 0 failures
3. No public header changes: `git diff include/` shows no modifications
4. New files exist: `src/database_internal.h`, `src/database_create.cpp`, `src/database_read.cpp`, `src/database_update.cpp`, `src/database_delete.cpp`
5. CMakeLists.txt updated: `QUIVER_SOURCES` includes all 4 new .cpp files
6. Shared helpers removed from database.cpp: grep for `read_grouped_values_all` and `find_dimension_column` in database.cpp returns nothing
</verification>

<success_criteria>
- 5 new files created and compiling as part of the library
- database.cpp no longer contains CRUD operations or shared helpers
- All 385 C++ tests pass identically to before
- No public header modifications
- Build system updated with all new source files
</success_criteria>

<output>
After completion, create `.planning/phases/02-cpp-core-file-decomposition/02-01-SUMMARY.md`
</output>
