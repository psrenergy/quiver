---
phase: 02-cpp-core-file-decomposition
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/database_metadata.cpp
  - src/database_time_series.cpp
  - src/database_query.cpp
  - src/database_relations.cpp
  - src/database_describe.cpp
  - src/database.cpp
  - src/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "database.cpp contains only lifecycle operations and is under 500 lines"
    - "Metadata, time series, query, relations, and describe operations each live in their own file"
    - "All 385 C++ tests pass with zero behavior changes"
    - "No public header in include/quiver/ has changed"
    - "Every split file includes database_impl.h and compiles as part of the library"
  artifacts:
    - path: "src/database_metadata.cpp"
      provides: "get_*_metadata and list_*_groups/attributes implementations"
      contains: "Database::get_scalar_metadata"
    - path: "src/database_time_series.cpp"
      provides: "All time series read/update/metadata/files implementations"
      contains: "Database::read_time_series_group_by_id"
    - path: "src/database_query.cpp"
      provides: "query_string/integer/float implementations"
      contains: "Database::query_string"
    - path: "src/database_relations.cpp"
      provides: "set_scalar_relation and read_scalar_relation implementations"
      contains: "Database::set_scalar_relation"
    - path: "src/database_describe.cpp"
      provides: "describe and csv stub implementations"
      contains: "Database::describe"
  key_links:
    - from: "src/database_metadata.cpp"
      to: "src/database_internal.h"
      via: "#include database_internal.h"
      pattern: "internal::scalar_metadata_from_column"
    - from: "src/database_time_series.cpp"
      to: "src/database_internal.h"
      via: "#include database_internal.h"
      pattern: "internal::find_dimension_column"
    - from: "src/CMakeLists.txt"
      to: "all new .cpp files"
      via: "QUIVER_SOURCES list"
      pattern: "database_metadata.cpp"
---

<objective>
Complete the database.cpp decomposition by extracting the remaining five operation categories (metadata, time series, query, relations, describe), leaving database.cpp as a lifecycle-only file under 500 lines.

Purpose: This completes Phase 2. After Plan 01 extracted CRUD operations, this plan extracts the remaining five categories. When done, database.cpp contains only constructor, destructor, move semantics, factory methods, and SQL execution infrastructure -- the minimum core that all other operation files depend on.

Output: 5 new .cpp files, final trimmed database.cpp (~430 lines), updated CMakeLists.txt
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cpp-core-file-decomposition/02-RESEARCH.md
@.planning/phases/02-cpp-core-file-decomposition/02-01-SUMMARY.md
@src/database.cpp
@src/database_impl.h
@src/database_internal.h
@src/CMakeLists.txt
@include/quiver/database.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract metadata, time series, query, relations, and describe operations</name>
  <files>
    src/database_metadata.cpp
    src/database_time_series.cpp
    src/database_query.cpp
    src/database_relations.cpp
    src/database_describe.cpp
    src/database.cpp
    src/CMakeLists.txt
  </files>
  <action>
Extract the remaining five operation categories from database.cpp into new files. After Plan 01, database.cpp should already be missing CRUD methods and shared helpers. Now extract everything except lifecycle methods.

**IMPORTANT:** Read database.cpp FIRST to see its current state after Plan 01's modifications. Line numbers below are from the ORIGINAL 1836-line file -- they will be different after Plan 01's extractions. Use method names to locate code, not line numbers.

Each new file follows the same pattern: include `database_impl.h` first, optionally `database_internal.h` for shared helpers, wrap in `namespace quiver { ... }`.

**File 1: src/database_metadata.cpp** (~130 lines)
- Includes: `database_impl.h`, `database_internal.h`
- Extract all metadata and list methods:
  - `Database::get_scalar_metadata()` -- uses `internal::scalar_metadata_from_column`
  - `Database::get_vector_metadata()` -- uses `internal::scalar_metadata_from_column`
  - `Database::get_set_metadata()` -- uses `internal::scalar_metadata_from_column`
  - `Database::list_scalar_attributes()` -- uses `internal::scalar_metadata_from_column`
  - `Database::list_vector_groups()`
  - `Database::list_set_groups()`
- Update bare `scalar_metadata_from_column(...)` calls to `internal::scalar_metadata_from_column(...)`.

**File 2: src/database_time_series.cpp** (~210 lines)
- Includes: `database_impl.h`, `database_internal.h`
- Extract all time series methods:
  - `Database::list_time_series_groups()`
  - `Database::get_time_series_metadata()` -- uses `internal::find_dimension_column` and `internal::scalar_metadata_from_column`
  - `Database::read_time_series_group_by_id()` -- uses `internal::find_dimension_column`
  - `Database::update_time_series_group()` -- uses `internal::find_dimension_column`
  - `Database::has_time_series_files()`
  - `Database::list_time_series_files_columns()`
  - `Database::read_time_series_files()`
  - `Database::update_time_series_files()`
- Update bare `find_dimension_column(...)` calls to `internal::find_dimension_column(...)` and `scalar_metadata_from_column(...)` to `internal::scalar_metadata_from_column(...)`.

**File 3: src/database_query.cpp** (~24 lines)
- Includes: `database_impl.h`
- Extract: `Database::query_string()`, `Database::query_integer()`, `Database::query_float()`
- These are simple delegators to `execute()`. No internal header needed.

**File 4: src/database_relations.cpp** (~85 lines)
- Includes: `database_impl.h`
- Extract: `Database::set_scalar_relation()`, `Database::read_scalar_relation()`
- These use `impl_->require_collection`, `impl_->schema`, and `execute()`. No internal header needed.

**File 5: src/database_describe.cpp** (~90 lines)
- Includes: `database_impl.h`, and also `<iostream>` (for std::cout used in describe)
- Extract: `Database::describe()`, `Database::export_to_csv()`, `Database::import_from_csv()`
- `describe()` uses `impl_->schema`, `impl_->path`, `current_version()`, and `data_type_to_string()` (from public header `data_type.h`). Does NOT use internal helpers.
- `export_to_csv()` and `import_from_csv()` are stubs (throw runtime_error "Not implemented").

**Update src/CMakeLists.txt:**
Add 5 new source files to `QUIVER_SOURCES` (Plan 01 already added create/read/update/delete):
```cmake
set(QUIVER_SOURCES
    database.cpp
    database_create.cpp
    database_read.cpp
    database_update.cpp
    database_delete.cpp
    database_metadata.cpp
    database_time_series.cpp
    database_query.cpp
    database_relations.cpp
    database_describe.cpp
    element.cpp
    ...rest unchanged...
)
```

**Trim database.cpp:**
After all extractions, database.cpp should contain ONLY:
- Includes: `database_impl.h`, `quiver/migrations.h`, `quiver/result.h`, `<atomic>`, `<filesystem>`, `<fstream>`, `<mutex>`, spdlog headers, `<sqlite3.h>`, `<sstream>`, `<stdexcept>`
- Remove `<iostream>` (moved to describe), `<map>` (if no longer used)
- Anonymous namespace with lifecycle-only helpers: g_logger_counter, sqlite3_init_flag, ensure_sqlite3_initialized, to_spdlog_level, create_database_logger
- `namespace quiver` with lifecycle methods ONLY: constructor, destructor, move constructor, move assignment, is_healthy, execute, current_version, path, from_migrations, from_schema, set_version, begin_transaction, commit, rollback, execute_raw, migrate_up, apply_schema

**Count lines in final database.cpp** to verify it is under 500.

**Build and test:**
Run `cmake --build build --config Debug` to verify compilation.
Run `./build/bin/quiver_tests.exe` to verify all 385 C++ tests pass.
Run `git diff include/` to verify no public headers changed.
  </action>
  <verify>
1. `cmake --build build --config Debug` succeeds with zero errors
2. `./build/bin/quiver_tests.exe` passes all 385 tests
3. `git diff include/` shows no changes
4. `wc -l src/database.cpp` shows under 500 lines
5. database.cpp contains NO operation methods (grep for `read_scalar\|get_scalar_metadata\|query_string\|set_scalar_relation\|describe\|time_series` returns only lifecycle-related references)
6. All 5 new files exist and each includes `database_impl.h`
  </verify>
  <done>All 5 remaining operation categories extracted, database.cpp is lifecycle-only and under 500 lines, all 385 C++ tests pass, no public header changes, full decomposition complete</done>
</task>

</tasks>

<verification>
1. Build succeeds: `cmake --build build --config Debug` -- zero errors
2. All C++ tests pass: `./build/bin/quiver_tests.exe` -- 385 tests, 0 failures
3. No public header changes: `git diff include/` shows nothing
4. Line count: `wc -l src/database.cpp` is under 500
5. Complete decomposition: 10 total source files for Database class (1 lifecycle + 9 operation categories)
6. All 10 files compile as part of the quiver library target
7. File inventory: database.cpp, database_create.cpp, database_read.cpp, database_update.cpp, database_delete.cpp, database_metadata.cpp, database_time_series.cpp, database_query.cpp, database_relations.cpp, database_describe.cpp, database_internal.h
</verification>

<success_criteria>
- database.cpp contains only lifecycle operations and is under 500 lines
- 9 separate operation files + 1 shared internal header exist
- All 385 C++ tests pass with zero behavior changes
- No public header modifications
- CMakeLists.txt includes all 10 database source files
</success_criteria>

<output>
After completion, create `.planning/phases/02-cpp-core-file-decomposition/02-02-SUMMARY.md`
</output>
