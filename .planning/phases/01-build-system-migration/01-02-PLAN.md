---
phase: 01-build-system-migration
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - scripts/test-wheel.bat
autonomous: false
requirements:
  - BUILD-01
  - BUILD-02

must_haves:
  truths:
    - "pip wheel . in bindings/python/ produces a .whl file without errors"
    - "The wheel contains quiverdb/_libs/libquiver and quiverdb/_libs/libquiver_c (platform-appropriate extensions)"
    - "The wheel does NOT contain stray lib/ or bin/ directories at the root level"
    - "Existing Python tests still pass via test.bat (no functional regression)"
    - "A validation script exists that builds a wheel and verifies its contents"
  artifacts:
    - path: "scripts/test-wheel.bat"
      provides: "Wheel build and content validation script"
      min_lines: 20
  key_links:
    - from: "scripts/test-wheel.bat"
      to: "bindings/python/pyproject.toml"
      via: "pip wheel . invokes scikit-build-core backend"
      pattern: "pip wheel"
    - from: "pip wheel . output"
      to: "quiverdb/_libs/"
      via: "CMake SKBUILD install targets"
      pattern: "_libs"
---

<objective>
Create the wheel validation script and verify the complete build system migration works end-to-end: wheel builds successfully, contains the correct native libraries, and existing development workflow is preserved.

Purpose: Proves the build system migration actually works. Without validation, we cannot confirm the wheel is self-contained or that we have not broken the existing development workflow.
Output: scripts/test-wheel.bat, verified wheel build with correct contents, confirmed existing tests still pass.
</objective>

<execution_context>
@C:/Users/rsampaio/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rsampaio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-build-system-migration/01-CONTEXT.md
@.planning/phases/01-build-system-migration/01-RESEARCH.md
@.planning/phases/01-build-system-migration/01-01-SUMMARY.md

# Source files for context
@bindings/python/pyproject.toml
@CMakeLists.txt
@bindings/python/tests/test.bat
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test-wheel.bat validation script and build the wheel</name>
  <files>scripts/test-wheel.bat</files>
  <action>
Create `scripts/test-wheel.bat` that builds a wheel from `bindings/python/` and validates its contents. The script does NOT test runtime import (that requires Phase 2 loader rewrite). It validates wheel CONTENTS only.

Implementation requirements:
- Script runs from repo root (like other scripts in `scripts/`)
- Uses `pip wheel . --no-build-isolation -w dist` from `bindings/python/` to build the wheel
- After successful build, inspects the wheel (a zip file) using Python's zipfile module to verify:
  - `quiverdb/_libs/` directory exists in the wheel
  - On Windows: `quiverdb/_libs/libquiver.dll` and `quiverdb/_libs/libquiver_c.dll` are present
  - On Linux: `quiverdb/_libs/libquiver.so` and `quiverdb/_libs/libquiver_c.so` are present
  - No stray `lib/` or `bin/` directories at the wheel root (confirms src/CMakeLists.txt guard works)
- Prints file sizes for the bundled libraries (informational)
- Cleans up the dist/ directory after inspection
- Uses `setlocal enabledelayedexpansion` for proper variable expansion
- Returns non-zero exit code on any failure
- Uses `%~dp0` to locate bindings/python relative to script location

After creating the script, run it to actually build the wheel and verify contents. This is the primary validation that BUILD-01 and BUILD-02 are satisfied.

Also run the existing Python tests via `bindings/python/tests/test.bat` to confirm no regression in the development workflow (test.bat sets PATH to build/bin/ for DLL discovery -- this path should be unaffected by the build system changes).
  </action>
  <verify>
    <automated>cd C:/Development/DatabaseTmp/quiver2 && scripts/test-wheel.bat</automated>
    <manual>Check script output shows both libquiver and libquiver_c present in the wheel's _libs/ directory with non-zero file sizes.</manual>
  </verify>
  <done>test-wheel.bat exists, builds a wheel successfully, and confirms the wheel contains quiverdb/_libs/libquiver.dll and quiverdb/_libs/libquiver_c.dll (or .so on Linux). No stray lib/ or bin/ at wheel root. Existing Python tests pass via test.bat.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify wheel build and existing test suite</name>
  <files>scripts/test-wheel.bat</files>
  <action>
Human verification of the complete build system migration. All automation is done in Task 1. This checkpoint confirms the user is satisfied with the results.

What was built:
1. pyproject.toml now uses scikit-build-core as build backend
2. CMakeLists.txt has SKBUILD guard that bundles native libs into quiverdb/_libs/
3. src/CMakeLists.txt guards existing installs from running under SKBUILD
4. scripts/test-wheel.bat validates wheel contents
5. Wheel was built and verified to contain both native libraries

How to verify:
1. Run `scripts/test-wheel.bat` from repo root -- should build wheel and report both libraries present in _libs/
2. Run `bindings/python/tests/test.bat` -- existing Python tests should all pass (development workflow unchanged)
3. Run `cmake --build build --config Debug` -- normal C++ build should work (SKBUILD not defined)
4. Optionally run `scripts/test-all.bat` to verify nothing else broke
  </action>
  <verify>
    <automated>cd C:/Development/DatabaseTmp/quiver2 && scripts/test-wheel.bat</automated>
  </verify>
  <done>User has confirmed: wheel builds correctly with bundled native libraries, existing Python tests pass, normal CMake builds are unaffected.</done>
</task>

</tasks>

<verification>
1. `scripts/test-wheel.bat` exits with code 0 and reports both libraries present in wheel
2. `bindings/python/tests/test.bat` passes (no regression)
3. `cmake --build build --config Debug` succeeds (normal build unaffected)
4. Wheel file (before cleanup) can be inspected with `python -m zipfile -l dist/quiverdb-*.whl` showing _libs/ entries
</verification>

<success_criteria>
- scripts/test-wheel.bat exists and executes successfully
- Wheel contains quiverdb/_libs/libquiver.dll and quiverdb/_libs/libquiver_c.dll (Windows) or .so (Linux)
- Wheel does NOT contain stray lib/ or bin/ directories
- Existing Python tests pass via test.bat
- Normal CMake build is unaffected
- User has verified the complete build system migration
</success_criteria>

<output>
After completion, create `.planning/phases/01-build-system-migration/01-02-SUMMARY.md`
</output>
