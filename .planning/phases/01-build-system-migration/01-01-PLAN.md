---
phase: 01-build-system-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bindings/python/pyproject.toml
  - bindings/python/.gitignore
  - CMakeLists.txt
  - src/CMakeLists.txt
autonomous: true
requirements:
  - BUILD-01
  - BUILD-02

must_haves:
  truths:
    - "pyproject.toml declares scikit-build-core as build backend instead of hatchling"
    - "CMake SKBUILD guard forces QUIVER_BUILD_C_API=ON and disables tests during wheel builds"
    - "CMake install targets place both native libraries into quiverdb/_libs/ during wheel builds"
    - "Existing install targets do not activate during SKBUILD builds (no extra lib/bin in wheel)"
    - "Normal CMake builds (without SKBUILD) are completely unaffected"
  artifacts:
    - path: "bindings/python/pyproject.toml"
      provides: "scikit-build-core build backend configuration"
      contains: "scikit_build_core.build"
    - path: "CMakeLists.txt"
      provides: "SKBUILD guard with install targets"
      contains: "DEFINED SKBUILD"
    - path: "src/CMakeLists.txt"
      provides: "Guarded existing install targets"
      contains: "NOT DEFINED SKBUILD"
    - path: "bindings/python/.gitignore"
      provides: "Ignores scikit-build-core build artifacts"
      contains: "_skbuild"
  key_links:
    - from: "bindings/python/pyproject.toml"
      to: "CMakeLists.txt"
      via: "cmake.source-dir = '../..'"
      pattern: 'cmake\.source-dir\s*=\s*"\.\./\.\."'
    - from: "CMakeLists.txt (SKBUILD guard top)"
      to: "src/CMakeLists.txt (QUIVER_BUILD_C_API check)"
      via: "FORCE sets QUIVER_BUILD_C_API before add_subdirectory(src)"
      pattern: "set\\(QUIVER_BUILD_C_API ON"
    - from: "CMakeLists.txt (SKBUILD guard bottom)"
      to: "quiverdb/_libs/ in wheel"
      via: "install(TARGETS quiver quiver_c DESTINATION quiverdb/_libs)"
      pattern: "DESTINATION quiverdb/_libs"
---

<objective>
Replace hatchling with scikit-build-core as the Python build backend and add SKBUILD-guarded CMake install targets so that `pip wheel .` (from bindings/python/) invokes CMake and bundles the native libraries into the wheel.

Purpose: This is the foundational build system change that enables self-contained wheel packaging. Without it, the Python binding cannot be distributed via PyPI.
Output: Modified pyproject.toml, CMakeLists.txt, src/CMakeLists.txt, .gitignore -- ready for wheel building.
</objective>

<execution_context>
@C:/Users/rsampaio/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rsampaio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-build-system-migration/01-CONTEXT.md
@.planning/phases/01-build-system-migration/01-RESEARCH.md

# Source files being modified
@bindings/python/pyproject.toml
@CMakeLists.txt
@src/CMakeLists.txt
@bindings/python/.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hatchling with scikit-build-core in pyproject.toml and update .gitignore</name>
  <files>bindings/python/pyproject.toml, bindings/python/.gitignore</files>
  <action>
Rewrite `bindings/python/pyproject.toml` to use scikit-build-core as the build backend. The complete target state:

```toml
[project]
name = "quiverdb"
version = "0.4.0"
requires-python = ">=3.13"
dependencies = [
    "cffi>=2.0.0",
]

[build-system]
requires = ["scikit-build-core>=0.10"]
build-backend = "scikit_build_core.build"

[tool.scikit-build]
cmake.source-dir = "../.."
cmake.build-type = "Release"
cmake.args = ["-DQUIVER_BUILD_TESTS=OFF"]
wheel.packages = ["src/quiverdb"]

[dependency-groups]
dev = [
    "dotenv>=0.9.9",
    "pytest>=8.4.1",
    "ruff>=0.12.2",
]
```

Key changes from current file:
- `[build-system]`: `hatchling` replaced with `scikit-build-core>=0.10` and `scikit_build_core.build`
- `[tool.hatch.build.targets.wheel]` section removed entirely
- `[tool.scikit-build]` section added with: `cmake.source-dir = "../.."` (points to repo root), `cmake.build-type = "Release"`, `cmake.args = ["-DQUIVER_BUILD_TESTS=OFF"]` (skip test compilation during wheel build), `wheel.packages = ["src/quiverdb"]` (explicit src layout discovery)
- `[project.scripts]` section removed (was empty)
- Version stays at 0.4.0 per user decision
- No PyPI presentation metadata (no description, classifiers, readme, URLs) per user decision

Also update `bindings/python/.gitignore` to add `_skbuild/` pattern. Add it near the top of the file, after the existing `build/` entry. The existing `.gitignore` already covers `dist/`, `build/`, and `*.egg-info/`, but `_skbuild/` is scikit-build-core's working directory and needs explicit coverage.
  </action>
  <verify>
    <automated>cd C:/Development/DatabaseTmp/quiver2 && python -c "import tomllib; f=open('bindings/python/pyproject.toml','rb'); d=tomllib.load(f); assert d['build-system']['build-backend']=='scikit_build_core.build', 'wrong backend'; assert 'scikit-build-core>=0.10' in d['build-system']['requires'], 'wrong requires'; assert d['tool']['scikit-build']['cmake']['source-dir']=='../..', 'wrong source-dir'; assert d['tool']['scikit-build']['wheel']['packages']==['src/quiverdb'], 'wrong packages'; print('pyproject.toml: OK')" && grep -q "_skbuild" bindings/python/.gitignore && echo ".gitignore: OK"</automated>
  </verify>
  <done>pyproject.toml declares scikit-build-core as build backend with correct cmake.source-dir, build-type, and wheel.packages configuration. .gitignore includes _skbuild/ pattern.</done>
</task>

<task type="auto">
  <name>Task 2: Add SKBUILD guard to root CMakeLists.txt and guard existing installs in src/CMakeLists.txt</name>
  <files>CMakeLists.txt, src/CMakeLists.txt</files>
  <action>
Modify `CMakeLists.txt` (root) to add the SKBUILD guard in TWO parts (per research Pitfall 2 -- CMake evaluation order):

**Part 1 -- BEFORE `add_subdirectory(src)` (after the `option()` declarations, around line 17):**
```cmake
# --- Python wheel packaging (scikit-build-core) ---
# When building via scikit-build-core (pip wheel / python -m build),
# SKBUILD is defined. Force C API on and disable tests for wheel builds.
if(DEFINED SKBUILD)
    set(QUIVER_BUILD_C_API ON CACHE BOOL "Build C API wrapper" FORCE)
    set(QUIVER_BUILD_TESTS OFF CACHE BOOL "Build test suite" FORCE)
endif()
```

This MUST appear AFTER the `option(QUIVER_BUILD_C_API ...)` line (line 17) and BEFORE `add_subdirectory(src)` (line 31). The `FORCE` keyword overrides the cached default even if it was previously configured. This is critical because `add_subdirectory(src)` evaluates `if(QUIVER_BUILD_C_API)` -- the value must already be ON.

**Part 2 -- At the very END of root CMakeLists.txt (after all existing content):**
```cmake
# Install native libraries into the Python wheel package directory
if(DEFINED SKBUILD)
    install(TARGETS quiver quiver_c
        LIBRARY DESTINATION quiverdb/_libs
        RUNTIME DESTINATION quiverdb/_libs
    )
endif()
```

- `LIBRARY DESTINATION` handles `.so` on Linux, `.dylib` on macOS
- `RUNTIME DESTINATION` handles `.dll` on Windows
- Both point to `quiverdb/_libs` relative to CMAKE_INSTALL_PREFIX (which scikit-build-core manages)
- Use `DEFINED SKBUILD` (not just `SKBUILD`) -- scikit-build-core sets SKBUILD=2

**Also modify `src/CMakeLists.txt`** to guard the existing install targets so they do NOT run under SKBUILD builds (per research Pitfall 3 -- avoids extra lib/bin files at site-packages root):

Wrap the existing `install()` block for the `quiver` target (lines 82-90) in `if(NOT DEFINED SKBUILD)`:
```cmake
if(NOT DEFINED SKBUILD)
    install(TARGETS quiver
        EXPORT quiverTargets
        LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
        ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
        RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
    )
    install(DIRECTORY ${CMAKE_SOURCE_DIR}/include/quiver
        DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
    )
endif()
```

And similarly wrap the `quiver_c` install block (lines 131-136) inside the `if(QUIVER_BUILD_C_API)` block:
```cmake
if(NOT DEFINED SKBUILD)
    install(TARGETS quiver_c
        EXPORT quiverTargets
        LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
        ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
        RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
    )
endif()
```

Do NOT modify any other parts of CMakeLists.txt or src/CMakeLists.txt. The existing target definitions, compile options, link libraries, etc. all remain unchanged.
  </action>
  <verify>
    <automated>cd C:/Development/DatabaseTmp/quiver2 && grep -q "DEFINED SKBUILD" CMakeLists.txt && grep -c "DEFINED SKBUILD" CMakeLists.txt | grep -q "[2-9]" && echo "Root CMakeLists.txt: has 2+ SKBUILD guards" && grep -q "NOT DEFINED SKBUILD" src/CMakeLists.txt && echo "src/CMakeLists.txt: existing installs guarded" && cmake --build build --config Debug 2>&1 | tail -5 && echo "Normal build: OK"</automated>
    <manual>Verify that `cmake --build build --config Debug` still succeeds (SKBUILD is NOT defined, so normal build path is taken). Existing C++ tests should still compile.</manual>
  </verify>
  <done>Root CMakeLists.txt has SKBUILD guard in two parts (force options before add_subdirectory, install targets at end). src/CMakeLists.txt guards existing installs with NOT DEFINED SKBUILD. Normal (non-SKBUILD) CMake builds are unaffected.</done>
</task>

</tasks>

<verification>
1. `python -c "import tomllib; ..."` confirms pyproject.toml has correct build backend
2. `grep "DEFINED SKBUILD" CMakeLists.txt` confirms guard blocks exist (should find 3+ occurrences -- 2 in root, 1+ in src)
3. `cmake --build build --config Debug` succeeds (normal build unaffected)
4. Existing Python tests still pass: `bindings/python/tests/test.bat`
</verification>

<success_criteria>
- pyproject.toml uses scikit_build_core.build as backend with cmake.source-dir = "../.."
- Root CMakeLists.txt has SKBUILD guard that forces QUIVER_BUILD_C_API=ON and QUIVER_BUILD_TESTS=OFF before add_subdirectory(src)
- Root CMakeLists.txt has SKBUILD install block at the end installing to quiverdb/_libs
- src/CMakeLists.txt wraps existing install() in if(NOT DEFINED SKBUILD)
- Normal CMake Debug build still works
- .gitignore covers _skbuild/
</success_criteria>

<output>
After completion, create `.planning/phases/01-build-system-migration/01-01-SUMMARY.md`
</output>
