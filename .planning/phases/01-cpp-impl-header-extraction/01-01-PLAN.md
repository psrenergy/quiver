---
phase: 01-cpp-impl-header-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/database_impl.h
  - src/database.cpp
autonomous: true

must_haves:
  truths:
    - "src/database_impl.h exists and contains the Database::Impl struct definition with TransactionGuard"
    - "src/database.cpp includes database_impl.h and no longer contains the Impl struct definition"
    - "No file in include/quiver/ has been modified"
    - "All C++ tests pass identically (quiver_tests.exe green)"
    - "database_impl.h is only reachable via the PRIVATE src/ include path, not the PUBLIC include/ path"
  artifacts:
    - path: "src/database_impl.h"
      provides: "Database::Impl struct definition with TransactionGuard nested class"
      contains: "struct Database::Impl"
    - path: "src/database.cpp"
      provides: "All Database method implementations, now including database_impl.h"
      contains: '#include "database_impl.h"'
  key_links:
    - from: "src/database.cpp"
      to: "src/database_impl.h"
      via: '#include "database_impl.h"'
      pattern: '#include "database_impl.h"'
    - from: "src/database_impl.h"
      to: "include/quiver/database.h"
      via: '#include "quiver/database.h"'
      pattern: '#include "quiver/database.h"'
---

<objective>
Extract the `Database::Impl` struct definition (lines 166-258 of `src/database.cpp`) into a new private internal header `src/database_impl.h`. This makes `Database::Impl` includable from multiple `.cpp` files, enabling the file decomposition in Phase 2.

Purpose: Phase 2 will split `database.cpp` into multiple focused modules. Each split file needs access to `Database::Impl`. Without this extraction, the Impl definition is trapped in a single translation unit.

Output: A new file `src/database_impl.h` and a modified `src/database.cpp` that includes it. Zero behavior change.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cpp-impl-header-extraction/01-RESEARCH.md
@src/database.cpp
@src/CMakeLists.txt
@include/quiver/database.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database_impl.h and update database.cpp</name>
  <files>src/database_impl.h, src/database.cpp</files>
  <action>
**Step 1: Create `src/database_impl.h`**

Create a new file `src/database_impl.h` with the following structure:

1. Include guard: `#ifndef QUIVER_DATABASE_IMPL_H` / `#define QUIVER_DATABASE_IMPL_H` / `#endif` (matches project convention of `#ifndef` guards)
2. Includes required by the Impl struct members and methods:
   - `"quiver/database.h"` (Database class definition — Impl is Database::Impl)
   - `"quiver/schema.h"` (Schema, used as unique_ptr member)
   - `"quiver/schema_validator.h"` (SchemaValidator, used in load_schema_metadata())
   - `"quiver/type_validator.h"` (TypeValidator, used as unique_ptr member)
   - `<memory>` (unique_ptr, shared_ptr)
   - `<string>` (string)
   - `<spdlog/spdlog.h>` (shared_ptr<spdlog::logger>)
   - `<sqlite3.h>` (sqlite3*, sqlite3_close_v2, sqlite3_exec, sqlite3_free, SQLITE_OK)
3. Open `namespace quiver {`
4. Move the entire `struct Database::Impl { ... };` block (lines 166-258 of database.cpp) verbatim into the header, including:
   - All 5 data members (db, path, logger, schema, type_validator)
   - All 7 methods (require_schema, require_collection, load_schema_metadata, destructor, begin_transaction, commit, rollback)
   - The nested `TransactionGuard` class (lines 237-257)
5. Close `} // namespace quiver`

**Step 2: Update `src/database.cpp`**

1. Replace the first include `#include "quiver/database.h"` with `#include "database_impl.h"`
2. Remove includes that are now transitively provided by `database_impl.h`:
   - Remove `#include "quiver/schema.h"` (provided by database_impl.h)
   - Remove `#include "quiver/schema_validator.h"` (provided by database_impl.h)
   - Remove `#include "quiver/type_validator.h"` (provided by database_impl.h)
   - Keep `#include "quiver/migrations.h"` (used directly by factory methods in database.cpp)
   - Keep `#include "quiver/result.h"` (used directly by query/read methods in database.cpp)
   - Keep all standard library and third-party includes that are used directly by database.cpp method implementations (atomic, filesystem, fstream, iostream, map, mutex, spdlog sinks, spdlog, sqlite3, sstream, stdexcept)
3. Delete lines 166-258 (the entire `struct Database::Impl { ... };` block). Do NOT delete the `scalar_metadata_from_column` function above it (line 162-164) or anything in the anonymous namespace above that.
4. Do NOT modify any file in `include/quiver/`.
5. Do NOT modify any anonymous namespace helpers — they stay in database.cpp.

**Important notes:**
- `database_impl.h` already includes `<spdlog/spdlog.h>` and `<sqlite3.h>`, but database.cpp also uses spdlog sink headers (`spdlog/sinks/basic_file_sink.h`, `spdlog/sinks/stdout_color_sinks.h`) which are NOT included by database_impl.h. These must remain in database.cpp.
- The `scalar_metadata_from_column` static function (line 162-164) stays in database.cpp — it is NOT part of Impl.
  </action>
  <verify>
1. Build: `cmake --build build --config Debug` — must succeed with zero errors
2. Run C++ tests: `./build/bin/quiver_tests.exe` — all tests must pass
3. Verify no public header changes: `git diff include/` — must show no output
4. Verify database_impl.h exists: `ls src/database_impl.h` — must exist
5. Verify Impl definition removed from database.cpp: search for `struct Database::Impl` in `src/database.cpp` — must NOT be found
6. Verify Impl definition present in header: search for `struct Database::Impl` in `src/database_impl.h` — must be found
7. Run C API tests as a secondary check: `./build/bin/quiver_c_tests.exe` — all tests must pass (C API depends on C++ library)
  </verify>
  <done>
- `src/database_impl.h` exists with Database::Impl struct definition and TransactionGuard
- `src/database.cpp` includes `database_impl.h` and compiles without the inline Impl definition
- No file in `include/quiver/` has been modified (git diff clean)
- `quiver_tests.exe` passes all tests
- `quiver_c_tests.exe` passes all tests
  </done>
</task>

</tasks>

<verification>
1. **Build verification:** `cmake --build build --config Debug` succeeds with zero errors and zero new warnings
2. **C++ test verification:** `./build/bin/quiver_tests.exe` — all existing tests pass with identical results
3. **C API test verification:** `./build/bin/quiver_c_tests.exe` — all existing C API tests pass (they link against the C++ library)
4. **Public header integrity:** `git diff include/` produces empty output (no public headers changed)
5. **Private header location:** `src/database_impl.h` exists in `src/` (PRIVATE include path), not in `include/quiver/` (PUBLIC include path)
6. **Include structure:** `database_impl.h` is not referenced by any file in `include/quiver/` (verified by grep)
</verification>

<success_criteria>
- src/database_impl.h contains the complete Database::Impl struct with TransactionGuard
- src/database.cpp includes database_impl.h and has no Impl struct definition
- Zero public header modifications
- All C++ tests pass
- All C API tests pass
- database_impl.h is unreachable from the public include path
</success_criteria>

<output>
After completion, create `.planning/phases/01-cpp-impl-header-extraction/01-01-SUMMARY.md`
</output>
