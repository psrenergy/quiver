---
phase: 03-ci-wheel-building
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bindings/python/pyproject.toml
  - .github/workflows/build-wheels.yml
autonomous: true
requirements:
  - CI-01
  - CI-02
  - CI-03

must_haves:
  truths:
    - "Push to master triggers a GitHub Actions workflow that builds wheels for Windows x64 and Linux x64"
    - "Each wheel is tested against the full Python test suite inside cibuildwheel before being considered successful"
    - "Built wheels from both platforms are merged into a single downloadable 'wheels' artifact with 7-day retention"
    - "Workflow fails entirely if any platform fails tests (no partial artifacts)"
  artifacts:
    - path: ".github/workflows/build-wheels.yml"
      provides: "cibuildwheel GitHub Actions workflow"
      contains: "pypa/cibuildwheel@v3.3.1"
    - path: "bindings/python/pyproject.toml"
      provides: "cibuildwheel build and test configuration"
      contains: "tool.cibuildwheel"
  key_links:
    - from: ".github/workflows/build-wheels.yml"
      to: "bindings/python/pyproject.toml"
      via: "package-dir: bindings/python points cibuildwheel to pyproject.toml's [tool.cibuildwheel] config"
      pattern: "package-dir.*bindings/python"
    - from: "bindings/python/pyproject.toml"
      to: "bindings/python/tests/"
      via: "test-command runs pytest against installed wheel using {project} path"
      pattern: "test-command.*pytest.*\\{project\\}"
---

<objective>
Create a GitHub Actions workflow that builds and tests Python wheels for Windows x64 and Linux x64 using cibuildwheel, then merges per-platform artifacts into a single downloadable "wheels" artifact.

Purpose: Automate cross-platform wheel building and testing so every push to master and every PR produces verified, installable wheels -- the prerequisite for Phase 4's automated PyPI publishing.
Output: `.github/workflows/build-wheels.yml` workflow file and `[tool.cibuildwheel]` configuration in `bindings/python/pyproject.toml`.
</objective>

<execution_context>
@C:/Users/rsampaio/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rsampaio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ci-wheel-building/03-RESEARCH.md
@.planning/phases/03-ci-wheel-building/03-CONTEXT.md
@bindings/python/pyproject.toml
@.github/workflows/ci.yml
@bindings/python/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cibuildwheel configuration to pyproject.toml and create workflow file</name>
  <files>
    bindings/python/pyproject.toml
    .github/workflows/build-wheels.yml
  </files>
  <action>
**Step 1: Add `[tool.cibuildwheel]` section to `bindings/python/pyproject.toml`.**

Append after the existing `[dependency-groups]` section:

```toml
[tool.cibuildwheel]
build = ["cp313-win_amd64", "cp313-manylinux_x86_64"]
test-requires = ["pytest"]
test-command = "pytest {project}/bindings/python/tests"
```

Key decisions:
- `build` restricts to exactly CPython 3.13 on Windows x64 and Linux x64 (per user decision -- no PyPy, no macOS, no musllinux).
- `test-requires` installs pytest in the cibuildwheel test environment.
- `test-command` uses `{project}` (repo root absolute path) to reach test files. The conftest.py uses `Path(__file__).resolve().parent` chain for schema discovery, which works regardless of working directory. Tests import `quiverdb` from the installed wheel (cibuildwheel runs from a temp dir).
- manylinux_2_28 is the default in cibuildwheel v3, no explicit override needed.

**Step 2: Create `.github/workflows/build-wheels.yml`.**

Create the workflow file with this exact structure:

```yaml
name: Build Wheels

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    name: Build wheels (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - uses: actions/checkout@v6

      - uses: pypa/cibuildwheel@v3.3.1
        with:
          package-dir: bindings/python
          output-dir: wheelhouse

      - uses: actions/upload-artifact@v6
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl

  merge:
    name: Merge wheel artifacts
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/upload-artifact/merge@v4
        with:
          name: wheels
          pattern: wheels-*
          delete-merged: true
          retention-days: 7
```

Key decisions explained:
- **`fail-fast: false`**: Both platforms finish and report independently, but the `merge` job's `needs: build` ensures artifacts only merge if ALL platforms succeed. If any platform fails, the `merge` job is skipped, so no partial "wheels" artifact is created.
- **`package-dir: bindings/python`**: Points cibuildwheel at the subdirectory containing pyproject.toml. cibuildwheel mounts the checkout directory as the working directory, so `{project}` resolves to the repo root.
- **`output-dir: wheelhouse`**: Standard output directory for built wheels.
- **Unique artifact names**: `wheels-${{ matrix.os }}` avoids the v4+ name collision issue, then merged into a single `wheels` artifact.
- **`delete-merged: true`**: Cleans up per-platform artifacts after merge.
- **`retention-days: 7`**: Per user decision. Phase 4 publish workflow will consume this artifact.
- **No `before-all` step**: scikit-build-core auto-provides cmake and ninja in the build environment. No manual installation needed.
- **No `repair-wheel-command` override**: Start with default auditwheel behavior on Linux. Windows has no repair by default. If auditwheel renames bundled libraries and breaks loading, the fix is to add `repair-wheel-command-linux = ""` to pyproject.toml's `[tool.cibuildwheel]` section -- but try default first.
- **Triggers**: Push to master and PRs to master (per user decision). Tag triggers deferred to Phase 4.
  </action>
  <verify>
    <automated>python -c "import tomllib; f=open('bindings/python/pyproject.toml','rb'); d=tomllib.load(f); c=d['tool']['cibuildwheel']; assert c['build']==['cp313-win_amd64','cp313-manylinux_x86_64']; assert c['test-requires']==['pytest']; assert 'pytest' in c['test-command']; print('pyproject.toml OK')" && python -c "import yaml; f=open('.github/workflows/build-wheels.yml'); d=yaml.safe_load(f); assert d['name']=='Build Wheels'; assert 'build' in d['jobs']; assert 'merge' in d['jobs']; assert d['jobs']['merge']['needs']=='build'; print('workflow OK')"</automated>
    <manual>Inspect both files for correct structure, indentation, and all locked decisions reflected</manual>
  </verify>
  <done>
    - `bindings/python/pyproject.toml` has `[tool.cibuildwheel]` section with `build`, `test-requires`, and `test-command` fields
    - `.github/workflows/build-wheels.yml` exists with "Build Wheels" name, push/PR triggers on master, matrix of ubuntu-latest + windows-latest, cibuildwheel v3.3.1 with package-dir, per-platform artifact upload, and merge job with 7-day retention
    - No `before-all` installation steps (scikit-build-core handles cmake)
    - `fail-fast: false` set so both platforms report independently
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate workflow syntax and configuration completeness</name>
  <files>
    .github/workflows/build-wheels.yml
    bindings/python/pyproject.toml
  </files>
  <action>
**Step 1: Validate the workflow YAML syntax.**

Run the following to ensure valid YAML:
```bash
python -c "import yaml; yaml.safe_load(open('.github/workflows/build-wheels.yml')); print('YAML valid')"
```

**Step 2: Validate pyproject.toml syntax.**

```bash
python -c "import tomllib; tomllib.load(open('bindings/python/pyproject.toml','rb')); print('TOML valid')"
```

**Step 3: Cross-check all locked decisions from CONTEXT.md are present.**

Verify each locked decision is implemented:
1. Triggers on push to master and PRs -- check `on.push.branches` and `on.pull_request.branches`
2. Single workflow file named "Build Wheels" -- check `name` field
3. CPython 3.13 only, win_amd64 + manylinux_x86_64 -- check `build` list in `[tool.cibuildwheel]`
4. Full test suite via pytest -- check `test-command` and `test-requires`
5. No separate C++/C API test jobs -- verify only `build` and `merge` jobs exist
6. All wheels in single "wheels" artifact -- check merge job `name` field
7. 7-day retention -- check `retention-days`
8. If any platform fails, no partial artifact -- verify `merge.needs: build` blocks on all matrix jobs
9. `fail-fast: false` -- verify in matrix strategy

**Step 4: Verify no deferred items are included.**

Confirm these are NOT present:
- No tag triggers (Phase 4)
- No macOS in matrix
- No musllinux or PyPy in build list
- No separate C++ or C API test jobs

If any check fails, fix the issue in the relevant file before proceeding.
  </action>
  <verify>
    <automated>python -c "
import tomllib, yaml

# Validate TOML
with open('bindings/python/pyproject.toml', 'rb') as f:
    toml = tomllib.load(f)
cibw = toml['tool']['cibuildwheel']
assert cibw['build'] == ['cp313-win_amd64', 'cp313-manylinux_x86_64'], 'wrong build targets'
assert 'pytest' in cibw['test-requires'], 'missing pytest in test-requires'
assert '{project}' in cibw['test-command'], 'test-command must use {project} placeholder'

# Validate YAML
with open('.github/workflows/build-wheels.yml') as f:
    wf = yaml.safe_load(f)
assert wf['name'] == 'Build Wheels', 'wrong workflow name'
assert 'master' in wf['on']['push']['branches'], 'missing push trigger on master'
assert 'master' in wf['on']['pull_request']['branches'], 'missing PR trigger on master'
assert set(wf['jobs'].keys()) == {'build', 'merge'}, 'unexpected jobs'
matrix_os = wf['jobs']['build']['strategy']['matrix']['os']
assert 'ubuntu-latest' in matrix_os, 'missing ubuntu'
assert 'windows-latest' in matrix_os, 'missing windows'
assert 'macos-latest' not in matrix_os, 'macOS should not be present'
assert wf['jobs']['build']['strategy']['fail-fast'] == False, 'fail-fast should be false'
assert wf['jobs']['merge']['needs'] == 'build', 'merge must depend on build'
merge_step = wf['jobs']['merge']['steps'][0]
assert merge_step['with']['retention-days'] == 7, 'retention must be 7 days'
print('All checks passed')
"</automated>
  </verify>
  <done>
    - YAML and TOML both parse without errors
    - All 9 locked decisions from CONTEXT.md verified present in configuration
    - No deferred items (macOS, musllinux, PyPy, tag triggers) appear in config
    - Workflow has exactly 2 jobs: build and merge
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **YAML valid**: `.github/workflows/build-wheels.yml` parses without errors
2. **TOML valid**: `bindings/python/pyproject.toml` parses without errors
3. **CI-01 satisfied**: Workflow uses `pypa/cibuildwheel@v3.3.1` with `package-dir: bindings/python`
4. **CI-02 satisfied**: Build list is exactly `["cp313-win_amd64", "cp313-manylinux_x86_64"]`
5. **CI-03 satisfied**: `test-requires = ["pytest"]` and `test-command` runs full suite against installed wheel
6. **Artifact merge**: Per-platform `wheels-*` artifacts merged into single `wheels` artifact with 7-day retention
7. **No partial artifacts**: `merge` job's `needs: build` ensures all platforms must pass
</verification>

<success_criteria>
- `.github/workflows/build-wheels.yml` exists and is valid YAML
- `bindings/python/pyproject.toml` contains `[tool.cibuildwheel]` section with correct build targets, test-requires, and test-command
- All Phase 3 requirements (CI-01, CI-02, CI-03) addressed
- All locked decisions from CONTEXT.md implemented
- No deferred items (macOS, PyPy, tag triggers) included
</success_criteria>

<output>
After completion, create `.planning/phases/03-ci-wheel-building/03-01-SUMMARY.md`
</output>
