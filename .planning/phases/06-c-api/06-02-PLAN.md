---
phase: 06-c-api
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - tests/test_c_api_database_csv.cpp
  - tests/CMakeLists.txt
  - CLAUDE.md
autonomous: true
requirements: [CAPI-01, CAPI-02]

must_haves:
  truths:
    - "C API scalar export produces identical CSV output to C++ API for same input data"
    - "C API group export (vector, set, time series) produces correct CSV with label replacing id"
    - "C API enum_labels parallel arrays correctly resolve integer values to string labels with unmapped fallback"
    - "C API date_time_format correctly reformats DateTime columns without affecting other columns"
    - "C API handles edge cases: empty collection (header-only), NULL values (empty fields), RFC 4180 escaping"
    - "FFI generators produce correct binding declarations for the new csv.h types"
  artifacts:
    - path: "tests/test_c_api_database_csv.cpp"
      provides: "Comprehensive C API CSV test suite mirroring C++ tests"
      min_lines: 400
    - path: "tests/CMakeLists.txt"
      provides: "Test registration for new test file"
      contains: "test_c_api_database_csv.cpp"
    - path: "CLAUDE.md"
      provides: "Updated documentation reflecting C API CSV additions"
      contains: "database_csv.cpp"
  key_links:
    - from: "tests/test_c_api_database_csv.cpp"
      to: "include/quiver/c/csv.h"
      via: "#include for options struct"
      pattern: '#include.*quiver/c/csv.h'
    - from: "tests/test_c_api_database_csv.cpp"
      to: "tests/schemas/valid/csv_export.sql"
      via: "VALID_SCHEMA macro"
      pattern: 'VALID_SCHEMA.*csv_export.sql'
    - from: "tests/CMakeLists.txt"
      to: "tests/test_c_api_database_csv.cpp"
      via: "CMake test target registration"
      pattern: "test_c_api_database_csv.cpp"
---

<objective>
Create a comprehensive C API test suite mirroring the 19 C++ CSV export tests, run FFI generators, and update CLAUDE.md.

Purpose: Verify the C API CSV export wrapper correctly marshals flat struct data to C++ and produces identical output. Ensure FFI generators parse the new header. Keep documentation current.
Output: `tests/test_c_api_database_csv.cpp` with full test coverage, updated CMake, regenerated FFI bindings, updated CLAUDE.md.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-c-api/06-RESEARCH.md
@.planning/phases/06-c-api/06-01-SUMMARY.md

@include/quiver/c/csv.h
@include/quiver/c/database.h
@src/c/database_csv.cpp
@tests/test_database_csv.cpp
@tests/test_c_api_database_transaction.cpp
@tests/test_utils.h
@tests/schemas/valid/csv_export.sql
@tests/CMakeLists.txt
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create C API CSV test suite and register in CMake</name>
  <files>
    tests/test_c_api_database_csv.cpp
    tests/CMakeLists.txt
  </files>
  <action>
**Step 1: Create `tests/test_c_api_database_csv.cpp`** mirroring the 19 C++ test cases from `tests/test_database_csv.cpp`. All tests use the `DatabaseCApiCSV` test suite name.

Use the same test infrastructure as other C API tests:
- Include `"test_utils.h"`, `<filesystem>`, `<fstream>`, `<gtest/gtest.h>`, `<quiver/c/csv.h>`, `<quiver/c/database.h>`, `<quiver/c/element.h>`
- Helper: `static std::string read_file(const std::string& path)` using `std::ifstream` in binary mode with `std::ostringstream`
- Helper: `static fs::path temp_csv(const std::string& name)` returning `fs::temp_directory_path() / ("quiver_c_test_" + name + ".csv")`
- Use `VALID_SCHEMA("csv_export.sql")` macro for schema path
- Use `quiver_database_options_default()` with `options.console_level = QUIVER_LOG_OFF`
- Create elements via C API: `quiver_element_create`, `quiver_element_set_*`, `quiver_database_create_element`, `quiver_element_destroy`
- Clean up with `quiver_database_close(db)` and `fs::remove(csv_path)`

**Mirror these test cases (same assertions, C API calls instead of C++):**

1. `ExportCSV_ScalarExport_HeaderAndData` -- Create element, export scalars with default opts, verify header row and data row
2. `ExportCSV_VectorGroupExport` -- Create element + update vector via C API, export "values" group, verify label column + vector data
3. `ExportCSV_SetGroupExport` -- Create element + update set via C API, export "tags" group, verify label column + set data
4. `ExportCSV_TimeSeriesGroupExport` -- Create element + update time series via C API, export "readings" group, verify label column + time series data
5. `ExportCSV_InvalidGroup_ReturnsError` -- Export with non-existent group name, assert `QUIVER_ERROR`, check `quiver_get_last_error()` message
6. `ExportCSV_RFC4180_CommaEscaping` -- Element with comma in string value, verify quoted field in output
7. `ExportCSV_RFC4180_QuoteEscaping` -- Element with double-quote in string value, verify escaped quotes (`""`)
8. `ExportCSV_RFC4180_NewlineEscaping` -- Element with newline in string value, verify quoted field
9. `ExportCSV_LFLineEndings` -- Verify entire CSV content uses `\n` only (no `\r\n`), read in binary mode
10. `ExportCSV_EmptyCollection_HeaderOnly` -- No elements created, export produces header row only
11. `ExportCSV_NullValues_EmptyFields` -- Create element with minimal scalars (only label), export, verify empty fields for unset attributes
12. `ExportCSV_DefaultOptions_RawValues` -- Export with default opts, verify integer enum values appear as raw numbers (no mapping)
13. `ExportCSV_EnumLabels_ReplacesIntegers` -- Set up `quiver_csv_export_options_t` with enum_attribute_names/entry_counts/values/labels arrays for "status" attribute, verify mapped labels appear in CSV
14. `ExportCSV_EnumLabels_UnmappedFallback` -- Provide partial enum mapping (only some values), verify unmapped values appear as raw integers
15. `ExportCSV_DateTimeFormat_FormatsDateColumns` -- Set `date_time_format = "%Y-%m-%d"`, verify date_created column reformatted
16. `ExportCSV_DateTimeFormat_NonDateColumnsUnaffected` -- Set date_time_format, verify non-DateTime string columns like "name" and "notes" are NOT reformatted
17. `ExportCSV_DefaultOptionsFactory` -- Call `quiver_csv_export_options_default()`, verify `date_time_format` is empty string (not NULL), `enum_attribute_count` is 0, all pointer fields are NULL
18. `ExportCSV_CreatesParentDirectories` -- Export to a path with non-existent parent directory, verify it creates the directory and writes the file
19. `ExportCSV_OverwritesExistingFile` -- Write a file, export to same path, verify old content is replaced

For tests requiring vector/set/time series updates, use the C API update functions:
- `quiver_database_update_vector_floats` for vector data
- `quiver_database_update_set_strings` for set data
- `quiver_database_update_time_series_group` for time series data

For enum labels tests, set up the C arrays on the stack:
```cpp
const char* attr_names[] = {"status"};
size_t entry_counts[] = {2};
int64_t values[] = {1, 2};
const char* labels[] = {"Active", "Inactive"};

quiver_csv_export_options_t csv_opts = {};
csv_opts.date_time_format = "";
csv_opts.enum_attribute_names = attr_names;
csv_opts.enum_entry_counts = entry_counts;
csv_opts.enum_values = values;
csv_opts.enum_labels = labels;
csv_opts.enum_attribute_count = 1;
```

Reference: 06-RESEARCH.md "Test Pattern" code example and `tests/test_database_csv.cpp` for exact assertions.

**Step 2: Register in `tests/CMakeLists.txt`:**
- Add `test_c_api_database_csv.cpp` to the `quiver_c_tests` target source list, after `test_c_api_database_create.cpp` (alphabetical order)

**Step 3: Build and run:**
- Run `cmake --build build --config Debug`
- Run `./build/bin/quiver_c_tests.exe --gtest_filter="DatabaseCApiCSV.*"` -- all 19 tests pass
- Run `./build/bin/quiver_c_tests.exe` -- all C API tests pass (no regressions)
- Run `./build/bin/quiver_tests.exe` -- all C++ tests pass (no regressions)
  </action>
  <verify>
Run `cmake --build build --config Debug` -- no errors. Run `./build/bin/quiver_c_tests.exe --gtest_filter="DatabaseCApiCSV.*"` -- 19 tests pass. Run `./build/bin/quiver_c_tests.exe` -- all tests pass. Run `./build/bin/quiver_tests.exe` -- all tests pass.
  </verify>
  <done>19 C API CSV tests pass covering scalar/group export, enum labels, date formatting, RFC 4180 escaping, edge cases. No regressions in existing test suites.</done>
</task>

<task type="auto">
  <name>Task 2: Run FFI generators and update CLAUDE.md</name>
  <files>
    CLAUDE.md
  </files>
  <action>
**Step 1: Run FFI generators** to verify the new `csv.h` header is correctly parsed:

- Run `bindings/julia/generator/generator.bat` -- Julia Clang.jl auto-discovers `csv.h` via `readdir`. Verify `quiver_csv_export_options_t` and `quiver_csv_export_options_default` appear in generated output.
- Run `bindings/dart/generator/generator.bat` -- Dart ffigen. If `quiver_csv_export_options_t` is NOT in generated output, add `csv.h` to `entry-points` and `include-directives` in `bindings/dart/ffigen.yaml`, then re-run. The type should be transitively discovered via `database.h`'s `#include "csv.h"`.

If either generator fails, diagnose and fix (likely ffigen.yaml entry-point issue). The generators must produce correct declarations for Phase 7 to consume.

**Step 2: Update `CLAUDE.md`** with Phase 6 additions:

In the Architecture section:
- Add `csv.h` entry under `include/quiver/c/` listing: `csv.h                   # quiver_csv_export_options_t struct and default factory`
- Add `database_csv.cpp` entry under `src/c/` listing: `database_csv.cpp        # CSV export: options conversion, export function`

In the C API Patterns section, no new patterns needed -- the struct follows existing options pattern.

In the Test Organization section:
- Add `test_c_api_database_csv.cpp` entry: `- \`test_c_api_database_csv.cpp\` - CSV export options struct, enum labels, date formatting, scalar/group export`

In the Core API section, ensure `export_csv` is documented with the CSV export options note.

In the Cross-Layer Naming table, verify the CSV row already exists (it should from Phase 5 CLAUDE.md update).

Keep changes minimal and targeted. Do not rewrite unrelated sections.
  </action>
  <verify>
Verify FFI generator output contains `quiver_csv_export_options_t` struct. Verify CLAUDE.md contains references to `csv.h` (C API), `database_csv.cpp` (C API impl), and `test_c_api_database_csv.cpp`.
  </verify>
  <done>FFI generators successfully parse csv.h and produce correct binding declarations. CLAUDE.md updated with C API CSV additions (header, implementation, test references).</done>
</task>

</tasks>

<verification>
1. `tests/test_c_api_database_csv.cpp` exists with 19 test cases in `DatabaseCApiCSV` suite
2. `tests/CMakeLists.txt` includes `test_c_api_database_csv.cpp` in `quiver_c_tests` target
3. All 19 C API CSV tests pass
4. All existing C++ and C API tests pass (no regressions)
5. Julia FFI generator output includes `quiver_csv_export_options_t`
6. Dart FFI generator output includes `quiver_csv_export_options_t`
7. CLAUDE.md documents the new C API CSV files
</verification>

<success_criteria>
- 19 C API CSV tests pass, covering all scenarios from the C++ test suite
- FFI generators produce correct declarations for the new types
- CLAUDE.md is up to date with all Phase 6 additions
- Full test suite (`quiver_tests.exe` + `quiver_c_tests.exe`) passes with zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/06-c-api/06-02-SUMMARY.md`
</output>
