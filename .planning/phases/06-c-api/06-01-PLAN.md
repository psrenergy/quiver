---
phase: 06-c-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - include/quiver/c/csv.h
  - include/quiver/c/database.h
  - src/c/database_csv.cpp
  - src/c/database.cpp
  - src/CMakeLists.txt
autonomous: true
requirements: [CAPI-01, CAPI-02]

must_haves:
  truths:
    - "quiver_csv_export_options_default() returns a zero-initialized struct with date_time_format set to empty string"
    - "quiver_database_export_csv() accepts 5 parameters (db, collection, group, path, opts) and produces identical CSV output to the C++ API"
    - "quiver_csv_export_options_t flat struct can represent any enum_labels mapping through grouped-by-attribute parallel arrays"
    - "Project builds without errors after adding new header, implementation, and CMake registration"
  artifacts:
    - path: "include/quiver/c/csv.h"
      provides: "quiver_csv_export_options_t struct and quiver_csv_export_options_default() factory"
      contains: "quiver_csv_export_options_t"
    - path: "src/c/database_csv.cpp"
      provides: "convert_options helper, factory default implementation, export_csv C wrapper"
      contains: "convert_options"
    - path: "include/quiver/c/database.h"
      provides: "Updated export_csv declaration with 5 parameters including opts"
      contains: "quiver_csv_export_options_t"
  key_links:
    - from: "include/quiver/c/database.h"
      to: "include/quiver/c/csv.h"
      via: "#include directive"
      pattern: '#include "csv.h"'
    - from: "src/c/database_csv.cpp"
      to: "include/quiver/csv.h"
      via: "C++ CSVExportOptions conversion"
      pattern: "quiver::CSVExportOptions"
    - from: "src/CMakeLists.txt"
      to: "src/c/database_csv.cpp"
      via: "CMake quiver_c target registration"
      pattern: "c/database_csv.cpp"
---

<objective>
Create the C API header, flat options struct, conversion function, and export wrapper for CSV export.

Purpose: Expose the C++ CSV export functionality through FFI-safe C API functions so that language bindings (Phase 7) can call CSV export via the C API.
Output: New `include/quiver/c/csv.h` header with flat struct, new `src/c/database_csv.cpp` implementation, updated `database.h` declaration, build system registration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-c-api/06-RESEARCH.md
@.planning/phases/05-c-core/05-01-SUMMARY.md

@include/quiver/c/common.h
@include/quiver/c/options.h
@include/quiver/c/database.h
@include/quiver/csv.h
@src/c/database.cpp
@src/c/internal.h
@src/c/database_query.cpp
@src/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create csv.h header with flat options struct and default factory</name>
  <files>include/quiver/c/csv.h</files>
  <action>
Create new file `include/quiver/c/csv.h` with:

1. Standard include guard `QUIVER_C_CSV_H`
2. Include `"common.h"` for `QUIVER_C_API`, `stddef.h` (size_t), `stdint.h` (int64_t)
3. `extern "C"` block

4. `quiver_csv_export_options_t` typedef struct with these fields in this order:
   - `const char* date_time_format` -- strftime format string; empty string = no formatting
   - `const char* const* enum_attribute_names` -- array of attribute names, length = enum_attribute_count
   - `const size_t* enum_entry_counts` -- entries per attribute, length = enum_attribute_count
   - `const int64_t* enum_values` -- all integer values concatenated across attributes
   - `const char* const* enum_labels` -- all string labels concatenated across attributes
   - `size_t enum_attribute_count` -- number of attribute groups (0 = no enum mapping)

5. Comment block above the struct explaining the grouped-by-attribute parallel arrays layout with a concrete example:
   `{"status": {1: "Active", 2: "Inactive"}, "priority": {0: "Low"}}` maps to:
   `enum_attribute_names = ["status", "priority"]`, `enum_entry_counts = [2, 1]`,
   `enum_values = [1, 2, 0]`, `enum_labels = ["Active", "Inactive", "Low"]`, `enum_attribute_count = 2`

6. Declare `QUIVER_C_API quiver_csv_export_options_t quiver_csv_export_options_default(void);`

Full const qualifiers: `const char* const*` for string arrays, `const int64_t*` for values, `const size_t*` for counts. This signals borrowing semantics at the type level.

No free function needed -- struct is caller-owned and stack-allocated.

Reference: 06-RESEARCH.md "Complete Header" code example for exact layout.
  </action>
  <verify>File exists at `include/quiver/c/csv.h`. Contains `quiver_csv_export_options_t` struct with all 6 fields. Contains `quiver_csv_export_options_default` declaration. Has include guard and extern "C" block.</verify>
  <done>csv.h header defines the flat FFI-safe options struct with grouped-by-attribute parallel arrays and a default factory declaration.</done>
</task>

<task type="auto">
  <name>Task 2: Create database_csv.cpp implementation and update build system</name>
  <files>
    src/c/database_csv.cpp
    include/quiver/c/database.h
    src/c/database.cpp
    src/CMakeLists.txt
  </files>
  <action>
**Step 1: Create `src/c/database_csv.cpp`** with:

1. Includes: `"internal.h"`, `"quiver/c/csv.h"`, `"quiver/c/database.h"`, `"quiver/csv.h"`, `<string>`
2. Static `convert_options(const quiver_csv_export_options_t* opts)` function that:
   - Creates `quiver::CSVExportOptions cpp_opts`
   - Sets `cpp_opts.date_time_format` from `opts->date_time_format` (treat NULL as empty string: `opts->date_time_format ? opts->date_time_format : ""`)
   - Loops `enum_attribute_count` groups, using a running `offset` variable to index into the concatenated `enum_values[]` and `enum_labels[]` arrays
   - Returns the C++ `CSVExportOptions`
   - Follow the `convert_params()` pattern from `src/c/database_query.cpp`
3. `extern "C"` block with:
   - `quiver_csv_export_options_default()`: zero-initialize struct with `{}`, set `date_time_format = ""`, return it. Direct return (not out-parameter), matching `quiver_database_options_default()` pattern.
   - `quiver_database_export_csv(db, collection, group, path, opts)`: 5-parameter version. `QUIVER_REQUIRE(db, collection, group, path, opts)`. Try-catch calling `convert_options(opts)` then `db->db.export_csv(collection, group, path, cpp_opts)`. Return `QUIVER_OK`/`QUIVER_ERROR` with `quiver_set_last_error(e.what())`.

Reference: 06-RESEARCH.md "Complete Implementation" code example.

**Step 2: Update `include/quiver/c/database.h`:**
- Add `#include "csv.h"` after the existing `#include "options.h"` line
- Find the existing `quiver_database_export_csv` declaration and update its signature from 4 parameters to 5 parameters:
  `QUIVER_C_API quiver_error_t quiver_database_export_csv(quiver_database_t* db, const char* collection, const char* group, const char* path, const quiver_csv_export_options_t* opts);`

**Step 3: Remove export_csv stub from `src/c/database.cpp`:**
- Remove the entire `quiver_database_export_csv` function (lines ~131-143, including the `// CSV operations` comment above it)
- Keep `quiver_database_import_csv` in `database.cpp` as-is

**Step 4: Register in `src/CMakeLists.txt`:**
- Add `c/database_csv.cpp` to the `quiver_c` target source list, after `c/database.cpp` line

**Step 5: Build and verify:**
- Run `cmake --build build --config Debug`
- Verify no compile or linker errors
- Run `./build/bin/quiver_c_tests.exe` to confirm existing C API tests still pass (the old export_csv stub is replaced, but existing tests don't call it directly)
  </action>
  <verify>
Run `cmake --build build --config Debug` -- no errors. Run `./build/bin/quiver_c_tests.exe` -- all existing C API tests pass. Run `./build/bin/quiver_tests.exe` -- all C++ tests pass (no regressions).
  </verify>
  <done>C API CSV export implementation compiles and links correctly. Old 4-param stub removed from database.cpp, new 5-param version lives in database_csv.cpp. Build system updated. All existing tests pass.</done>
</task>

</tasks>

<verification>
1. `include/quiver/c/csv.h` exists with `quiver_csv_export_options_t` struct (6 fields) and `quiver_csv_export_options_default` declaration
2. `src/c/database_csv.cpp` exists with `convert_options`, `quiver_csv_export_options_default`, and `quiver_database_export_csv` implementations
3. `include/quiver/c/database.h` includes `csv.h` and declares 5-param `quiver_database_export_csv`
4. `src/c/database.cpp` no longer contains `quiver_database_export_csv` (only `quiver_database_import_csv` remains)
5. `src/CMakeLists.txt` lists `c/database_csv.cpp` in the `quiver_c` target
6. `cmake --build build --config Debug` succeeds
7. `./build/bin/quiver_tests.exe` and `./build/bin/quiver_c_tests.exe` both pass
</verification>

<success_criteria>
- New csv.h header and database_csv.cpp implementation compile and link into quiver_c
- quiver_csv_export_options_default() is callable and returns a valid struct
- quiver_database_export_csv() has the correct 5-parameter signature
- No duplicate symbol errors (old stub removed)
- All existing tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/06-c-api/06-01-SUMMARY.md`
</output>
