---
phase: 04-c-api-file-decomposition
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/c/database.cpp
  - src/c/database_update.cpp
  - src/c/database_metadata.cpp
  - src/c/database_query.cpp
  - src/c/database_time_series.cpp
  - src/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "database.cpp contains only lifecycle, describe, and CSV functions and is under 200 lines"
    - "Every remaining operation category has its own dedicated C API file"
    - "All metadata alloc/free pairs are co-located in database_metadata.cpp"
    - "All time series alloc/free pairs are co-located in database_time_series.cpp"
    - "convert_params is file-local static in database_query.cpp"
    - "All existing C API tests pass with zero behavior changes"
  artifacts:
    - path: "src/c/database_update.cpp"
      provides: "All update_scalar/vector/set C API functions"
      contains: "quiver_database_update_scalar_integer"
    - path: "src/c/database_metadata.cpp"
      provides: "All get_*_metadata, list_*_groups/attributes, and free_*_metadata C API functions"
      contains: "quiver_database_get_scalar_metadata"
    - path: "src/c/database_query.cpp"
      provides: "All query_string/integer/float and _params variants, plus convert_params"
      contains: "quiver_database_query_string"
    - path: "src/c/database_time_series.cpp"
      provides: "All time series operations and free functions"
      contains: "quiver_database_read_time_series_group_by_id"
  key_links:
    - from: "src/c/database_metadata.cpp"
      to: "src/c/database_helpers.h"
      via: "#include database_helpers.h"
      pattern: "convert_scalar_to_c|convert_group_to_c|free_scalar_fields|free_group_fields"
    - from: "src/c/database_time_series.cpp"
      to: "src/c/database_helpers.h"
      via: "#include database_helpers.h"
      pattern: "convert_group_to_c|strdup_safe|copy_strings_to_c"
    - from: "src/c/database_query.cpp"
      to: "src/c/database_helpers.h"
      via: "#include database_helpers.h"
      pattern: "strdup_safe"
---

<objective>
Extract the remaining 4 operation categories (update, metadata, query, time series) from `src/c/database.cpp` into dedicated files, leaving database.cpp as a lifecycle-only core under 200 lines.

Purpose: Complete the C API file decomposition, achieving full structural parity with the C++ layer. Every operation category in its own translation unit, all alloc/free pairs co-located.
Output: `database_update.cpp`, `database_metadata.cpp`, `database_query.cpp`, `database_time_series.cpp`; `database.cpp` trimmed to lifecycle-only (~170 lines).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-c-api-file-decomposition/04-RESEARCH.md
@.planning/phases/04-c-api-file-decomposition/04-01-SUMMARY.md
@src/c/database.cpp
@src/c/database_helpers.h
@src/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract update, metadata, query, and time series into separate files</name>
  <files>
    src/c/database.cpp
    src/c/database_update.cpp
    src/c/database_metadata.cpp
    src/c/database_query.cpp
    src/c/database_time_series.cpp
    src/CMakeLists.txt
  </files>
  <action>
Create `src/c/database_update.cpp`:
- Include `quiver/c/database.h`, `internal.h`
- Wrap in `extern "C" { ... }`
- Move all 9 update functions: `update_scalar_integer/float/string`, `update_vector_integers/floats/strings`, `update_set_integers/floats/strings`
- No helpers header needed -- update functions only call `db->db.update_*()` and use `QUIVER_REQUIRE`

Create `src/c/database_metadata.cpp`:
- Include `quiver/c/database.h`, `database_helpers.h`, `internal.h`
- Wrap in `extern "C" { ... }`
- Move all metadata functions: `get_scalar_metadata`, `get_vector_metadata`, `get_set_metadata`, `list_scalar_attributes`, `list_vector_groups`, `list_set_groups`
- Co-locate all metadata free functions: `quiver_free_scalar_metadata`, `quiver_free_group_metadata`, `quiver_free_scalar_metadata_array`, `quiver_free_group_metadata_array`
- These functions use `convert_scalar_to_c`, `convert_group_to_c`, `free_scalar_fields`, `free_group_fields` from `database_helpers.h`

Create `src/c/database_query.cpp`:
- Include `quiver/c/database.h`, `database_helpers.h`, `internal.h`
- Wrap in `extern "C" { ... }`
- Move the `static convert_params` function (keep it `static` -- file-local to this TU)
- Move all 6 query functions: `query_string`, `query_integer`, `query_float`, `query_string_params`, `query_integer_params`, `query_float_params`
- Needs `database_helpers.h` for `strdup_safe` (used by `query_string` and `query_string_params`)
- Add `#include <stdexcept>` for `std::runtime_error` used by `convert_params`

Create `src/c/database_time_series.cpp`:
- Include `quiver/c/database.h`, `database_helpers.h`, `internal.h`, `<map>`, `<optional>`
- Wrap in `extern "C" { ... }`
- Move all time series functions: `get_time_series_metadata`, `list_time_series_groups`, `read_time_series_group_by_id`, `update_time_series_group`, `has_time_series_files`, `list_time_series_files_columns`, `read_time_series_files`, `update_time_series_files`
- Co-locate time series free functions: `quiver_free_time_series_data`, `quiver_free_time_series_files`
- Needs `database_helpers.h` for `convert_group_to_c`, `strdup_safe`, `copy_strings_to_c`

Trim `database.cpp` to lifecycle-only:
- Remove ALL moved functions (update, metadata, query, time series)
- Remove `static convert_params` function
- Remove `#include "database_helpers.h"` if no remaining functions use helpers (lifecycle functions do not use any helpers)
- Remove `#include <new>` and `#include <string>` if no longer needed (check: `<new>` is used by `new quiver_database` in open/from_schema/from_migrations; `<string>` may be needed by internal.h)
- What remains: `quiver_database_options_default`, `quiver_database_open`, `quiver_database_close`, `quiver_database_is_healthy`, `quiver_database_path`, `quiver_database_from_migrations`, `quiver_database_from_schema`, `quiver_database_current_version`, `quiver_database_describe`, `quiver_database_export_to_csv`, `quiver_database_import_from_csv`
- Target: ~170 lines

Update `src/CMakeLists.txt`: Add `c/database_update.cpp`, `c/database_metadata.cpp`, `c/database_query.cpp`, `c/database_time_series.cpp` to the `quiver_c` SHARED library source list.

**CRITICAL**: Preserve every function signature exactly. No renaming. No logic changes. Only file movement.
  </action>
  <verify>
Run `cmake --build build --config Debug` -- zero compile/link errors.
Run `./build/bin/quiver_c_tests.exe` -- all tests pass with zero failures.
Count lines in `src/c/database.cpp` -- must be under 200 lines.
Verify all 4 new files exist on disk: `database_update.cpp`, `database_metadata.cpp`, `database_query.cpp`, `database_time_series.cpp`.
Verify `convert_params` is `static` in `database_query.cpp`.
Verify metadata free functions are in `database_metadata.cpp` (not separated from get/list functions).
Verify time series free functions are in `database_time_series.cpp` (not separated from read functions).
  </verify>
  <done>
`database.cpp` is lifecycle-only under 200 lines. Four new C API files created (update, metadata, query, time_series). All metadata alloc/free pairs co-located. All time series alloc/free pairs co-located. `convert_params` is file-local in database_query.cpp. All C API tests pass. Full C API decomposition matches C++ layer structure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Final verification and CLAUDE.md update</name>
  <files>
    CLAUDE.md
  </files>
  <action>
Run the full C++ test suite (`./build/bin/quiver_tests.exe`) to confirm the C++ layer is unaffected.
Run the C API test suite (`./build/bin/quiver_c_tests.exe`) one more time to confirm all tests pass.

Verify the complete file inventory of `src/c/`:
- `internal.h` (UNCHANGED)
- `database_helpers.h` (NEW -- from Plan 01)
- `common.cpp` (UNCHANGED)
- `database.cpp` (lifecycle-only, under 200 lines)
- `database_create.cpp` (NEW -- from Plan 01)
- `database_read.cpp` (NEW -- from Plan 01)
- `database_update.cpp` (NEW)
- `database_metadata.cpp` (NEW)
- `database_query.cpp` (NEW)
- `database_time_series.cpp` (NEW)
- `database_relations.cpp` (NEW -- from Plan 01)
- `element.cpp` (UNCHANGED)
- `lua_runner.cpp` (UNCHANGED)

Update CLAUDE.md:
- In the Architecture section, update the `src/c/` description to reflect the new file structure. Currently it says just `src/c/                    # C API implementation`. Update to list the new decomposed structure similar to how `src/` documents the C++ decomposition. Add something like:
  ```
  src/c/                    # C API implementation
    internal.h              # Shared structs (quiver_database, quiver_element), QUIVER_REQUIRE macro
    database_helpers.h      # Marshaling templates, strdup_safe, metadata converters
    database.cpp            # Lifecycle: open, close, factory methods, describe, CSV
    database_create.cpp     # Element CRUD: create, update, delete
    database_read.cpp       # All read operations + co-located free functions
    database_update.cpp     # All scalar/vector/set update operations
    database_metadata.cpp   # Metadata get/list + co-located free functions
    database_query.cpp      # Query operations (plain and parameterized)
    database_time_series.cpp # Time series operations + co-located free functions
    database_relations.cpp  # Relation operations
  ```
- In the C API Patterns section, add a note about the alloc/free co-location pattern: every allocation function and its corresponding free function live in the same translation unit.
  </action>
  <verify>
`./build/bin/quiver_tests.exe` passes (C++ unaffected).
`./build/bin/quiver_c_tests.exe` passes (C API fully functional).
CLAUDE.md updated with new `src/c/` file structure.
`src/c/database.cpp` line count is under 200.
  </verify>
  <done>
Both test suites pass. CLAUDE.md documents the new C API file structure and alloc/free co-location pattern. Phase 4 decomposition is fully complete with 8 C API source files + 2 internal headers.
  </done>
</task>

</tasks>

<verification>
1. `cmake --build build --config Debug` succeeds with zero errors
2. `./build/bin/quiver_c_tests.exe` -- all tests pass, zero failures
3. `./build/bin/quiver_tests.exe` -- all C++ tests still pass (no regression)
4. `src/c/database.cpp` is under 200 lines and contains only lifecycle/describe/CSV functions
5. Every alloc/free pair is co-located: read frees in database_read.cpp, metadata frees in database_metadata.cpp, time series frees in database_time_series.cpp
6. `convert_params` is `static` in `src/c/database_query.cpp`
7. No changes to `src/c/internal.h` or any public header in `include/`
8. CLAUDE.md updated with new file structure documentation
</verification>

<success_criteria>
- database.cpp under 200 lines (lifecycle-only)
- All 4 remaining categories extracted to dedicated files
- All alloc/free pairs co-located in their respective files
- Both C++ and C API test suites pass with zero failures
- CLAUDE.md documents the decomposed C API structure
- Full structural parity between C++ and C API file organization
</success_criteria>

<output>
After completion, create `.planning/phases/04-c-api-file-decomposition/04-02-SUMMARY.md`
</output>
