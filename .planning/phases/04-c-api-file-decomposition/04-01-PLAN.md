---
phase: 04-c-api-file-decomposition
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/c/database_helpers.h
  - src/c/database.cpp
  - src/c/database_create.cpp
  - src/c/database_read.cpp
  - src/c/database_relations.cpp
autonomous: true

must_haves:
  truths:
    - "database_helpers.h contains all shared marshaling templates and inline converter functions"
    - "database.cpp contains only lifecycle functions and is under 200 lines"
    - "CRUD and relation operations live in dedicated files"
    - "All alloc/free pairs for read operations are co-located in database_read.cpp"
    - "All existing C API tests pass with zero behavior changes"
  artifacts:
    - path: "src/c/database_helpers.h"
      provides: "Shared marshaling templates and inline converters"
      contains: "read_scalars_impl"
    - path: "src/c/database_create.cpp"
      provides: "create_element, update_element, delete_element_by_id C API functions"
      contains: "quiver_database_create_element"
    - path: "src/c/database_read.cpp"
      provides: "All read_scalar/vector/set C API functions and co-located free functions"
      contains: "quiver_database_read_scalar_integers"
    - path: "src/c/database_relations.cpp"
      provides: "set_scalar_relation, read_scalar_relation C API functions"
      contains: "quiver_database_set_scalar_relation"
  key_links:
    - from: "src/c/database_read.cpp"
      to: "src/c/database_helpers.h"
      via: "#include database_helpers.h"
      pattern: "read_scalars_impl|copy_strings_to_c|read_vectors_impl|free_vectors_impl"
    - from: "src/c/database_create.cpp"
      to: "src/c/internal.h"
      via: "#include internal.h"
      pattern: "QUIVER_REQUIRE"
---

<objective>
Extract all shared helpers from `src/c/database.cpp` into `database_helpers.h`, then split lifecycle, CRUD, read, and relation functions into separate files.

Purpose: Establish the helper header foundation and extract the first batch of function groups (~830 lines removed from database.cpp), mirroring the Phase 2 C++ decomposition pattern.
Output: `database_helpers.h` with all marshaling/conversion helpers; `database_create.cpp`, `database_read.cpp`, `database_relations.cpp` with their respective C API functions; trimmed `database.cpp` with lifecycle-only plus remaining functions for Plan 02.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-c-api-file-decomposition/04-RESEARCH.md
@src/c/database.cpp
@src/c/internal.h
@src/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database_helpers.h and extract CRUD/read/relations into separate files</name>
  <files>
    src/c/database_helpers.h
    src/c/database.cpp
    src/c/database_create.cpp
    src/c/database_read.cpp
    src/c/database_relations.cpp
    src/CMakeLists.txt
  </files>
  <action>
Create `src/c/database_helpers.h` with include guard `QUIVER_C_DATABASE_HELPERS_H`. Include `quiver/c/database.h`, `quiver/database.h`, `internal.h`, `<cstring>`, `<string>`, `<vector>`. Extract from the anonymous namespaces in `database.cpp`:

1. **Templates** (ODR-safe inherently): `read_scalars_impl<T>` (lines 12-22), `read_vectors_impl<T>` (lines 25-46), `free_vectors_impl<T>` (lines 49-60)
2. **Inline functions** (mark ALL as `inline`): `copy_strings_to_c` (lines 63-76), `to_c_data_type` (lines 905-917), `strdup_safe` (lines 919-924), `convert_scalar_to_c` (lines 926-936), `free_scalar_fields` (lines 938-943), `convert_group_to_c` (lines 945-957), `free_group_fields` (lines 959-968)

Do NOT move `convert_params` -- it stays file-local in database_query.cpp (Plan 02). Do NOT modify `internal.h` -- `QUIVER_REQUIRE` stays there.

Create `src/c/database_create.cpp`:
- Include `quiver/c/database.h`, `internal.h`, `quiver/c/element.h`
- Wrap in `extern "C" { ... }`
- Move these functions: `quiver_database_create_element` (lines 164-177), `quiver_database_update_element` (lines 179-192), `quiver_database_delete_element_by_id` (lines 194-206)

Create `src/c/database_read.cpp`:
- Include `quiver/c/database.h`, `database_helpers.h`, `internal.h`
- Wrap in `extern "C" { ... }`
- Move ALL read functions: `read_scalar_integers/floats/strings` (lines 264-307), `read_vector_integers/floats/strings` (lines 333-401), `read_set_integers/floats/strings` (lines 433-501), `read_scalar_*_by_id` (lines 505-575), `read_vector_*_by_id` (lines 579-627), `read_set_*_by_id` (lines 631-679), `read_element_ids` (lines 681-693)
- Co-locate ALL free functions: `quiver_free_integer_array` (lines 309-314), `quiver_free_float_array` (lines 316-321), `quiver_free_string_array` (lines 323-331), `quiver_free_integer_vectors` (lines 403-407), `quiver_free_float_vectors` (lines 409-413), `quiver_free_string_vectors` (lines 415-429)

Create `src/c/database_relations.cpp`:
- Include `quiver/c/database.h`, `database_helpers.h`, `internal.h`
- Wrap in `extern "C" { ... }`
- Move: `quiver_database_set_scalar_relation` (lines 208-222), `quiver_database_read_scalar_relation` (lines 224-237)
- Relations needs `database_helpers.h` because `read_scalar_relation` calls `copy_strings_to_c`

Trim `database.cpp`:
- Remove both anonymous namespace blocks (lines 9-78 and lines 904-968) entirely
- Remove all moved functions listed above
- Remove `#include "quiver/c/element.h"` (no longer needed -- element.h only needed by create)
- Keep: lifecycle functions (options_default, open, close, is_healthy, path, from_migrations, from_schema, current_version), describe, export/import CSV, and temporarily keep update/metadata/query/time_series functions (extracted in Plan 02)
- The `static convert_params` function and the second anonymous namespace for metadata helpers must also be removed since their consumers are being extracted or will be extracted in Plan 02. Since update/metadata/query/time_series remain temporarily in database.cpp for Plan 02, ensure those remaining functions still compile. The metadata helpers (`to_c_data_type`, `strdup_safe`, `convert_scalar_to_c`, etc.) need to be accessible -- add `#include "database_helpers.h"` to `database.cpp` since the remaining metadata/time_series/query functions use these helpers.
- Keep `convert_params` as a `static` function in `database.cpp` for now (it will move to `database_query.cpp` in Plan 02)

Update `src/CMakeLists.txt`: Add `c/database_create.cpp`, `c/database_read.cpp`, `c/database_relations.cpp` to the `quiver_c` SHARED library source list (after existing `c/database.cpp`).

**CRITICAL**: Preserve every function signature exactly. No renaming. No logic changes. Only file movement.
  </action>
  <verify>
Run `cmake --build build --config Debug` -- zero compile/link errors.
Run `./build/bin/quiver_c_tests.exe` -- all tests pass with zero failures.
Verify `src/c/database_helpers.h` exists on disk.
Verify `src/c/database_create.cpp`, `src/c/database_read.cpp`, `src/c/database_relations.cpp` exist on disk.
Count lines in `src/c/database.cpp` -- should be significantly reduced (targeting under 800 lines after this plan, final trim to under 200 in Plan 02).
  </verify>
  <done>
`database_helpers.h` exists with all marshaling templates and inline converters. Three new C API files created (create, read, relations). All alloc/free pairs for read operations co-located in database_read.cpp. All C API tests pass. No public header changes.
  </done>
</task>

</tasks>

<verification>
1. `cmake --build build --config Debug` succeeds with zero errors
2. `./build/bin/quiver_c_tests.exe` -- all tests pass, zero failures
3. `src/c/database_helpers.h` exists and contains: `read_scalars_impl`, `read_vectors_impl`, `free_vectors_impl`, `copy_strings_to_c`, `to_c_data_type`, `strdup_safe`, `convert_scalar_to_c`, `free_scalar_fields`, `convert_group_to_c`, `free_group_fields`
4. `src/c/database_create.cpp` contains: `quiver_database_create_element`, `quiver_database_update_element`, `quiver_database_delete_element_by_id`
5. `src/c/database_read.cpp` contains all 22 read functions + 6 free functions
6. `src/c/database_relations.cpp` contains: `quiver_database_set_scalar_relation`, `quiver_database_read_scalar_relation`
7. No changes to `src/c/internal.h` or any public header in `include/`
</verification>

<success_criteria>
- Helper header created with all shared templates/converters
- Three new C API source files created with correct extern "C" wrapping
- All read alloc/free pairs co-located in database_read.cpp
- database.cpp reduced by ~830 lines
- All C API tests pass with zero behavior changes
- Build succeeds with no warnings related to moved code
</success_criteria>

<output>
After completion, create `.planning/phases/04-c-api-file-decomposition/04-01-SUMMARY.md`
</output>
