---
phase: 09-header-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - include/quiver/c/options.h
  - include/quiver/options.h
  - include/quiver/c/database.h
  - include/quiver/database.h
  - src/c/database_csv.cpp
  - src/database_csv.cpp
  - src/lua_runner.cpp
  - tests/test_database_csv.cpp
  - tests/test_c_api_database_csv.cpp
  - include/quiver/c/csv.h
  - include/quiver/csv.h
  - CLAUDE.md
autonomous: true
requirements: [HDR-01, HDR-02]

must_haves:
  truths:
    - "quiver_csv_export_options_t and quiver_csv_export_options_default() are declared in include/quiver/c/options.h"
    - "CSVExportOptions and default_csv_export_options() are defined in include/quiver/options.h"
    - "DatabaseOptions alias and default_database_options() are defined in include/quiver/options.h (moved from database.h)"
    - "include/quiver/c/csv.h does not exist"
    - "include/quiver/csv.h does not exist"
    - "No source file includes csv.h"
    - "Project builds successfully (cmake --build build --config Debug)"
  artifacts:
    - path: "include/quiver/options.h"
      provides: "Consolidated C++ options header (DatabaseOptions + CSVExportOptions)"
    - path: "include/quiver/c/options.h"
      provides: "Consolidated C API options header (log level + db options + CSV options)"
      contains: "quiver_csv_export_options_t"
  key_links:
    - from: "include/quiver/options.h"
      to: "include/quiver/c/options.h"
      via: "#include quiver/c/options.h"
      pattern: '#include "quiver/c/options.h"'
    - from: "include/quiver/database.h"
      to: "include/quiver/options.h"
      via: "#include quiver/options.h"
      pattern: '#include "quiver/options.h"'
    - from: "include/quiver/c/database.h"
      to: "include/quiver/c/options.h"
      via: "#include options.h"
      pattern: '#include "options.h"'
---

<objective>
Merge CSV option types into consolidated options headers at both C API and C++ layers, update all include paths, delete the standalone csv.h files, and update CLAUDE.md.

Purpose: Eliminate the separate csv.h headers so all option/config types live in a single header per layer, simplifying includes and preparing for clean FFI regeneration.
Output: Consolidated headers, updated include paths, deleted csv.h files, updated CLAUDE.md.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-header-consolidation/09-CONTEXT.md
@.planning/phases/09-header-consolidation/09-RESEARCH.md
@.planning/phases/08-library-integration/08-01-SUMMARY.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge CSV types into options headers and create C++ options.h</name>
  <files>
    include/quiver/c/options.h
    include/quiver/options.h
  </files>
  <action>
**C API layer -- modify `include/quiver/c/options.h`:**

1. Add `#include "common.h"` as the first include (before `#ifdef __cplusplus`). This is REQUIRED because the CSV struct uses `size_t`, `int64_t`, and `QUIVER_C_API` from common.h.
2. After the `quiver_database_options_t` struct (and before `#ifdef __cplusplus` closing), append:
   - The full 10-line documentation comment block from `include/quiver/c/csv.h` (lines 10-26, the parallel-arrays documentation)
   - The `quiver_csv_export_options_t` struct typedef (lines 27-34 of csv.h, including the inline field comments)
   - A blank line
   - The comment `// Returns default options (no enum mapping, no date formatting).`
   - The function declaration `QUIVER_C_API quiver_csv_export_options_t quiver_csv_export_options_default(void);`

Ordering per user decision: `quiver_log_level_t` -> `quiver_database_options_t` -> `quiver_csv_export_options_t` -> `quiver_csv_export_options_default()`.

The target state is documented in 09-RESEARCH.md "Complete target state of `include/quiver/c/options.h`" -- match it exactly.

**C++ layer -- create `include/quiver/options.h`:**

Create a new file with this exact content:
```cpp
#ifndef QUIVER_OPTIONS_H
#define QUIVER_OPTIONS_H

#include "export.h"
#include "quiver/c/options.h"

#include <cstdint>
#include <string>
#include <unordered_map>

namespace quiver {

using DatabaseOptions = quiver_database_options_t;

inline DatabaseOptions default_database_options() {
    return {0, QUIVER_LOG_INFO};
}

struct QUIVER_API CSVExportOptions {
    std::unordered_map<std::string, std::unordered_map<int64_t, std::string>> enum_labels;
    std::string date_time_format;  // strftime format string; empty = no formatting
};

inline CSVExportOptions default_csv_export_options() {
    return {};
}

}  // namespace quiver

#endif  // QUIVER_OPTIONS_H
```

Ordering per user decision: `DatabaseOptions` alias + `default_database_options()` first, `CSVExportOptions` struct + `default_csv_export_options()` second.
  </action>
  <verify>
Both files exist and have correct content:
- `include/quiver/c/options.h` includes `common.h`, has all three type blocks in correct order, has `QUIVER_C_API` on the function declaration
- `include/quiver/options.h` includes `export.h` and `quiver/c/options.h`, has `DatabaseOptions` alias before `CSVExportOptions` struct
  </verify>
  <done>
C API options.h contains quiver_log_level_t, quiver_database_options_t, quiver_csv_export_options_t struct (with full comment block), and quiver_csv_export_options_default() declaration. C++ options.h contains DatabaseOptions alias, default_database_options(), CSVExportOptions struct, and default_csv_export_options().
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all include paths and remove moved definitions from database.h</name>
  <files>
    include/quiver/c/database.h
    include/quiver/database.h
    src/c/database_csv.cpp
    src/database_csv.cpp
    src/lua_runner.cpp
    tests/test_database_csv.cpp
    tests/test_c_api_database_csv.cpp
  </files>
  <action>
**C API database.h (`include/quiver/c/database.h`):**
- Delete the line `#include "csv.h"` (line 5). The `#include "options.h"` on line 6 already exists and now provides all types.

**C++ database.h (`include/quiver/database.h`):**
- Replace lines 6-7 (`#include "quiver/c/options.h"` and `#include "quiver/csv.h"`) with a single `#include "quiver/options.h"`. The new options.h includes quiver/c/options.h internally.
- Remove `using DatabaseOptions = quiver_database_options_t;` (line 18) -- now in options.h.
- Remove the `default_database_options()` function (lines 20-22) -- now in options.h.
- Leave all other content in database.h unchanged.

**src/c/database_csv.cpp:**
- Line 2: change `#include "quiver/c/csv.h"` to `#include "quiver/c/options.h"`
- Line 4: change `#include "quiver/csv.h"` to `#include "quiver/options.h"`

**src/database_csv.cpp:**
- Line 2: change `#include "quiver/csv.h"` to `#include "quiver/options.h"`

**src/lua_runner.cpp:**
- Line 3: change `#include "quiver/csv.h"` to `#include "quiver/options.h"`

**tests/test_database_csv.cpp:**
- Line 6: change `#include <quiver/csv.h>` to `#include <quiver/options.h>`

**tests/test_c_api_database_csv.cpp:**
- Line 6: change `#include <quiver/c/csv.h>` to `#include <quiver/c/options.h>`

Per user decision: each .cpp file includes options.h directly (no reliance on transitive includes through database.h).

After all include changes, delete the old header files:
- Delete `include/quiver/c/csv.h`
- Delete `include/quiver/csv.h`

Then build to verify: `cmake --build build --config Debug`
  </action>
  <verify>
1. `grep -r "csv\.h" include/ src/ tests/ --include="*.h" --include="*.cpp"` returns zero matches (no file references csv.h)
2. `ls include/quiver/c/csv.h` and `ls include/quiver/csv.h` both fail (files deleted)
3. `cmake --build build --config Debug` succeeds with no errors
  </verify>
  <done>
All 7 files have updated include paths pointing to options.h. Both csv.h files are deleted. Project compiles successfully.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update CLAUDE.md to reflect header consolidation</name>
  <files>
    CLAUDE.md
  </files>
  <action>
Update CLAUDE.md to reflect the header changes:

**File tree (Architecture section near top):**
- Replace `csv.h` entry under `include/quiver/` with `options.h` and give it a description like `DatabaseOptions, CSVExportOptions types and factories`
- Remove `csv.h` entry under `include/quiver/c/`
- Update description of `include/quiver/c/options.h` to mention it now contains all option types (DatabaseOptions, LogLevel, CSVExportOptions)
- Add entry for `include/quiver/options.h` if not present

**Pimpl vs Value Types section:**
- Update the list of plain value types: `CSVExportOptions` is still a plain value type, but it's now in `options.h` not `csv.h`. Update the parenthetical or list if csv.h is mentioned.

**C API Patterns -- Metadata Types or any section referencing csv.h:**
- Update `C API CSV options: quiver_csv_export_options_t in include/quiver/c/csv.h` to reference `include/quiver/c/options.h`

**Any other prose references to csv.h paths:**
- Search the file for any remaining references to `csv.h` and update them to point to the correct `options.h` file.

Use judgment on what needs changing per Claude's Discretion from CONTEXT.md.
  </action>
  <verify>
`grep "csv\.h" CLAUDE.md` returns zero matches (no stale references to csv.h)
  </verify>
  <done>
CLAUDE.md file tree, prose references, and section descriptions all reflect the consolidated options.h headers. No references to csv.h remain.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `cmake --build build --config Debug` exits 0
2. No csv.h references in source: `grep -r "csv\.h" include/ src/ tests/ --include="*.h" --include="*.cpp"` returns empty
3. csv.h files deleted: neither `include/quiver/c/csv.h` nor `include/quiver/csv.h` exists
4. New headers exist: `include/quiver/options.h` and updated `include/quiver/c/options.h` both present
5. No csv.h references in CLAUDE.md: `grep "csv\.h" CLAUDE.md` returns empty
</verification>

<success_criteria>
- include/quiver/c/options.h contains quiver_log_level_t, quiver_database_options_t, quiver_csv_export_options_t, and quiver_csv_export_options_default()
- include/quiver/options.h contains DatabaseOptions, default_database_options(), CSVExportOptions, and default_csv_export_options()
- include/quiver/c/csv.h and include/quiver/csv.h do not exist
- All 7 source files include options.h instead of csv.h
- database.h no longer defines DatabaseOptions or default_database_options() (they come from options.h)
- cmake --build build --config Debug succeeds
- CLAUDE.md reflects the new header layout
</success_criteria>

<output>
After completion, create `.planning/phases/09-header-consolidation/09-01-SUMMARY.md`
</output>
