---
phase: 09-header-consolidation
plan: 02
type: execute
wave: 2
depends_on: [09-01]
files_modified:
  - bindings/julia/src/c_api.jl
  - bindings/dart/lib/src/ffi/bindings.dart
autonomous: true
requirements: [HDR-03]

must_haves:
  truths:
    - "Regenerated Julia c_api.jl contains exactly one definition of quiver_csv_export_options_t with all 6 fields"
    - "Regenerated Dart bindings.dart contains exactly one definition of quiver_csv_export_options_t with all 6 fields"
    - "All C++ tests (442) pass"
    - "All C API tests (282) pass"
    - "All Julia CSV tests pass"
    - "All Dart CSV tests pass"
  artifacts:
    - path: "bindings/julia/src/c_api.jl"
      provides: "Regenerated Julia FFI bindings with CSV options struct"
      contains: "quiver_csv_export_options_t"
    - path: "bindings/dart/lib/src/ffi/bindings.dart"
      provides: "Regenerated Dart FFI bindings with CSV options struct"
      contains: "quiver_csv_export_options_t"
  key_links:
    - from: "bindings/julia/src/c_api.jl"
      to: "include/quiver/c/options.h"
      via: "Julia Clang.jl generator auto-discovers all .h files in include/quiver/c/"
      pattern: "quiver_csv_export_options_t"
    - from: "bindings/dart/lib/src/ffi/bindings.dart"
      to: "include/quiver/c/options.h"
      via: "Dart ffigen discovers struct transitively through database.h -> options.h"
      pattern: "quiver_csv_export_options_t"
---

<objective>
Regenerate Julia and Dart FFI bindings from the consolidated C API headers, then verify all test suites pass across all layers.

Purpose: Ensure the FFI-generated bindings reflect the consolidated header layout and that the entire project remains green after the structural refactor.
Output: Regenerated binding files, all test suites passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-header-consolidation/09-CONTEXT.md
@.planning/phases/09-header-consolidation/09-RESEARCH.md
@.planning/phases/09-header-consolidation/09-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Regenerate FFI bindings and verify struct integrity</name>
  <files>
    bindings/julia/src/c_api.jl
    bindings/dart/lib/src/ffi/bindings.dart
  </files>
  <action>
**IMPORTANT: csv.h must already be deleted (by plan 09-01) before running generators.** If csv.h still exists, the Julia generator will process both csv.h and options.h, producing duplicate struct definitions.

**Regenerate Julia bindings:**
```bash
bindings/julia/generator/generator.bat
```
The Julia generator (`bindings/julia/generator/generator.jl`) auto-discovers all `.h` files in `include/quiver/c/`. With csv.h deleted, it will only find common.h, database.h, element.h, lua_runner.h, and options.h. The `quiver_csv_export_options_t` struct will now be sourced from options.h instead of csv.h.

After regeneration, verify:
- `quiver_csv_export_options_t` struct appears exactly ONCE in `bindings/julia/src/c_api.jl`
- The struct has all 6 fields: `date_time_format`, `enum_attribute_names`, `enum_entry_counts`, `enum_values`, `enum_labels`, `enum_attribute_count`
- `quiver_csv_export_options_default` function wrapper appears exactly ONCE

**Regenerate Dart bindings:**
```bash
bindings/dart/generator/generator.bat
```
Dart ffigen discovers `quiver_csv_export_options_t` transitively through `database.h -> options.h`. No ffigen.yaml changes needed. The struct should appear in the regenerated `bindings/dart/lib/src/ffi/bindings.dart`.

After regeneration, verify:
- `quiver_csv_export_options_t` class appears exactly ONCE in `bindings/dart/lib/src/ffi/bindings.dart`
- The class has all 6 fields

**NOTE:** The Dart `quiver_csv_export_options_default()` function is NOT expected to appear in the generated Dart bindings -- this is existing behavior (Dart constructs the struct manually). Do not treat its absence as a regression.
  </action>
  <verify>
1. `grep -c "quiver_csv_export_options_t" bindings/julia/src/c_api.jl` shows the struct definition exists
2. `grep -c "quiver_csv_export_options_t" bindings/dart/lib/src/ffi/bindings.dart` shows the struct definition exists
3. Both files contain all 6 fields of the struct
  </verify>
  <done>
Julia c_api.jl and Dart bindings.dart both contain exactly one definition of quiver_csv_export_options_t with all 6 fields, regenerated from the consolidated options.h header.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run all test suites to verify zero regressions</name>
  <files></files>
  <action>
Run the full test suite across all layers to confirm zero regressions from the header consolidation:

**C++ core tests:**
```bash
./build/bin/quiver_tests.exe
```
Expected: 442 tests pass (same count as before consolidation).

**C API tests:**
```bash
./build/bin/quiver_c_tests.exe
```
Expected: 282 tests pass (same count as before consolidation).

**Julia tests:**
```bash
bindings/julia/test/test.bat
```
Expected: All Julia tests pass, including 19 CSV tests. The Julia `export_csv()` function wraps C API calls that use `quiver_csv_export_options_t` -- if the regenerated struct definition is incorrect, these tests will fail.

**Dart tests:**
```bash
bindings/dart/test/test.bat
```
Expected: All Dart tests pass, including 5 CSV tests. The Dart `exportCSV()` method constructs `quiver_csv_export_options_t` manually and passes it to the C API -- if the struct layout changed, these tests will fail.

If any test suite fails, investigate the failure. Most likely causes:
1. Missing include (compiler error in C++/C API) -- fix the include path
2. Struct field mismatch in generated bindings -- re-run generator after fixing header
3. Duplicate struct definition in Julia (csv.h was not deleted before generation) -- delete csv.h and regenerate
  </action>
  <verify>
1. `./build/bin/quiver_tests.exe` exits 0 with 442+ tests passing
2. `./build/bin/quiver_c_tests.exe` exits 0 with 282+ tests passing
3. `bindings/julia/test/test.bat` exits 0 with all tests passing
4. `bindings/dart/test/test.bat` exits 0 with all tests passing
  </verify>
  <done>
All four test suites (C++ core, C API, Julia, Dart) pass with zero regressions. The header consolidation is verified end-to-end.
  </done>
</task>

</tasks>

<verification>
1. `quiver_csv_export_options_t` appears exactly once in both generated binding files
2. All 6 struct fields present in both binding files
3. C++ tests: 442+ pass
4. C API tests: 282+ pass
5. Julia tests: all pass (including 19 CSV)
6. Dart tests: all pass (including 5 CSV)
</verification>

<success_criteria>
- Julia c_api.jl contains one quiver_csv_export_options_t definition with 6 fields, sourced from options.h
- Dart bindings.dart contains one quiver_csv_export_options_t definition with 6 fields
- All C++ core tests pass
- All C API tests pass
- All Julia tests pass (including CSV export tests)
- All Dart tests pass (including CSV export tests)
</success_criteria>

<output>
After completion, create `.planning/phases/09-header-consolidation/09-02-SUMMARY.md`
</output>
