---
phase: 13-dart-binding-migration
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - bindings/dart/test/database_time_series_test.dart
  - bindings/dart/test/database_create_test.dart
autonomous: true
requirements: [BIND-03, BIND-04]

must_haves:
  truths:
    - "Existing Dart time series tests pass with the new Map-based interface"
    - "Multi-column mixed-type tests verify INTEGER, REAL, and TEXT value columns through Dart"
    - "DateTime dimension column is correctly parsed on read and accepted on update"
    - "Empty map clear semantics are tested"
    - "Create test assertions work with new readTimeSeriesGroup return format"
  artifacts:
    - path: "bindings/dart/test/database_time_series_test.dart"
      provides: "Rewritten time series tests + multi-column mixed-type tests"
      contains: "mixed_time_series.sql"
    - path: "bindings/dart/test/database_create_test.dart"
      provides: "Fixed time series assertions for Map return format"
      contains: "readTimeSeriesGroup"
  key_links:
    - from: "bindings/dart/test/database_time_series_test.dart"
      to: "bindings/dart/lib/src/database_update.dart"
      via: "db.updateTimeSeriesGroup with Map parameter"
      pattern: "updateTimeSeriesGroup.*\\{.*:.*\\[.*\\]"
    - from: "bindings/dart/test/database_time_series_test.dart"
      to: "bindings/dart/lib/src/database_read.dart"
      via: "db.readTimeSeriesGroup returning Map"
      pattern: "result\\['.*'\\]"
    - from: "bindings/dart/test/database_time_series_test.dart"
      to: "tests/schemas/valid/mixed_time_series.sql"
      via: "Schema reference for multi-column tests"
      pattern: "mixed_time_series\\.sql"
---

<objective>
Rewrite all Dart time series tests for the new Map-based interface and add multi-column mixed-type test coverage.

Purpose: Verify the Dart binding migration works correctly end-to-end with both single-column and multi-column schemas, including DateTime parsing, strict types, and edge cases.
Output: Passing Dart test suite with comprehensive time series coverage matching Julia Phase 12 test patterns.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-dart-binding-migration/13-CONTEXT.md
@.planning/phases/13-dart-binding-migration/13-01-SUMMARY.md
@.planning/phases/12-julia-binding-migration/12-02-SUMMARY.md

@bindings/dart/test/database_time_series_test.dart
@bindings/dart/test/database_create_test.dart
@bindings/julia/test/test_database_time_series.jl
@tests/schemas/valid/mixed_time_series.sql
@tests/schemas/valid/collections.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite existing time series tests for Map-based interface</name>
  <files>
    bindings/dart/test/database_time_series_test.dart
    bindings/dart/test/database_create_test.dart
  </files>
  <action>
**Part A: Rewrite `database_time_series_test.dart` Time Series Read and Update groups.**

The existing tests use the old row-oriented interface:
- Update: `db.updateTimeSeriesGroup('Collection', 'data', id, [{'date_time': '...', 'value': 1.5}])`
- Read: `rows[0]['date_time']` and `rows[0]['value']`

Rewrite to the new Map-based columnar interface:
- Update: `db.updateTimeSeriesGroup('Collection', 'data', id, {'date_time': ['...'], 'value': [1.5]})`
- Read: `result['date_time'][0]` and `result['value'][0]`

Specific test rewrites:

1. **"readTimeSeriesGroup returns ordered rows"**: Change update call to Map format (`{'date_time': [...], 'value': [...]}`). Change read assertions from `rows[0]['date_time']` to `result['date_time'][0]`. Note: dimension column (`date_time`) now returns `List<DateTime>` so compare with `DateTime` objects, not strings. Value column (`value`) returns `List<double>`.

2. **"readTimeSeriesGroup returns empty for no data"**: Read result is now `Map<String, List<Object>>`. Assert `result.isEmpty` (empty map).

3. **"updateTimeSeriesGroup replaces all rows"**: Change both update calls to Map format. Assertions use `result['date_time'][0]` (DateTime) and `result['value'][0]` (double).

4. **"updateTimeSeriesGroup clears data with empty list"**: Change clear call from `db.updateTimeSeriesGroup(..., [])` to `db.updateTimeSeriesGroup(..., {})` (empty Map per user decision). Assert `result.isEmpty`.

5. **"time series data is ordered by date_time"**: Change update call to Map format (out-of-order dates). Assert ordering via `result['date_time'][0]`, `result['date_time'][1]`, `result['date_time'][2]` as DateTime objects.

The Metadata and Files test groups do NOT need changes -- they don't touch readTimeSeriesGroup/updateTimeSeriesGroup.

**Part B: Fix `database_create_test.dart` time series assertions.**

The "Create With Multiple Time Series Groups" test group uses `readTimeSeriesGroup` with old row-based return format:
```dart
final tempRows = db.readTimeSeriesGroup('Sensor', 'temperature', id);
expect(tempRows[0]['date_time'], equals('2024-01-01T10:00:00'));
expect(tempRows[0]['temperature'], equals(20.0));
```

Must change to Map-based columnar format:
```dart
final tempResult = db.readTimeSeriesGroup('Sensor', 'temperature', id);
expect(tempResult['date_time']![0], equals(DateTime(2024, 1, 1, 10, 0, 0)));
expect(tempResult['temperature']![0], equals(20.0));
```

Fix both tests in this group:
1. **"creates element with shared dimension across two time series tables"**: Update assertions for both temperature and humidity groups to use `result['column'][index]` pattern with DateTime comparisons for dimension column.
2. **"rejects mismatched lengths across time series groups"**: This test only calls `createElement` and expects a throw -- no readTimeSeriesGroup usage, so it should need NO changes. Verify this.

**DateTime comparison pattern**: When comparing dimension column values, use `DateTime(year, month, day, hour, minute, second)` constructor. For example:
```dart
expect(result['date_time']![0], equals(DateTime(2024, 1, 1, 10, 0, 0)));
```
  </action>
  <verify>
Run `bindings/dart/test/test.bat` and verify all Dart tests pass. Specifically check that the Time Series Read, Time Series Update, and Create With Multiple Time Series Groups test groups all pass.
  </verify>
  <done>
All existing Dart time series and create tests rewritten for Map-based interface and passing. DateTime dimension column correctly compared as DateTime objects. Empty-map clear semantics tested.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add multi-column mixed-type time series tests</name>
  <files>
    bindings/dart/test/database_time_series_test.dart
  </files>
  <action>
Add a new test group "Multi-Column Time Series" at the end of `database_time_series_test.dart`, using the `mixed_time_series.sql` schema (Sensor collection with `readings` group having `date_time` TEXT, `temperature` REAL, `humidity` INTEGER, `status` TEXT columns).

Add the following tests (mirroring Julia Phase 12 patterns from `test_database_time_series.jl`):

1. **"multi-column update and read with mixed types"**: Create Sensor, update with `{'date_time': ['2024-01-01T10:00:00', '2024-01-01T11:00:00'], 'temperature': [20.5, 21.3], 'humidity': [45, 50], 'status': ['normal', 'high']}`. Read back and verify:
   - `result.length == 4` (4 columns)
   - `result['date_time']` is `List<DateTime>` with correct values
   - `result['temperature']` is `List<double>` with `[20.5, 21.3]`
   - `result['humidity']` is `List<int>` with `[45, 50]`
   - `result['status']` is `List<String>` with `['normal', 'high']`

2. **"multi-column read returns empty map for no data"**: Create Sensor without data. Read and assert `result.isEmpty`.

3. **"multi-column update replaces all rows"**: Update twice, verify second update fully replaces first.

4. **"multi-column clear with empty map"**: Update then clear with `{}`. Verify `result.isEmpty`.

5. **"multi-column ordering by dimension column"**: Insert out-of-order dates, verify read returns them sorted.

6. **"DateTime dimension column round-trip"**: Update with string dates, read back as DateTime objects, verify equality.

7. **"update with DateTime objects in dimension column"**: Use `DateTime(2024, 1, 1, 10, 0, 0)` objects in the dimension column list. Read back and verify they round-trip correctly.

8. **"rejects mismatched list lengths"**: Pass columns with different list lengths, expect `ArgumentError` thrown.

Each test follows this pattern:
```dart
test('test name', () {
  final db = Database.fromSchema(
    ':memory:',
    path.join(testsPath, 'schemas', 'valid', 'mixed_time_series.sql'),
  );
  try {
    db.createElement('Configuration', {'label': 'Test Config'});
    final id = db.createElement('Sensor', {'label': 'Sensor 1'});
    // ... test logic ...
  } finally {
    db.close();
  }
});
```

NOTE: `humidity` is INTEGER in the schema. Dart must pass `List<int>` values (strict types, no auto-coercion). If the C API rejects `int` for an INTEGER column, there may be a type enum mismatch to debug -- but this should work correctly since Phase 11 supports INTEGER columns.
  </action>
  <verify>
Run `bindings/dart/test/test.bat` and verify ALL Dart tests pass. Check test output for the new "Multi-Column Time Series" group specifically. Final full-suite verification: if `scripts/test-all.bat` is available, run it to confirm no regressions across C++, C API, Julia, and Dart.
  </verify>
  <done>
Multi-column mixed-type tests pass with INTEGER, REAL, and TEXT value columns. DateTime round-trip verified. Row count mismatch validation tested. Full Dart test suite green.
  </done>
</task>

</tasks>

<verification>
1. All existing Dart time series tests pass with new Map-based interface
2. All existing Dart create tests pass with updated readTimeSeriesGroup return format
3. New multi-column tests pass with mixed types (INTEGER + REAL + TEXT)
4. DateTime dimension column correctly round-trips through update/read
5. Empty map clear semantics work correctly
6. Row count mismatch throws ArgumentError
7. Full Dart test suite passes via `bindings/dart/test/test.bat`
</verification>

<success_criteria>
- All existing Dart tests pass (no regressions)
- 8+ new multi-column tests pass covering mixed types, DateTime, edge cases
- Test coverage mirrors Julia Phase 12 patterns
- Full test suite green
</success_criteria>

<output>
After completion, create `.planning/phases/13-dart-binding-migration/13-02-SUMMARY.md`
</output>
