---
phase: 09-csv-import-and-options
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - bindings/python/src/quiverdb/database.py
  - bindings/python/tests/test_database_csv.py
autonomous: true
requirements: [CSV-01, CSV-03]

must_haves:
  truths:
    - "User can call import_csv on a Python Database instance to load CSV data into a collection"
    - "Scalar CSV round-trip works: export -> import into fresh DB -> read back matches original"
    - "Group (vector) CSV round-trip works: export -> import into fresh DB -> read back matches original"
    - "Enum label resolution works on import: CSV with string labels imports as integer values"
    - "import_csv no longer raises NotImplementedError"
  artifacts:
    - path: "bindings/python/src/quiverdb/database.py"
      provides: "import_csv method calling quiver_database_import_csv C API"
      contains: "def import_csv"
    - path: "bindings/python/tests/test_database_csv.py"
      provides: "Import round-trip tests covering scalar, group, and enum paths"
      contains: "TestImportCSV"
  key_links:
    - from: "bindings/python/src/quiverdb/database.py"
      to: "C API quiver_database_import_csv"
      via: "lib.quiver_database_import_csv call"
      pattern: "quiver_database_import_csv"
    - from: "bindings/python/src/quiverdb/database.py"
      to: "_marshal_csv_options"
      via: "shared marshaler from Plan 01"
      pattern: "_marshal_csv_options"
---

<objective>
Implement import_csv in the Python binding by calling the real C API function, and add round-trip tests covering scalar import, group import, and enum resolution import.

Purpose: Complete CSV round-trip capability in the Python binding, bringing it to parity with Julia and Dart. The C++ implementation and C API are fully complete -- this is purely a binding-layer change.
Output: Working import_csv method, 3+ import test classes, TestImportCSVStub removed
</objective>

<execution_context>
@C:/Users/rsampaio/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rsampaio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-csv-import-and-options/09-CONTEXT.md
@.planning/phases/09-csv-import-and-options/09-RESEARCH.md
@.planning/phases/09-csv-import-and-options/09-01-SUMMARY.md

@bindings/python/src/quiverdb/database.py
@bindings/python/tests/test_database_csv.py
@bindings/python/tests/conftest.py
@tests/schemas/valid/csv_export.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement import_csv method replacing NotImplementedError stub</name>
  <files>bindings/python/src/quiverdb/database.py</files>
  <action>
Replace the existing `import_csv` stub (lines ~1138-1146) with a real implementation:

```python
def import_csv(
    self, collection: str, group: str, path: str, *,
    options: CSVOptions | None = None,
) -> None:
    """Import CSV data into a collection."""
    self._ensure_open()
    lib = get_lib()
    if options is None:
        options = CSVOptions()
    keepalive, c_opts = _marshal_csv_options(options)
    check(lib.quiver_database_import_csv(
        self._ptr, collection.encode("utf-8"), group.encode("utf-8"),
        path.encode("utf-8"), c_opts))
```

Key changes from the stub:
- Signature changes from `(self, table: str, path: str)` to `(self, collection: str, group: str, path: str, *, options: CSVOptions | None = None)`
- `collection`, `group`, `path` are required positional parameters (per locked decision)
- `group` is required -- pass `''` for scalar-only imports (matches Julia/Dart)
- `options` is keyword-only with `None` default
- Returns `None` -- errors raise exceptions via `check()`
- Uses the shared `_marshal_csv_options` from Plan 01 (same marshaler for both export and import)
- The `check()` function will raise `QuiverError` on C API errors

Do NOT add any Python-side validation -- let C API handle errors per project principles.
  </action>
  <verify>
    <automated>cd C:/Development/DatabaseTmp/quiver && python -c "from quiverdb import Database; print(hasattr(Database, 'import_csv'))"</automated>
  </verify>
  <done>import_csv method exists on Database class with correct signature (collection, group, path, *, options=None). No longer raises NotImplementedError. Calls quiver_database_import_csv via C API.</done>
</task>

<task type="auto">
  <name>Task 2: Add import round-trip tests and remove NotImplementedError stub test</name>
  <files>bindings/python/tests/test_database_csv.py</files>
  <action>
1. **Remove `TestImportCSVStub` class entirely** (the stub test that expects `NotImplementedError`). It will fail now that `import_csv` works.

2. **Add `TestImportCSVScalarRoundTrip` class** with a test that:
   - Creates 2 elements in csv_db with all scalar fields (label, name, status, price, date_created, notes)
   - Exports scalars to CSV: `csv_db.export_csv("Items", "", csv_path)`
   - Creates a fresh database from the same schema: `db2 = Database.from_schema(str(tmp_path / "csv2.db"), str(csv_export_schema_path))`
   - Imports the CSV: `db2.import_csv("Items", "", csv_path)`
   - Reads back and verifies: names match, status values match, prices match, notes match
   - Closes db2 in a try/finally block
   - The test method should accept `csv_db`, `tmp_path`, and `csv_export_schema_path` fixtures

3. **Add `TestImportCSVGroupRoundTrip` class** with a test that:
   - Creates 2 elements in csv_db
   - Updates vector floats: `csv_db.update_vector_floats("Items", "measurement", 1, [1.1, 2.2, 3.3])` and `csv_db.update_vector_floats("Items", "measurement", 2, [4.4, 5.5])`
   - Exports vector group to CSV: `csv_db.export_csv("Items", "measurements", csv_path)`
   - Creates a fresh database, imports the CSV with group: `db2.import_csv("Items", "measurements", csv_path)`
   - Reads back vector data and verifies values match
   - Closes db2 in try/finally

4. **Add `TestImportCSVEnumResolution` class** with a test that:
   - Writes a CSV file manually with enum string values in the status column:
     ```
     sep=,
     label,name,status,price,date_created,notes
     Item1,Alpha,Active,,,
     ```
   - Imports with enum options: `CSVOptions(enum_labels={"status": {"en": {"Active": 1, "Inactive": 2}}})`
   - Call: `csv_db.import_csv("Items", "", csv_path, options=opts)`
   - Reads back `status` via `read_scalar_integer_by_id` and verifies it equals `1`
   - This tests that the C API resolves string labels to integer values during import

5. Place new test classes after the existing export test classes, before the helper function `_read_file`.

6. Import `CSVOptions` is already imported from Plan 01 changes (verify it says `from quiverdb import CSVOptions, Database, Element`).
  </action>
  <verify>
    <automated>cd C:/Development/DatabaseTmp/quiver && bindings/python/test/test.bat</automated>
    <manual>Verify import tests appear in output: pytest should show TestImportCSVScalarRoundTrip, TestImportCSVGroupRoundTrip, TestImportCSVEnumResolution passing</manual>
  </verify>
  <done>All Python tests pass including 3 new import test classes. TestImportCSVStub is removed. Scalar round-trip verifies all field types. Group round-trip verifies vector data. Enum resolution verifies string-to-integer mapping on import.</done>
</task>

</tasks>

<verification>
1. `bindings/python/test/test.bat` -- all Python tests pass (export + import tests, no regressions)
2. `python -c "from quiverdb import Database, CSVOptions; help(Database.import_csv)"` -- shows correct signature
3. Confirm `NotImplementedError` no longer raised by import_csv
</verification>

<success_criteria>
- import_csv calls quiver_database_import_csv C API (not a stub)
- Signature is (collection, group, path, *, options=None) matching Julia/Dart
- Scalar round-trip test: export -> import -> read back matches
- Group round-trip test: export vector -> import -> read back matches
- Enum resolution test: CSV with string labels imports as integers
- TestImportCSVStub removed
- All Python tests pass (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/09-csv-import-and-options/09-02-SUMMARY.md`
</output>
