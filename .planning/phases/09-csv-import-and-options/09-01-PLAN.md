---
phase: 09-csv-import-and-options
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bindings/python/src/quiverdb/metadata.py
  - bindings/python/src/quiverdb/database.py
  - bindings/python/src/quiverdb/__init__.py
  - bindings/python/tests/test_database_csv.py
  - CLAUDE.md
autonomous: true
requirements: [CSV-02, CSV-04]

must_haves:
  truths:
    - "CSVOptions class exists with 3-level enum_labels dict (attribute -> locale -> label -> value)"
    - "CSVExportOptions name does not exist anywhere in the codebase"
    - "export_csv accepts options as keyword-only argument"
    - "Existing export tests pass with the new CSVOptions structure"
    - "CLAUDE.md has no stale CSVExportOptions references"
  artifacts:
    - path: "bindings/python/src/quiverdb/metadata.py"
      provides: "CSVOptions frozen dataclass with dict[str, dict[str, dict[str, int]]] enum_labels"
      contains: "class CSVOptions"
    - path: "bindings/python/src/quiverdb/database.py"
      provides: "_marshal_csv_options with 3-level dict flattening into grouped parallel arrays"
      contains: "_marshal_csv_options"
    - path: "bindings/python/src/quiverdb/__init__.py"
      provides: "CSVOptions in exports"
      contains: "CSVOptions"
    - path: "bindings/python/tests/test_database_csv.py"
      provides: "Updated export tests using CSVOptions with 3-level dict"
      contains: "CSVOptions"
  key_links:
    - from: "bindings/python/src/quiverdb/database.py"
      to: "bindings/python/src/quiverdb/metadata.py"
      via: "import CSVOptions"
      pattern: "from.*metadata.*import.*CSVOptions"
    - from: "bindings/python/src/quiverdb/database.py"
      to: "C API quiver_csv_options_t"
      via: "_marshal_csv_options flattening"
      pattern: "enum_group_count"
---

<objective>
Rename CSVExportOptions to CSVOptions, restructure enum_labels from 2-level dict (attribute -> int -> str) to 3-level dict (attribute -> locale -> label -> value), rewrite the marshaler for 3-level flattening, make export_csv options keyword-only, and update all existing export tests to use the new structure.

Purpose: Align the Python binding's CSV options type with the C++/Julia/Dart structure. This is a prerequisite for implementing import_csv in Plan 02, which shares the same options type and marshaler.
Output: CSVOptions class, _marshal_csv_options function, updated export_csv, passing export tests, clean CLAUDE.md
</objective>

<execution_context>
@C:/Users/rsampaio/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rsampaio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-csv-import-and-options/09-CONTEXT.md
@.planning/phases/09-csv-import-and-options/09-RESEARCH.md

@bindings/python/src/quiverdb/metadata.py
@bindings/python/src/quiverdb/database.py
@bindings/python/src/quiverdb/__init__.py
@bindings/python/tests/test_database_csv.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename CSVExportOptions to CSVOptions and restructure enum_labels type</name>
  <files>
    bindings/python/src/quiverdb/metadata.py
    bindings/python/src/quiverdb/__init__.py
  </files>
  <action>
In `metadata.py`:
- Rename the `CSVExportOptions` class to `CSVOptions`
- Update the docstring to `"""Options for CSV import and export operations."""`
- Change the `enum_labels` type annotation from `dict[str, dict[int, str]]` to `dict[str, dict[str, dict[str, int]]]`
- Keep `date_time_format: str = ""` unchanged
- Keep `@dataclass(frozen=True)` unchanged

In `__init__.py`:
- Change the import from `CSVExportOptions` to `CSVOptions`: `from quiverdb.metadata import CSVOptions, GroupMetadata, ScalarMetadata`
- Replace `"CSVExportOptions"` with `"CSVOptions"` in the `__all__` list
- Do NOT add any alias for the old name (per locked decision: no backwards compatibility)
  </action>
  <verify>
    <automated>cd C:/Development/DatabaseTmp/quiver && python -c "from quiverdb import CSVOptions; o = CSVOptions(enum_labels={'status': {'en': {'Active': 1}}}); print(o)"</automated>
  </verify>
  <done>CSVOptions class exists with 3-level enum_labels type, importable from quiverdb. CSVExportOptions name does not exist in metadata.py or __init__.py.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite marshaler, update export_csv signature, update existing tests, check CLAUDE.md</name>
  <files>
    bindings/python/src/quiverdb/database.py
    bindings/python/tests/test_database_csv.py
    CLAUDE.md
  </files>
  <action>
In `database.py`:

1. Update the import at the top of the file: change `CSVExportOptions` to `CSVOptions` in the import from `quiverdb.metadata`.

2. Replace the `_marshal_csv_export_options` function (lines ~1416-1477) with a new `_marshal_csv_options` function that handles 3-level dict flattening. The new function:
   - Accepts `CSVOptions` (not `CSVExportOptions`)
   - Returns `(keepalive, c_opts)` tuple (same pattern)
   - For `enum_labels`, iterates attribute -> locale -> entries, where each (attribute, locale) pair is a separate group
   - `group_count = sum(len(locales) for locales in enum_labels.values())` -- NOT `len(enum_labels)`
   - `enum_attribute_names[i]` = attribute name (repeated for each locale of that attribute)
   - `enum_locale_names[i]` = locale name
   - `enum_entry_counts[i]` = number of entries in that (attribute, locale) group
   - `enum_labels[j]` = label strings (concatenated across all groups)
   - `enum_values[j]` = integer values (concatenated across all groups)
   - Use the exact code from the RESEARCH.md "New _marshal_csv_options Function" section as reference

3. Update `export_csv` method:
   - Change signature to make `options` keyword-only: `def export_csv(self, collection: str, group: str, path: str, *, options: CSVOptions | None = None) -> None:`
   - Note the `*` before `options` parameter
   - Change the default from `CSVExportOptions()` to `CSVOptions()`
   - Change the marshaler call from `_marshal_csv_export_options` to `_marshal_csv_options`

4. Update ALL references to `CSVExportOptions` in database.py to `CSVOptions` (type hints, docstrings, etc.)

In `test_database_csv.py`:

1. Change the import from `CSVExportOptions` to `CSVOptions`: `from quiverdb import CSVOptions, Database, Element`

2. Update `TestExportCSVWithEnumLabels.test_export_csv_with_enum_labels`:
   - Old: `CSVExportOptions(enum_labels={"status": {1: "Active", 2: "Inactive"}})`
   - New: `CSVOptions(enum_labels={"status": {"en": {"Active": 1, "Inactive": 2}}})`
   - Old call: `csv_db.export_csv("Items", "", out, opts)`
   - New call: `csv_db.export_csv("Items", "", out, options=opts)`

3. Update `TestExportCSVWithDateFormat.test_export_csv_with_date_format`:
   - Old: `CSVExportOptions(date_time_format="%Y/%m/%d")`
   - New: `CSVOptions(date_time_format="%Y/%m/%d")`
   - The call already uses positional-only for the first 3 args, no options= needed (options is None by default)

4. Update `TestExportCSVWithEnumAndDate.test_export_csv_with_enum_and_date`:
   - Old: `CSVExportOptions(date_time_format="%Y-%m-%d", enum_labels={"status": {1: "Active"}})`
   - New: `CSVOptions(date_time_format="%Y-%m-%d", enum_labels={"status": {"en": {"Active": 1}}})`
   - Old call: `csv_db.export_csv("Items", "", out, opts)`
   - New call: `csv_db.export_csv("Items", "", out, options=opts)`

5. Update `TestCSVExportOptionsDefaults`:
   - Rename class to `TestCSVOptionsDefaults`
   - Update `test_default_options`: `CSVExportOptions()` -> `CSVOptions()`
   - Update `test_custom_options`:
     - Old: `CSVExportOptions(date_time_format="%Y", enum_labels={"status": {1: "Active"}})`
     - New: `CSVOptions(date_time_format="%Y", enum_labels={"status": {"en": {"Active": 1}}})`
     - Update assertion: `assert opts.enum_labels == {"status": {"en": {"Active": 1}}}`

6. Update module docstring from "export_csv, import_csv stub" to "CSV export and import operations"

For CLAUDE.md:
- Search for any occurrence of `CSVExportOptions` in CLAUDE.md. Based on research, CLAUDE.md already uses `CSVOptions` throughout (C++ naming). Verify this is true and no Python-specific references need updating. If any `CSVExportOptions` references exist, replace them with `CSVOptions`.
  </action>
  <verify>
    <automated>cd C:/Development/DatabaseTmp/quiver && bindings/python/test/test.bat</automated>
    <manual>Verify no "CSVExportOptions" string exists anywhere in the codebase: grep -r "CSVExportOptions" bindings/python/ CLAUDE.md</manual>
  </verify>
  <done>All existing CSV export tests pass using CSVOptions with 3-level enum_labels. export_csv uses keyword-only options parameter. No CSVExportOptions references remain in Python binding or CLAUDE.md. _marshal_csv_options correctly flattens 3-level dict into grouped parallel arrays.</done>
</task>

</tasks>

<verification>
1. `bindings/python/test/test.bat` -- all Python tests pass (no regressions)
2. `grep -r "CSVExportOptions" bindings/python/ CLAUDE.md` -- returns no matches
3. `python -c "from quiverdb import CSVOptions; print(CSVOptions())"` -- imports successfully
</verification>

<success_criteria>
- CSVOptions class exists with `dict[str, dict[str, dict[str, int]]]` enum_labels type
- CSVExportOptions name completely removed from codebase
- export_csv accepts options as keyword-only argument
- All existing export tests pass with updated enum_labels structure (3-level dict with str->int direction)
- _marshal_csv_options correctly handles multi-locale enum labels
- CLAUDE.md has no stale CSVExportOptions references
</success_criteria>

<output>
After completion, create `.planning/phases/09-csv-import-and-options/09-01-SUMMARY.md`
</output>
