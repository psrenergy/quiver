---
phase: 04-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - include/quiver/database.h
  - include/quiver/c/database.h
  - src/database_relations.cpp
  - src/c/database_relations.cpp
  - src/CMakeLists.txt
  - src/lua_runner.cpp
  - tests/test_database_relations.cpp
  - tests/test_database_create.cpp
  - tests/test_database_errors.cpp
  - tests/test_c_api_database_lifecycle.cpp
  - tests/test_lua_runner.cpp
  - tests/CMakeLists.txt
autonomous: true
requirements: [CLN-01]
must_haves:
  truths:
    - "update_scalar_relation and read_scalar_relation declarations are removed from C++ and C API headers"
    - "No C++ or C API source files reference update_scalar_relation or read_scalar_relation"
    - "FK resolution tests (9 tests) are relocated to test_database_create.cpp and pass"
    - "C++ tests and C API tests build and pass with zero relation method references"
  artifacts:
    - path: "include/quiver/database.h"
      provides: "Database class without relation method declarations"
    - path: "include/quiver/c/database.h"
      provides: "C API header without relation function declarations"
    - path: "tests/test_database_create.cpp"
      provides: "FK resolution tests relocated from test_database_relations.cpp"
      contains: "ResolveFkLabelInSetCreate"
  key_links:
    - from: "tests/test_database_create.cpp"
      to: "include/quiver/database.h"
      via: "FK resolution tests use create_element (not relation methods)"
      pattern: "create_element"
---

<objective>
Remove `update_scalar_relation` and `read_scalar_relation` from the C++ core, C API, Lua binding, and all C++/C API test files. Relocate the 9 FK resolution tests from `test_database_relations.cpp` to `test_database_create.cpp` before deleting the file.

Purpose: Eliminate redundant relation methods now that FK label resolution works through `create_element` and `update_element`. This is the first half of the clean sweep -- core layers and tests.
Output: C++ and C API layers fully cleaned of relation methods; FK resolution test coverage preserved.
</objective>

<execution_context>
@C:/Users/rsampaio/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rsampaio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cleanup/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove relation methods from C++ core, C API, Lua, and CMakeLists</name>
  <files>
    include/quiver/database.h
    include/quiver/c/database.h
    src/database_relations.cpp
    src/c/database_relations.cpp
    src/CMakeLists.txt
    src/lua_runner.cpp
  </files>
  <action>
    Delete the following implementation files entirely:
    - `src/database_relations.cpp`
    - `src/c/database_relations.cpp`

    Edit `include/quiver/database.h`: Remove the `update_scalar_relation` and `read_scalar_relation` declarations (under the "Relation operations" comment, around lines 47-53). Remove the section comment too.

    Edit `include/quiver/c/database.h`: Remove `quiver_database_update_scalar_relation` and `quiver_database_read_scalar_relation` declarations (under the "Relation operations" comment, around lines 72-84). Remove the section comment too.

    Edit `src/CMakeLists.txt`:
    - Remove `database_relations.cpp` from the QUIVER_SOURCES list (around line 11)
    - Remove `c/database_relations.cpp` from the quiver_c sources list (around line 105)

    Edit `src/lua_runner.cpp`:
    - Remove the "Group 6: Relations" registration block (around lines 256-268). This includes the `"update_scalar_relation"` and `"read_scalar_relation"` lambda registrations. Watch comma handling -- the preceding Group 5 entry's closing should connect directly to whatever follows Group 6 (likely "Group 7: Time series metadata").
    - Remove the `read_scalar_relation_to_lua` helper function and its "Relations" section comment (around lines 1036-1051).
  </action>
  <verify>
    Run: `cmake --build build --config Debug 2>&1 | tail -20` -- should build without errors.
    Run: `grep -r "update_scalar_relation\|read_scalar_relation" src/ include/ --include="*.cpp" --include="*.h"` -- should return nothing.
  </verify>
  <done>
    Both relation methods are completely removed from C++ headers, C API headers, implementations, CMakeLists, and Lua binding. The core libraries build successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Relocate FK resolution tests and remove all relation test code</name>
  <files>
    tests/test_database_relations.cpp
    tests/test_database_create.cpp
    tests/test_database_errors.cpp
    tests/test_c_api_database_lifecycle.cpp
    tests/test_lua_runner.cpp
    tests/CMakeLists.txt
  </files>
  <action>
    **Step 1 -- Relocate FK resolution tests:**
    Copy lines 187-421 from `tests/test_database_relations.cpp` (the 9 FK resolution tests starting from "FK label resolution (resolve_fk_label helper)") and append them to the end of `tests/test_database_create.cpp`. Keep the section header comments. Ensure `#include <algorithm>` is already present in `test_database_create.cpp` (it is -- line 3).

    The 9 tests to relocate:
    - `ResolveFkLabelInSetCreate`
    - `ResolveFkLabelMissingTarget`
    - `RejectStringForNonFkIntegerColumn`
    - `CreateElementScalarFkLabel`
    - `CreateElementVectorFkLabels`
    - `CreateElementTimeSeriesFkLabels`
    - `CreateElementAllFkTypesInOneCall`
    - `CreateElementNoFkColumnsUnchanged`
    - `ScalarFkResolutionFailureCausesNoPartialWrites`

    **Step 2 -- Delete relation test file:**
    Delete `tests/test_database_relations.cpp` entirely.

    **Step 3 -- Remove from tests/CMakeLists.txt:**
    Remove `test_database_relations.cpp` from the quiver_tests sources list (around line 12).

    **Step 4 -- Remove relation error tests:**
    Edit `tests/test_database_errors.cpp`: Remove the 7 relation error tests (around lines 181-243): `SetScalarRelationNoSchema`, `SetScalarRelationBadCollection`, `SetScalarRelationBadAttribute`, `SetScalarRelationBadElement`, `SetScalarRelationNotForeignKey`, `ReadScalarRelationBadAttribute`, `ReadScalarRelationNotForeignKey`. Remove the section comment header for that block too.

    **Step 5 -- Remove C API relation tests:**
    Edit `tests/test_c_api_database_lifecycle.cpp`: Remove ALL relation operation tests (around lines 259-442). This includes null-check tests and valid operation tests for both `quiver_database_update_scalar_relation` and `quiver_database_read_scalar_relation`.

    **Step 6 -- Remove Lua relation tests:**
    Edit `tests/test_lua_runner.cpp`: Remove the `LuaRunnerRelationsTest` fixture class and its 2 test methods (around lines 1305-1346).
  </action>
  <verify>
    Run: `cmake --build build --config Debug 2>&1 | tail -20` -- should build without errors.
    Run: `./build/bin/quiver_tests.exe --gtest_filter="*Fk*:*FK*:*fk*"` -- should show the 9 relocated FK tests passing.
    Run: `./build/bin/quiver_tests.exe` -- all tests pass.
    Run: `./build/bin/quiver_c_tests.exe` -- all tests pass.
    Run: `grep -r "update_scalar_relation\|read_scalar_relation" tests/ --include="*.cpp"` -- should return nothing.
  </verify>
  <done>
    All 9 FK resolution tests are preserved in `test_database_create.cpp` and pass. All relation method test code is removed from `test_database_relations.cpp` (deleted), `test_database_errors.cpp`, `test_c_api_database_lifecycle.cpp`, and `test_lua_runner.cpp`. Tests build and pass across both C++ and C API test suites.
  </done>
</task>

</tasks>

<verification>
1. `cmake --build build --config Debug` succeeds
2. `./build/bin/quiver_tests.exe` -- all tests pass, no relation method tests remain
3. `./build/bin/quiver_c_tests.exe` -- all tests pass, no relation tests remain
4. `grep -r "update_scalar_relation\|read_scalar_relation" src/ include/ tests/ --include="*.cpp" --include="*.h"` returns empty
5. FK resolution tests (`*Fk*`, `*FK*`) still present and passing in `test_database_create.cpp`
</verification>

<success_criteria>
- Zero references to `update_scalar_relation` or `read_scalar_relation` in C++ core, C API, Lua, and test layers
- `src/database_relations.cpp` and `src/c/database_relations.cpp` deleted
- `tests/test_database_relations.cpp` deleted
- 9 FK resolution tests relocated to `test_database_create.cpp` and passing
- Both test suites (quiver_tests, quiver_c_tests) pass green
</success_criteria>

<output>
After completion, create `.planning/phases/04-cleanup/04-01-SUMMARY.md`
</output>
