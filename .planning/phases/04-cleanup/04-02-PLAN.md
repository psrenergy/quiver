---
phase: 04-cleanup
plan: 02
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - bindings/julia/src/database_create.jl
  - bindings/julia/src/database_read.jl
  - bindings/julia/src/c_api.jl
  - bindings/julia/test/test_database_relations.jl
  - bindings/dart/lib/src/database.dart
  - bindings/dart/lib/src/database_relations.dart
  - bindings/dart/lib/src/ffi/bindings.dart
  - bindings/dart/test/database_relations_test.dart
  - CLAUDE.md
autonomous: true
requirements: [CLN-01]
must_haves:
  truths:
    - "No Julia or Dart source files reference update_scalar_relation or read_scalar_relation"
    - "FFI bindings are regenerated from updated C headers (no stale references)"
    - "Julia tests and Dart tests pass with no relation test files"
    - "CLAUDE.md has no references to relation methods"
    - "Full build-all.bat passes green across all layers"
  artifacts:
    - path: "bindings/julia/src/c_api.jl"
      provides: "Regenerated Julia FFI without relation function bindings"
    - path: "bindings/dart/lib/src/ffi/bindings.dart"
      provides: "Regenerated Dart FFI without relation function bindings"
    - path: "CLAUDE.md"
      provides: "Documentation with all relation method references removed"
  key_links:
    - from: "bindings/julia/src/c_api.jl"
      to: "include/quiver/c/database.h"
      via: "FFI generation from C header"
      pattern: "quiver_database"
    - from: "bindings/dart/lib/src/ffi/bindings.dart"
      to: "include/quiver/c/database.h"
      via: "ffigen from C header"
      pattern: "quiver_database"
---

<objective>
Remove `update_scalar_relation` and `read_scalar_relation` from Julia and Dart bindings, regenerate FFI bindings, delete binding test files, clean CLAUDE.md, and validate everything with `scripts/build-all.bat`.

Purpose: Complete the clean sweep by removing relation methods from all binding layers and documentation. Depends on Plan 01 having already cleaned the C++ core and C API headers.
Output: All layers clean; full test suite passes across C++, C API, Julia, and Dart.
</objective>

<execution_context>
@C:/Users/rsampaio/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rsampaio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cleanup/04-RESEARCH.md
@.planning/phases/04-cleanup/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove relation methods from Julia and Dart bindings and regenerate FFI</name>
  <files>
    bindings/julia/src/database_create.jl
    bindings/julia/src/database_read.jl
    bindings/julia/src/c_api.jl
    bindings/julia/test/test_database_relations.jl
    bindings/dart/lib/src/database.dart
    bindings/dart/lib/src/database_relations.dart
    bindings/dart/lib/src/ffi/bindings.dart
    bindings/dart/test/database_relations_test.dart
  </files>
  <action>
    **Step 1 -- Julia source cleanup:**
    Edit `bindings/julia/src/database_create.jl`: Remove the `update_scalar_relation!` function (around lines 19-28).
    Edit `bindings/julia/src/database_read.jl`: Remove the `read_scalar_relation` function (around lines 1-24).

    **Step 2 -- Dart source cleanup:**
    Delete `bindings/dart/lib/src/database_relations.dart` entirely.
    Edit `bindings/dart/lib/src/database.dart`: Remove the `part 'database_relations.dart';` directive (around line 18).

    **Step 3 -- Delete binding test files:**
    Delete `bindings/julia/test/test_database_relations.jl` entirely.
    Delete `bindings/dart/test/database_relations_test.dart` entirely.

    Also check if the Julia test runner includes `test_database_relations.jl` and remove the include. Check if the Dart test runner or `pubspec.yaml` references the relation test file and remove if needed.

    **Step 4 -- Regenerate FFI bindings:**
    Run `bindings/julia/generator/generator.bat` to regenerate `bindings/julia/src/c_api.jl` from the updated C headers.
    Run `bindings/dart/generator/generator.bat` to regenerate `bindings/dart/lib/src/ffi/bindings.dart` from the updated C headers.

    **Step 5 -- Verify no stale references:**
    After regeneration, verify neither `c_api.jl` nor `bindings.dart` contains `update_scalar_relation` or `read_scalar_relation`.
  </action>
  <verify>
    Run: `grep -r "update_scalar_relation\|read_scalar_relation" bindings/ --include="*.jl" --include="*.dart"` -- should return nothing.
    Run: `bindings/julia/test/test.bat` -- Julia tests pass.
    Run: `bindings/dart/test/test.bat` -- Dart tests pass.
  </verify>
  <done>
    Both relation methods are removed from Julia and Dart bindings. FFI bindings are regenerated clean. Binding test files are deleted. Julia and Dart test suites pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean CLAUDE.md and run full build-all validation</name>
  <files>
    CLAUDE.md
  </files>
  <action>
    **Step 1 -- CLAUDE.md cleanup:**
    Edit `CLAUDE.md` to remove ALL references to `update_scalar_relation` and `read_scalar_relation`. Specific locations identified by research:

    1. **Architecture > Source file list:** Remove `database_relations.cpp  # Relation operations` from both the `src/` and `src/c/` listings.
    2. **Architecture > C API files list:** Remove `database_relations.cpp` entries.
    3. **Test Organization:** Remove `- \`test_database_relations.cpp\` - relation operations` line.
    4. **Naming Convention examples:** If `update_scalar_relation` appears as a naming example, remove it.
    5. **Error Handling examples:** Remove `"Cannot update_scalar_relation: attribute 'x' is not a foreign key in collection 'Y'"` example.
    6. **Core API > Database Class:** Remove the `- Relations: \`update_scalar_relation()\`, \`read_scalar_relation()\`` line.
    7. **Cross-Layer Naming table:** Remove the entire `Relations` row that shows `update_scalar_relation()` across all 5 binding columns.
    8. Any other references found by searching the file.

    Do NOT remove references to `relations.sql` schema file (it is kept for FK resolution tests).

    **Step 2 -- Full validation:**
    Run `scripts/build-all.bat` to validate all layers build and test green: C++ core, C API, Julia, and Dart.

    **Step 3 -- Final sweep:**
    Run: `grep -r "update_scalar_relation\|read_scalar_relation" . --include="*.cpp" --include="*.h" --include="*.jl" --include="*.dart" --include="*.lua" --include="*.md" --exclude-dir=.planning` to confirm zero remaining references outside the planning directory.
  </action>
  <verify>
    Run: `scripts/build-all.bat` -- all builds and all test suites pass (C++, C API, Julia, Dart).
    Run: `grep -r "update_scalar_relation\|read_scalar_relation" . --include="*.cpp" --include="*.h" --include="*.jl" --include="*.dart" --include="*.md" --exclude-dir=.planning --exclude-dir=.git` -- returns nothing.
  </verify>
  <done>
    CLAUDE.md is clean of all relation method references. `scripts/build-all.bat` passes green across all 4 layers (C++ core, C API, Julia, Dart). No stale references exist anywhere in the codebase outside `.planning/`.
  </done>
</task>

</tasks>

<verification>
1. `scripts/build-all.bat` passes -- all builds succeed, all test suites pass
2. `grep -r "update_scalar_relation\|read_scalar_relation"` across entire codebase (excluding `.planning/`) returns empty
3. No deleted files remain on disk: `database_relations.dart`, `test_database_relations.jl`, `database_relations_test.dart`
4. FFI files `c_api.jl` and `bindings.dart` are freshly generated and clean
</verification>

<success_criteria>
- Zero references to relation methods in any binding source, test, or documentation file
- FFI bindings regenerated from clean C headers
- Julia and Dart test suites pass
- `scripts/build-all.bat` green across all layers
- CLAUDE.md accurately reflects the post-removal API surface
</success_criteria>

<output>
After completion, create `.planning/phases/04-cleanup/04-02-SUMMARY.md`
</output>
