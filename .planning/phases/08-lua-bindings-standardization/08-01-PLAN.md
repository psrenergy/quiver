---
phase: 08-lua-bindings-standardization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lua_runner.cpp
  - tests/test_lua_runner.cpp
  - tests/test_c_api_lua_runner.cpp
autonomous: true
must_haves:
  truths:
    - "Every Lua binding method name that maps to a C++ method uses the same name as that C++ method"
    - "All Lua errors originate from C++ exceptions flowing through sol2 -- no custom error messages crafted in Lua binding code"
    - "Lua scripting tests pass through LuaRunner (both C++ and C API test suites)"
  artifacts:
    - path: "src/lua_runner.cpp"
      provides: "Lua binding registrations with correct method names"
      contains: '"delete_element"'
    - path: "tests/test_lua_runner.cpp"
      provides: "Lua scripting tests using correct method names"
      contains: 'db:delete_element('
    - path: "tests/test_c_api_lua_runner.cpp"
      provides: "C API Lua runner tests using correct method names"
      contains: 'db:delete_element('
  key_links:
    - from: "src/lua_runner.cpp"
      to: "include/quiver/database.h"
      via: "sol2 binding string matches C++ method name"
      pattern: '"delete_element"'
---

<objective>
Rename the single mismatched Lua binding (`delete_element_by_id` -> `delete_element`) and update all test scripts that reference it. Verify error handling is already correct (sol2 pcall/error pattern surfaces C++ exceptions).

Purpose: Align the last remaining Lua binding name mismatch with the C++ method name established in Phase 3, completing NAME-05 and ERRH-05.
Output: Updated src/lua_runner.cpp and test files with consistent naming; all Lua tests passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-lua-bindings-standardization/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename delete_element_by_id to delete_element in Lua bindings and tests</name>
  <files>
    src/lua_runner.cpp
    tests/test_lua_runner.cpp
    tests/test_c_api_lua_runner.cpp
  </files>
  <action>
    In `src/lua_runner.cpp`, line 112: Change the Lua binding string from `"delete_element_by_id"` to `"delete_element"`. The lambda body already calls `self.delete_element(collection, id)` -- only the string name needs to change.

    In `tests/test_lua_runner.cpp`, update all 5 Lua script strings that call `db:delete_element_by_id(` to call `db:delete_element(` instead. These are at lines 431, 456, 479, 497, and 921.

    In `tests/test_c_api_lua_runner.cpp`, update line 283: Change `db:delete_element_by_id("Collection", 1)` to `db:delete_element("Collection", 1)`.

    Do NOT modify anything else. Do NOT remove the 3 Lua-only composite methods (`read_all_scalars_by_id`, `read_all_vectors_by_id`, `read_all_sets_by_id`) -- they are useful and intentionally kept. Do NOT bind `export_csv`/`import_csv` (empty stubs, out of scope). Do NOT change the "Lua error: " prefix in `LuaRunner::run()` -- it is correct.

    Error handling verification (no code changes needed): Confirm that `LuaRunner::run()` at line 1119-1125 uses `safe_script` (which internally uses `lua_pcall`) and throws `std::runtime_error("Lua error: " + err.what())`. This satisfies ERRH-05 because sol2's safe_script IS the pcall/error pattern, and C++ exception messages are preserved intact. No custom error messages are crafted in the binding code.
  </action>
  <verify>
    Build and run tests:
    ```
    cmake --build build --config Debug
    ./build/bin/quiver_tests.exe --gtest_filter="LuaRunner*"
    ./build/bin/quiver_c_tests.exe --gtest_filter="*LuaRunner*"
    ```
    All Lua-related tests pass. No "attempt to call nil" errors (which would indicate a name mismatch).

    Grep verification:
    - `grep "delete_element_by_id" src/lua_runner.cpp` returns nothing
    - `grep "delete_element_by_id" tests/test_lua_runner.cpp` returns nothing
    - `grep "delete_element_by_id" tests/test_c_api_lua_runner.cpp` returns nothing
  </verify>
  <done>
    The Lua binding string `"delete_element_by_id"` has been renamed to `"delete_element"` in src/lua_runner.cpp. All 6 test script references across 2 test files have been updated. All Lua-related tests pass. No instances of `delete_element_by_id` remain in any Lua-related source or test file.
  </done>
</task>

</tasks>

<verification>
Phase-level verification:

1. **NAME-05 (naming):** Run `grep -r "delete_element_by_id" src/lua_runner.cpp tests/test_lua_runner.cpp tests/test_c_api_lua_runner.cpp` -- should return nothing. Every Lua binding string in `src/lua_runner.cpp` matches the corresponding C++ method name on `Database`.

2. **ERRH-05 (error handling):** Verify `LuaRunner::run()` uses `safe_script` + `sol::error` + `std::runtime_error("Lua error: ...")`. No `error()` calls or custom error strings exist in the binding lambdas.

3. **Lua-only composites preserved:** `read_all_scalars_by_id`, `read_all_vectors_by_id`, `read_all_sets_by_id` still exist in `src/lua_runner.cpp`.

4. **All tests pass:**
   - `./build/bin/quiver_tests.exe --gtest_filter="LuaRunner*"` green
   - `./build/bin/quiver_c_tests.exe --gtest_filter="*LuaRunner*"` green
</verification>

<success_criteria>
- Every Lua binding method name that maps to a C++ method uses the exact same name
- All errors originate from C++ and flow through sol2 -- no custom Lua-side error messages
- The 3 Lua-only composite methods are preserved
- All Lua scripting tests pass (both C++ LuaRunner tests and C API LuaRunner tests)
</success_criteria>

<output>
After completion, create `.planning/phases/08-lua-bindings-standardization/08-01-SUMMARY.md`
</output>
